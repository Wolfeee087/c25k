<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Limitly Dashboard v2.0</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            color: #e2e8f0;
            line-height: 1.5;
        }

        /* AUTH SCREENS */
        .auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        .auth-box {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
        }
        .auth-logo { text-align: center; font-size: 48px; margin-bottom: 16px; }
        .auth-title { text-align: center; font-size: 22px; font-weight: 600; margin-bottom: 8px; }
        .auth-subtitle { text-align: center; color: #64748b; margin-bottom: 28px; font-size: 14px; }
        .auth-input {
            width: 100%;
            padding: 14px 16px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: white;
            font-size: 15px;
            margin-bottom: 14px;
            transition: border-color 0.2s, background 0.2s;
        }
        .auth-input:focus { outline: none; border-color: #6366f1; background: rgba(51, 65, 85, 0.8); }
        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .auth-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .auth-btn.secondary { background: rgba(71, 85, 105, 0.8); margin-top: 12px; }
        .auth-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 13px;
        }
        .auth-error.hidden { display: none; }
        .auth-link {
            text-align: center;
            margin-top: 20px;
            font-size: 13px;
            color: #94a3b8;
        }
        .auth-link a {
            color: #818cf8;
            text-decoration: none;
            cursor: pointer;
        }
        .auth-link a:hover { text-decoration: underline; }
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .role-owner { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .role-admin { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
        .role-partner { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .role-worker { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }

        /* MAIN DASHBOARD */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            padding: 14px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }
        .header h1 { font-size: 20px; font-weight: 700; }
        .header-right { display: flex; gap: 12px; align-items: center; }
        .stat-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .stat-badge:hover { background: rgba(255,255,255,0.3); }
        .stat-badge.has-alerts { background: #ef4444; animation: pulse 2s infinite; }
        .stat-badge.push-update { background: #8b5cf6; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 20px;
        }
        .user-email { font-size: 12px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* CONNECTION STATUS */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 20px;
        }
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .connection-dot.online { background: #22c55e; animation: pulse 2s infinite; }
        .connection-dot.offline { background: #ef4444; }

        /* LOCKOUT BOX */
        .lockout-box {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
            color: #1e293b;
        }
        .lockout-box.permanent {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
        }
        .lockout-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .lockout-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 16px;
        }
        .reset-code-display {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            margin-top: 12px;
        }
        .reset-code-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        .reset-code {
            font-family: monospace;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 4px;
            background: rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
        }
        .reset-code-hint {
            font-size: 12px;
            margin-top: 10px;
            opacity: 0.8;
        }

        .main-container { display: flex; height: calc(100vh - 60px); }
        .sidebar {
            width: 280px;
            background: #1e293b;
            border-right: 1px solid #334155;
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 16px;
            font-weight: 600;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .device-item {
            padding: 14px 16px;
            border-bottom: 1px solid #334155;
            cursor: pointer;
            transition: background 0.2s;
        }
        .device-item:hover { background: #334155; }
        .device-item.selected { background: #3b82f6; }
        .device-name { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .device-info { font-size: 11px; color: #94a3b8; margin-top: 4px; }
        .device-update-status { font-size: 10px; margin-top: 4px; padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .device-update-pending { background: #f59e0b; color: black; }
        .device-update-overdue { background: #ef4444; color: white; animation: pulse 1s infinite; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-offline { background: #ef4444; }
        .status-uninstalled { background: #6b7280; }
        .device-uninstalled { background: #1e293b; border: 1px dashed #475569; }
        .content { flex: 1; overflow-y: auto; padding: 20px; }
        .no-device-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }
        .no-device-selected span { font-size: 64px; margin-bottom: 16px; }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            background: rgba(30, 41, 59, 0.6);
            padding: 5px;
            border-radius: 14px;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .tab-btn {
            flex: 1;
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: #94a3b8;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: all 0.2s;
        }
        .tab-btn.active { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .tab-btn:hover:not(.active) { background: rgba(51, 65, 85, 0.5); color: #e2e8f0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Device Header */
        .device-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.25);
        }
        .device-title { font-size: 20px; font-weight: 600; }
        .device-meta { font-size: 12px; opacity: 0.85; margin-top: 4px; }
        .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            padding: 9px 16px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            font-size: 12px;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
        
        /* Quick Stats Grid */
        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        .quick-stat {
            background: #1e293b;
            padding: 14px 10px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(51, 65, 85, 0.5);
            transition: border-color 0.2s, transform 0.2s;
        }
        .quick-stat:hover { transform: translateY(-2px); }
        .quick-stat-value { font-size: 22px; font-weight: 600; color: #f1f5f9; }
        .quick-stat-label { font-size: 9px; color: #94a3b8; margin-top: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
        .quick-stat.online { border-color: rgba(34, 197, 94, 0.5); background: rgba(34, 197, 94, 0.1); }
        .quick-stat.offline { border-color: rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.1); }
        .quick-stat.warning { border-color: rgba(245, 158, 11, 0.5); background: rgba(245, 158, 11, 0.1); }
        
        /* Status Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }
        .status-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .status-value { font-size: 22px; font-weight: 600; color: #f1f5f9; }
        .status-label { font-size: 10px; color: #94a3b8; margin-top: 4px; }
        
        /* Update Deadline Banner - NEW */
        .update-banner {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .update-banner.pending {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .update-banner.overdue {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1.5s infinite;
        }
        .update-banner-text { font-weight: 600; }
        .update-banner-time { font-size: 24px; font-weight: 700; }
        .update-banner-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .update-banner-btn:hover { background: rgba(255,255,255,0.3); }
        
        /* Connection Status Indicator - NEW */
        .connection-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }
        .connection-indicator.online {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .connection-indicator.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        /* Blocked Attempts - NEW */
        .blocked-attempt {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            background: rgba(239, 68, 68, 0.05);
            transition: background 0.2s;
        }
        .blocked-attempt:hover { background: rgba(239, 68, 68, 0.1); }
        .blocked-attempt-icon { font-size: 18px; margin-right: 12px; }
        .blocked-attempt-text { flex: 1; }
        .blocked-attempt-action { font-weight: 500; font-size: 13px; }
        .blocked-attempt-time { font-size: 11px; color: #64748b; }
        
        /* Cards */
        .card {
            background: #1e293b;
            border-radius: 14px;
            margin-bottom: 12px;
            border: 1px solid rgba(51, 65, 85, 0.5);
            overflow: hidden;
        }
        .card-header {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .card-header:hover { background: rgba(255,255,255,0.03); }
        .card-title { font-weight: 500; font-size: 14px; }
        .card-content { padding: 12px 16px; }
        .card-content.collapsed { display: none; }
        
        /* Toggle */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.4);
        }
        .toggle-row:last-child { border-bottom: none; }
        .toggle-label { font-size: 13px; color: #cbd5e1; }
        .toggle, .toggle-switch { 
            position: relative; 
            display: inline-block; 
            width: 44px; 
            height: 24px; 
            flex-shrink: 0;
            min-width: 44px;
            max-width: 44px;
        }
        .toggle input, .toggle-switch input { 
            opacity: 0; 
            width: 0; 
            height: 0; 
            position: absolute;
            pointer-events: none;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; 
            left: 0; 
            width: 44px;
            height: 24px;
            background: rgba(71, 85, 105, 0.8);
            border-radius: 24px;
            transition: 0.3s;
        }
        .toggle-slider:before {
            content: "";
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle input:checked + .toggle-slider, .toggle-switch input:checked + .toggle-slider { background: #22c55e; }
        .toggle input:checked + .toggle-slider:before, .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        /* Presets */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .preset-btn {
            padding: 14px;
            border: 2px solid #334155;
            border-radius: 12px;
            background: transparent;
            color: #e2e8f0;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .preset-btn:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); }
        .preset-icon { font-size: 24px; margin-bottom: 6px; }
        .preset-name { font-weight: 600; font-size: 12px; }

        /* Apps Tab */
        .app-category { margin-bottom: 12px; }
        .app-category-header {
            padding: 12px 16px;
            background: #334155;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .app-category-header:hover { background: #3b4a5c; }
        .app-list { padding: 8px 0; display: none; }
        .app-list.expanded { display: block; }
        .app-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid #334155;
        }
        .app-name { font-size: 13px; }
        .app-package { font-size: 10px; color: #64748b; }

        /* Config Tab */
        .config-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #334155;
        }
        .config-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; }
        .config-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        .config-label { font-size: 13px; color: #94a3b8; }
        .config-value { font-size: 13px; font-weight: 600; }
        .config-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        .config-btn:hover { opacity: 0.9; }
        .config-btn.danger { background: #ef4444; }

        /* Log Tab */
        .log-entry {
            padding: 10px 12px;
            border-bottom: 1px solid #334155;
            font-size: 12px;
        }
        .log-time { color: #64748b; font-size: 10px; }
        .log-action { margin-top: 4px; }
        .log-source { 
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 9px;
            margin-left: 8px;
        }
        .log-remote { background: #3b82f6; color: white; }
        .log-local { background: #22c55e; color: white; }
        .log-system { background: #f59e0b; color: white; }
        .log-blocked { background: #ef4444; color: white; }

        /* Screenshot Section */
        .screenshot-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .screenshot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .screenshot-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .screenshot-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .screenshot-btn:hover { opacity: 0.9; transform: scale(1.02); }
        .screenshot-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .screenshot-btn.capturing { background: #f59e0b; }
        .screenshot-container {
            background: #0f172a;
            border-radius: 8px;
            min-height: 100px;
            max-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .screenshot-placeholder {
            text-align: center;
            color: #64748b;
        }
        .screenshot-placeholder-icon { font-size: 32px; margin-bottom: 4px; }
        .screenshot-placeholder-text { font-size: 12px; }
        .screenshot-placeholder.hidden { display: none; }
        .screenshot-buttons { display: flex; gap: 8px; }
        .screenshot-clear-btn {
            background: #334155;
            border: none;
            color: #94a3b8;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .screenshot-clear-btn:hover { background: #475569; color: white; }
        .screenshot-clear-btn.hidden { display: none; }
        .screenshot-image {
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .screenshot-image:hover { transform: scale(1.02); }
        .screenshot-image.hidden { display: none; }
        .screenshot-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 12px;
            color: #64748b;
        }
        .screenshot-status { display: flex; align-items: center; gap: 6px; }
        .screenshot-status.capturing { color: #f59e0b; }
        .screenshot-status.success { color: #22c55e; }
        .screenshot-status.error { color: #ef4444; }
        .screenshot-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f59e0b;
            border-top-color: transparent;
            border-radius: 50%;
            animation: screenshot-spin 1s linear infinite;
        }
        @keyframes screenshot-spin { to { transform: rotate(360deg); } }
        .screenshot-fullscreen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            cursor: zoom-out;
        }
        .screenshot-fullscreen.hidden { display: none; }
        .screenshot-fullscreen img { max-width: 95%; max-height: 95%; object-fit: contain; }
        .screenshot-fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
        }

        /* Device Actions Section */
        .device-actions-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .device-actions-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .device-actions-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .action-btn {
            border: none;
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .action-btn:hover { opacity: 0.9; transform: scale(1.02); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .ping-btn {
            background: linear-gradient(135deg, #f97316, #ea580c);
        }
        .ping-btn.pinging {
            background: linear-gradient(135deg, #eab308, #ca8a04);
        }
        .reconnect-btn {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
        }
        .reconnect-btn.reconnecting {
            background: linear-gradient(135deg, #eab308, #ca8a04);
        }
        .ping-status {
            margin-top: 10px;
            font-size: 12px;
            color: #94a3b8;
            min-height: 18px;
        }
        .ping-status.success { color: #22c55e; }
        .ping-status.error { color: #ef4444; }
        .ping-status.waiting { color: #f59e0b; }
        .temp-disable-btn {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }
        .temp-disable-btn:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
        }
        .temp-enable-btn {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }
        .temp-enable-btn:hover {
            background: linear-gradient(135deg, #15803d, #166534);
        }
        .temp-status {
            margin-top: 8px;
            font-size: 12px;
            min-height: 18px;
        }
        .temp-status.disabled {
            color: #ef4444;
            font-weight: 600;
        }
        .temp-status.enabled {
            color: #22c55e;
        }

        /* Temp Disable Modal */
        .temp-disable-modal .modal {
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .temp-disable-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            max-height: 350px;
            overflow-y: auto;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        @media (max-width: 600px) {
            .temp-disable-grid {
                grid-template-columns: 1fr;
            }
        }
        .temp-disable-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: #1e293b;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .temp-disable-item:hover {
            background: #334155;
        }
        .temp-disable-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            accent-color: #22c55e;
        }
        .temp-disable-item label {
            font-size: 13px;
            cursor: pointer;
            flex: 1;
        }
        .temp-disable-item.blocked label {
            color: #f87171;
        }
        .temp-disable-item.allowed label {
            color: #4ade80;
        }
        .time-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .time-btn {
            padding: 10px 16px;
            background: #334155;
            border: 2px solid transparent;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .time-btn:hover {
            background: #475569;
        }
        .time-btn.selected {
            border-color: #3b82f6;
            background: #1e3a5f;
        }
        .custom-time-input {
            display: none;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .custom-time-input.visible {
            display: flex;
        }
        .custom-time-input input {
            width: 80px;
            padding: 8px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }
        .temp-disable-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .temp-disable-actions button {
            padding: 6px 12px;
            font-size: 12px;
            background: #475569;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }
        .temp-disable-actions button:hover {
            background: #64748b;
        }
        .temp-countdown {
            text-align: center;
            padding: 12px;
            background: #1e293b;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .temp-countdown.active {
            background: linear-gradient(135deg, #7c2d12, #991b1b);
            animation: pulse-warning 2s infinite;
        }
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .temp-countdown-time {
            font-size: 24px;
            font-weight: 700;
            color: #f59e0b;
        }
        .temp-countdown-label {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* Modal - Ultra Simple */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-overlay.hidden { display: none !important; }
        .modal {
            background-color: #1e293b;
            border-radius: 12px;
            padding: 24px;
            min-width: 400px;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            border: 2px solid #475569;
        }
        .modal-title { font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #f1f5f9; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; justify-content: flex-end; }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; font-size: 12px; color: #94a3b8; margin-bottom: 6px; font-weight: 500; }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px 14px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: white;
            font-size: 14px;
            transition: border-color 0.2s, background 0.2s;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: #6366f1;
            background: rgba(51, 65, 85, 0.8);
        }
        
        /* Checkbox group */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #6366f1;
        }
        .checkbox-group label {
            font-size: 13px;
            cursor: pointer;
            color: #cbd5e1;
        }
        
        /* Bulk Actions */
        .bulk-actions-bar {
            background: rgba(51, 65, 85, 0.5);
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        .bulk-select-all {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .bulk-buttons { display: flex; gap: 8px; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 500;
            font-size: 14px;
            z-index: 2000;
            display: none;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
        }
        .toast.show { display: block; animation: slideIn 0.3s ease; }
        .toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3); }
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .btn-sm { padding: 4px 10px; font-size: 10px; border-radius: 6px; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .main-container { flex-direction: column; }
            .sidebar { width: 100%; height: auto; max-height: 200px; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .quick-stats-grid { grid-template-columns: repeat(3, 1fr); }
            .preset-grid { grid-template-columns: repeat(2, 1fr); }
            .device-header { flex-direction: column; text-align: center; }
        }

        /* ==================== SUPPORT TICKETS STYLES ==================== */
        .support-badge {
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
            cursor: pointer;
            position: relative;
        }
        .support-badge .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        .ticket-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .ticket-item {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ticket-item:hover {
            border-color: #6366f1;
            background: #1e293b;
        }
        .ticket-item.unread {
            border-left: 4px solid #6366f1;
        }
        .ticket-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .ticket-title {
            font-weight: 600;
            font-size: 14px;
            color: #f1f5f9;
            flex: 1;
        }
        .ticket-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-left: 8px;
            white-space: nowrap;
        }
        .ticket-status.pending { background: #f59e0b; color: #1e293b; }
        .ticket-status.in-progress { background: #3b82f6; color: white; }
        .ticket-status.resolved { background: #22c55e; color: white; }
        .ticket-status.rejected { background: #ef4444; color: white; }
        .ticket-meta {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
        }
        .ticket-device {
            font-size: 11px;
            color: #94a3b8;
            background: #334155;
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-left: 8px;
        }
        .ticket-type-badge {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 6px;
            font-weight: 600;
        }
        .ticket-type-badge.app_request { background: #6366f1; color: white; }
        .ticket-type-badge.problem_report { background: #f59e0b; color: black; }
        .ticket-type-badge.diagnostics { background: #ef4444; color: white; }
        .ticket-description {
            font-size: 13px;
            color: #94a3b8;
            margin-top: 8px;
            line-height: 1.4;
        }
        .ticket-detail-section {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .ticket-detail-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .ticket-detail-value {
            font-size: 14px;
            color: #e2e8f0;
        }
        .diagnostics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .diagnostics-item {
            background: #1e293b;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #334155;
        }
        .diagnostics-item-label {
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
        }
        .diagnostics-item-value {
            font-size: 13px;
            color: #f1f5f9;
            font-weight: 500;
        }
        /* Enhanced Diagnostics v3 Styles */
        .diag-health-box {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .diag-health-ok { background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; }
        .diag-health-warning { background: rgba(234, 179, 8, 0.15); border: 1px solid #eab308; }
        .diag-health-critical { background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; }
        .diag-health-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .diag-health-ok .diag-health-title { color: #22c55e; }
        .diag-health-warning .diag-health-title { color: #eab308; }
        .diag-health-critical .diag-health-title { color: #ef4444; }
        .diag-issue {
            font-size: 12px;
            padding: 4px 0;
            color: #f1f5f9;
        }
        .diag-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .diag-section-header {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #0f172a;
            font-weight: 500;
            font-size: 13px;
            color: #e2e8f0;
        }
        .diag-section-header:hover {
            background: #1e293b;
        }
        .diag-section-content {
            padding: 12px;
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }
        .diag-section.expanded .diag-section-content {
            display: block;
        }
        .diag-section-header .arrow {
            transition: transform 0.2s;
        }
        .diag-section.expanded .diag-section-header .arrow {
            transform: rotate(90deg);
        }
        .diag-logs {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            background: #0a0a0a;
            padding: 8px;
            border-radius: 4px;
            color: #94a3b8;
            max-height: 300px;
            overflow-y: auto;
        }
        .diag-toggle-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
        }
        .diag-toggle {
            font-size: 11px;
            padding: 4px 6px;
            border-radius: 4px;
            background: #334155;
        }
        .diag-toggle.on { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .diag-toggle.off { background: rgba(100, 116, 139, 0.2); color: #64748b; }
        .diag-kv {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
            border-bottom: 1px solid #1e293b;
        }
        .diag-kv:last-child { border-bottom: none; }
        .diag-kv-key { color: #94a3b8; }
        .diag-kv-value { color: #f1f5f9; font-weight: 500; }
        .reply-box {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            border: 1px solid #334155;
        }
        .reply-input {
            width: 100%;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            padding: 10px;
            color: white;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        .reply-input:focus {
            outline: none;
            border-color: #6366f1;
        }
        .ticket-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 12px;
            background: #334155;
            border: none;
            border-radius: 6px;
            color: #94a3b8;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-btn:hover {
            background: #475569;
            color: white;
        }
        .filter-btn.active {
            background: #6366f1;
            color: white;
        }
        .empty-tickets {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        .empty-tickets-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        .existing-reply {
            background: #064e3b;
            border: 1px solid #059669;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }
        .existing-reply-label {
            font-size: 11px;
            color: #34d399;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .existing-reply-text {
            font-size: 14px;
            color: #d1fae5;
        }
        .logs-container {
            background: #0f172a;
            border-radius: 8px;
            padding: 12px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            color: #94a3b8;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* ==================== APK OVERRIDE STYLES ==================== */
        .override-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 480px;
            height: 100vh;
            background: #1e293b;
            border-left: 1px solid #334155;
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -4px 0 20px rgba(0,0,0,0.3);
        }
        .override-panel.open { right: 0; }
        .override-panel-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .override-panel-title { font-size: 18px; font-weight: 700; color: white; }
        .override-panel-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
        }
        .override-panel-close:hover { background: rgba(255,255,255,0.3); }
        .override-panel-content { flex: 1; overflow-y: auto; padding: 16px; }
        .override-panel-footer { padding: 16px; border-top: 1px solid #334155; }
        .override-card {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 12px;
            margin-bottom: 12px;
            overflow: hidden;
        }
        .override-card.disabled { opacity: 0.6; }
        .override-card-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #334155;
        }
        .override-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        .override-card-info { flex: 1; }
        .override-card-name { font-weight: 600; font-size: 14px; color: #f1f5f9; }
        .override-card-package { font-size: 11px; color: #64748b; font-family: monospace; }
        .override-card-status { padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; }
        .override-card-status.enabled { background: #22c55e; color: white; }
        .override-card-status.disabled { background: #64748b; color: white; }
        .override-card-status.expiring { background: #f59e0b; color: black; }
        .override-card-body { padding: 12px 16px; }
        .override-card-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 12px; }
        .override-card-label { color: #64748b; }
        .override-card-value { color: #e2e8f0; font-weight: 500; }
        .override-card-actions { display: flex; gap: 8px; margin-top: 12px; }
        .override-card-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .override-card-btn:hover { opacity: 0.8; }
        .override-card-btn.edit { background: #3b82f6; color: white; }
        .override-card-btn.toggle { background: #475569; color: white; }
        .override-card-btn.delete { background: #ef4444; color: white; }
        .override-card-btn.logs { background: #8b5cf6; color: white; }
        .override-form-group { margin-bottom: 16px; }
        .override-form-label { display: block; font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 6px; }
        .override-form-input {
            width: 100%;
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        .override-form-input:focus { outline: none; border-color: #6366f1; }
        .override-form-input::placeholder { color: #64748b; }
        .override-form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .override-form-help { font-size: 11px; color: #64748b; margin-top: 4px; }
        .override-verify-btn {
            margin-top: 8px;
            padding: 8px 16px;
            background: #22c55e;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .override-verify-btn:disabled { background: #475569; cursor: not-allowed; }
        .override-verify-result { margin-top: 8px; padding: 10px; border-radius: 6px; font-size: 12px; }
        .override-verify-result.success { background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid #22c55e; }
        .override-verify-result.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .override-verify-result.warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; border: 1px solid #f59e0b; }
        .override-warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            margin-top: 16px;
            font-size: 12px;
            color: #fbbf24;
        }
        .override-logs-list { max-height: 400px; overflow-y: auto; }
        .override-log-item { padding: 10px 12px; border-bottom: 1px solid #334155; font-size: 12px; }
        .override-log-item:last-child { border-bottom: none; }
        .override-log-action { font-weight: 600; margin-right: 8px; }
        .override-log-action.success { color: #22c55e; }
        .override-log-action.failed { color: #ef4444; }
        .override-log-action.matched { color: #3b82f6; }
        .override-log-device { color: #94a3b8; }
        .override-log-time { color: #64748b; font-size: 10px; }
        .override-empty { text-align: center; padding: 40px 20px; color: #64748b; }
        .override-empty-icon { font-size: 48px; margin-bottom: 12px; }

        /* Time Request Badge */
        .time-request-badge { position: relative; }
        .time-request-badge .badge-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Bulk Actions Styles */
        .bulk-tab-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: #94a3b8;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.2s;
        }
        .bulk-tab-btn.active { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; }
        .bulk-tab-btn:hover:not(.active) { background: rgba(51, 65, 85, 0.5); color: #e2e8f0; }
        .bulk-tab-content { display: none; }
        .bulk-tab-content.active { display: block; }
        
        .bulk-action-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 16px 12px;
            background: rgba(51, 65, 85, 0.4);
            border: 2px solid transparent;
            border-radius: 12px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
        }
        .bulk-action-type-btn:hover { background: rgba(51, 65, 85, 0.6); color: #e2e8f0; }
        .bulk-action-type-btn.active { 
            border-color: #6366f1; 
            background: rgba(99, 102, 241, 0.15); 
            color: #a5b4fc; 
        }
        
        .bulk-command-btn {
            padding: 12px 16px;
            background: rgba(51, 65, 85, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
            text-align: left;
        }
        .bulk-command-btn:hover { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
        .bulk-command-btn.selected { background: rgba(34, 197, 94, 0.2); border-color: #22c55e; }
        
        .bulk-preset-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: rgba(51, 65, 85, 0.4);
            border: 2px solid transparent;
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            text-align: left;
            transition: all 0.15s;
        }
        .bulk-preset-btn:hover { background: rgba(51, 65, 85, 0.6); }
        .bulk-preset-btn.selected { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.15); }
        
        .bulk-setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .bulk-setting-item:hover { background: rgba(51, 65, 85, 0.5); }
        .bulk-setting-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .bulk-setting-item select {
            padding: 4px 8px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 4px;
            color: white;
            font-size: 12px;
            margin-left: auto;
        }
        
        .bulk-device-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            cursor: pointer;
            transition: background 0.15s;
        }
        .bulk-device-item:hover { background: rgba(99, 102, 241, 0.1); }
        .bulk-device-item.selected { background: rgba(34, 197, 94, 0.15); }
        .bulk-device-item:last-child { border-bottom: none; }
        
        .device-group-card {
            background: rgba(51, 65, 85, 0.4);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
        }
        .device-group-card:hover { border-color: #6366f1; }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .group-name { font-weight: 600; color: #f1f5f9; font-size: 15px; }
        .group-count { font-size: 12px; color: #94a3b8; }
        .group-devices { display: flex; flex-wrap: wrap; gap: 6px; }
        .group-device-tag {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            font-size: 11px;
            color: #a5b4fc;
        }

        /* Screen Time Styles */
        .screen-time-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .screen-time-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .screen-time-title {
            font-size: 16px;
            font-weight: 600;
            color: #f1f5f9;
        }
        .limit-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(51, 65, 85, 0.4);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .limit-item-info { flex: 1; }
        .limit-item-name { font-weight: 500; color: #e2e8f0; font-size: 13px; }
        .limit-item-detail { font-size: 11px; color: #94a3b8; margin-top: 2px; }
        .limit-item-value {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }
        .limit-item-actions { display: flex; gap: 6px; }
        .limit-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .limit-btn:hover { opacity: 0.8; }
        .limit-btn-edit { background: #3b82f6; color: white; }
        .limit-btn-delete { background: #ef4444; color: white; }
        .usage-bar {
            height: 6px;
            background: rgba(51, 65, 85, 0.6);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 6px;
        }
        .usage-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .usage-bar-fill.safe { background: #22c55e; }
        .usage-bar-fill.warning { background: #f59e0b; }
        .usage-bar-fill.danger { background: #ef4444; }
        .downtime-config {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .time-input {
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            width: 100px;
        }
        .time-input:focus { outline: none; border-color: #6366f1; }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
        }

        /* Time Requests Modal */
        .time-request-item {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        .time-request-item:hover { background: rgba(6, 182, 212, 0.15); }
        .time-request-item.approved { border-color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .time-request-item.denied { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); opacity: 0.7; }
        .time-request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .time-request-app { font-weight: 600; font-size: 15px; color: #f1f5f9; }
        .time-request-device { font-size: 12px; color: #94a3b8; }
        .time-request-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .time-request-badge.pending { background: #f59e0b; color: black; }
        .time-request-badge.approved { background: #22c55e; color: white; }
        .time-request-badge.denied { background: #ef4444; color: white; }
        .time-request-details { font-size: 13px; color: #cbd5e1; margin-bottom: 10px; }
        .time-request-reason {
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 10px;
            font-style: italic;
        }
        .time-request-actions { display: flex; gap: 8px; }
        .empty-requests {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        .empty-requests-icon { font-size: 48px; margin-bottom: 12px; }

        /* App Limit List Styles */
        .app-limit-item.selected {
            background: rgba(34, 197, 94, 0.15) !important;
            border-left: 3px solid #22c55e;
        }
        .app-category-header {
            position: sticky;
            top: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div class="auth-screen" id="auth-screen">
        <div class="auth-box" id="login-box">
            <div class="auth-logo"></div>
            <div class="auth-title">Limitly</div>
            <div class="auth-subtitle">Dashboard Login</div>
            <div class="auth-error hidden" id="login-error"></div>
            <input type="email" class="auth-input" id="login-email" placeholder="Email address" autocomplete="off">
            <input type="password" class="auth-input" id="login-password" placeholder="Password" autocomplete="off">
            <button class="auth-btn" onclick="login()" id="login-btn">Login</button>
            <div class="auth-link">
                <a onclick="showForgotPassword()">Forgot password?</a>
            </div>
        </div>

        <!-- FORGOT PASSWORD -->
        <div class="auth-box hidden" id="forgot-box">
            <div class="auth-logo"></div>
            <div class="auth-title">Reset Password</div>
            <div class="auth-subtitle">Enter your email to receive a reset link</div>
            <div class="auth-error hidden" id="forgot-error"></div>
            <input type="email" class="auth-input" id="forgot-email" placeholder="Email address">
            <button class="auth-btn" onclick="sendPasswordReset()">Send Reset Link</button>
            <div class="auth-link">
                <a onclick="showLogin()"> Back to login</a>
            </div>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <div class="dashboard" id="dashboard">
        <header class="header">
            <h1> Limitly Dashboard v1.9</h1>
            <div class="header-right">
                <span class="stat-badge" id="total-devices" onclick="showAllDevices()">0 Devices</span>
                <span class="stat-badge" id="online-count">0 Online</span>
                <span class="stat-badge" id="alerts-count" onclick="showDeviceWithAlerts()">0 Alerts</span>
                <span class="stat-badge push-update" onclick="openModal('push-update-modal')"> Push Update</span>
                <span class="stat-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); cursor: pointer;" onclick="openBulkActionsModal()"> Bulk Actions</span>
                <span class="stat-badge support-badge" onclick="openSupportTickets()"> Support<span class="badge-count hidden" id="support-ticket-count">0</span></span>
                <span class="stat-badge time-request-badge" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);" onclick="openTimeRequests()"> Time Requests<span class="badge-count hidden" id="time-request-count">0</span></span>
                <span class="stat-badge" style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); cursor: pointer;" onclick="openOverridePanel()"> APK Fixes</span>
                <span class="stat-badge" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); cursor: pointer;" onclick="openPinsPanel()"> PINs</span>
                <span class="stat-badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); cursor: pointer;" id="partners-btn" onclick="openPartnersPanel()"> Partners</span>
                <div class="connection-status">
                    <div class="connection-dot" id="firebase-status"></div>
                    <span id="firebase-status-text">Connecting...</span>
                </div>
                <div class="user-info">
                    <span class="user-email" id="user-email"></span>
                    <span class="role-badge role-owner" id="user-role">Owner</span>
                </div>
                <button class="logout-btn" onclick="logout()"> Logout</button>
            </div>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                     Your Devices
                    <button onclick="refreshDevices()" style="background: #3b82f6; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;"></button>
                </div>
                <div id="device-list"><div style="padding: 20px; text-align: center; color: #64748b;">Loading...</div></div>
            </aside>
            <main class="content" id="main-content">
                <div class="no-device-selected">
                    <span></span>
                    <h2>Select a device</h2>
                    <p>Choose a device from the list to manage it</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- APK Overrides Panel (slides in from right) -->
    <div class="override-panel" id="override-panel">
        <div class="override-panel-header">
            <span class="override-panel-title"> APK Compatibility Fixes</span>
            <button class="override-panel-close" onclick="closeOverridePanel()"></button>
        </div>
        <div style="padding: 12px 16px; background: #0f172a; border-bottom: 1px solid #334155; font-size: 12px; color: #94a3b8;">
            When users report "app not downloading", find a working APK and add it here for their device type.
        </div>
        <div class="override-panel-content" id="override-list">
            <div class="override-empty">
                <div class="override-empty-icon"></div>
                <div>Loading...</div>
            </div>
        </div>
        <div class="override-panel-footer">
            <button class="btn btn-success" style="width: 100%;" onclick="openAddOverrideModal()">
                 Add Compatibility Fix
            </button>
        </div>
    </div>

    <!-- Add/Edit Override Modal -->
    <div class="modal-overlay hidden" id="override-modal">
        <div class="modal" style="max-width: 550px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-title" id="override-modal-title"> Add APK Compatibility Fix</div>
            
            <div class="override-form-group">
                <label class="override-form-label">App Package Name *</label>
                <input type="text" class="override-form-input" id="override-package" placeholder="com.openai.chatgpt">
                <div class="override-form-help">The package name of the app (e.g., com.whatsapp)</div>
            </div>
            
            <div class="override-form-group">
                <label class="override-form-label">App Name *</label>
                <input type="text" class="override-form-input" id="override-appname" placeholder="ChatGPT">
            </div>
            
            <div class="override-form-group">
                <label class="override-form-label">Target Devices</label>
                <div class="override-form-row">
                    <div>
                        <label class="override-form-label" style="font-size: 11px;">Min API Level</label>
                        <input type="number" class="override-form-input" id="override-minapi" placeholder="21" min="21" max="35">
                    </div>
                    <div>
                        <label class="override-form-label" style="font-size: 11px;">Max API Level</label>
                        <input type="number" class="override-form-input" id="override-maxapi" placeholder="30" min="21" max="35">
                    </div>
                </div>
                <div class="override-form-help">Leave empty to match all API levels</div>
            </div>
            
            <div class="override-form-group">
                <label class="override-form-label">Device Models (comma-separated)</label>
                <input type="text" class="override-form-input" id="override-models" placeholder="F21 Pro, Qin F22">
                <div class="override-form-help">Match specific device models (optional)</div>
            </div>
            
            <div class="override-form-group">
                <label class="override-form-label">Manufacturers (comma-separated)</label>
                <input type="text" class="override-form-input" id="override-manufacturers" placeholder="DuoQin, Xiaomi">
                <div class="override-form-help">Match specific manufacturers (optional)</div>
            </div>
            
            <hr style="border-color: #334155; margin: 20px 0;">
            
            <div class="override-form-group">
                <label class="override-form-label">APK Download URL *</label>
                <input type="text" class="override-form-input" id="override-url" placeholder="https://apkmirror.com/...">
                <button class="override-verify-btn" id="override-verify-btn" onclick="verifyOverrideUrl()"> Verify URL</button>
                <div id="override-verify-result"></div>
            </div>
            
            <div class="override-form-row">
                <div class="override-form-group">
                    <label class="override-form-label">Version Label *</label>
                    <input type="text" class="override-form-input" id="override-version" placeholder="1.2024.052">
                </div>
                <div class="override-form-group">
                    <label class="override-form-label">Format</label>
                    <select class="override-form-input" id="override-format">
                        <option value="APK">APK</option>
                        <option value="XAPK">XAPK</option>
                    </select>
                </div>
            </div>
            
            <div class="override-form-group">
                <label class="override-form-label">Expected File Size (bytes)</label>
                <input type="number" class="override-form-input" id="override-size" placeholder="52428800">
                <div class="override-form-help">Auto-filled when you verify the URL</div>
            </div>
            
            <div class="override-form-group">
                <label class="override-form-label">Admin Notes</label>
                <textarea class="override-form-input" id="override-notes" rows="2" placeholder="Older version for Qin phones..."></textarea>
            </div>
            
            <div class="override-warning-box">
                 <strong>Warning:</strong> Make sure the APK is from a trusted source and works on the target devices.
            </div>
            
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="btn" onclick="closeModal('override-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-success" onclick="saveOverride()"> Save</button>
            </div>
        </div>
    </div>

    <!-- Override Logs Modal -->
    <div class="modal-overlay hidden" id="override-logs-modal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-title"> Install Logs</div>
            <div id="override-logs-content" class="override-logs-list">Loading...</div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('override-logs-modal')" style="background: #475569;">Close</button>
            </div>
        </div>
    </div>

    <!-- Screenshot Fullscreen Modal -->
    <div class="screenshot-fullscreen hidden" id="screenshot-fullscreen" onclick="closeScreenshotFullscreen()">
        <button class="screenshot-fullscreen-close"></button>
        <img id="screenshot-fullscreen-img">
    </div>

    <!-- MODALS -->
    <!-- Push Update Modal - NEW -->
    <div class="modal-overlay hidden" id="push-update-modal">
        <div class="modal">
            <div class="modal-title"> Push Update to All Devices</div>
            <p style="color: #94a3b8; margin-bottom: 16px;">This will send an update notification to all connected devices. They will have 24 hours to install before being locked out.</p>
            <div id="push-update-device-count" style="font-size: 24px; font-weight: 700; text-align: center; margin: 20px 0;"></div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('push-update-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-purple" onclick="confirmPushUpdate()">Push Update to All</button>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Modal - POWERFUL VERSION -->
    <div class="modal-overlay hidden" id="bulk-actions-modal">
        <div class="modal" style="max-width: 900px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span> Bulk Actions Center</span>
                <span id="bulk-selection-summary" style="font-size: 13px; color: #94a3b8;">0 devices selected</span>
            </div>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 4px; margin-bottom: 16px; background: rgba(51, 65, 85, 0.3); padding: 4px; border-radius: 10px;">
                <button class="bulk-tab-btn active" onclick="switchBulkTab('select')" data-tab="select"> Select Devices</button>
                <button class="bulk-tab-btn" onclick="switchBulkTab('groups')" data-tab="groups"> Groups</button>
                <button class="bulk-tab-btn" onclick="switchBulkTab('actions')" data-tab="actions"> Actions</button>
            </div>
            
            <div style="flex: 1; overflow-y: auto;">
                <!-- SELECT TAB -->
                <div class="bulk-tab-content active" id="bulk-tab-select">
                    <!-- Quick Filters -->
                    <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                        <button class="btn btn-sm" onclick="bulkSelectAll()" style="background: #22c55e;"> All</button>
                        <button class="btn btn-sm" onclick="bulkSelectNone()" style="background: #64748b;"> None</button>
                        <button class="btn btn-sm" onclick="bulkSelectOnline()" style="background: #3b82f6;"> Online Only</button>
                        <button class="btn btn-sm" onclick="bulkSelectOffline()" style="background: #f59e0b;"> Offline Only</button>
                        <button class="btn btn-sm" onclick="bulkInvertSelection()" style="background: #8b5cf6;"> Invert</button>
                    </div>
                    
                    <!-- Group Quick Select -->
                    <div style="margin-bottom: 12px;">
                        <label style="font-size: 12px; color: #94a3b8; margin-bottom: 6px; display: block;">Quick Select by Group:</label>
                        <div id="bulk-group-buttons" style="display: flex; gap: 6px; flex-wrap: wrap;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                    
                    <!-- Search -->
                    <div style="margin-bottom: 12px;">
                        <input type="text" id="bulk-device-search" placeholder=" Search devices..." 
                               style="width: 100%; padding: 10px 14px; background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 8px; color: white;"
                               oninput="filterBulkDevices()">
                    </div>
                    
                    <!-- Device List -->
                    <div id="bulk-device-list" style="max-height: 300px; overflow-y: auto; background: rgba(30, 41, 59, 0.5); border-radius: 10px; border: 1px solid rgba(51, 65, 85, 0.5);">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- GROUPS TAB -->
                <div class="bulk-tab-content" id="bulk-tab-groups" style="display: none;">
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <input type="text" id="new-group-name" placeholder="New group name..." 
                               style="flex: 1; padding: 10px 14px; background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 8px; color: white;">
                        <button class="btn btn-success" onclick="createDeviceGroup()"> Create Group</button>
                    </div>
                    
                    <div id="device-groups-list" style="max-height: 350px; overflow-y: auto;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                
                <!-- ACTIONS TAB -->
                <div class="bulk-tab-content" id="bulk-tab-actions" style="display: none;">
                    <div id="bulk-no-selection" style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 12px;"></div>
                        <div>Select devices first from the "Select Devices" tab</div>
                    </div>
                    
                    <div id="bulk-actions-content" style="display: none;">
                        <!-- Action Type Selection -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
                            <button class="bulk-action-type-btn active" onclick="selectBulkActionType('settings')" data-type="settings">
                                <span style="font-size: 24px;"></span>
                                <span>Change Settings</span>
                            </button>
                            <button class="bulk-action-type-btn" onclick="selectBulkActionType('command')" data-type="command">
                                <span style="font-size: 24px;"></span>
                                <span>Send Command</span>
                            </button>
                            <button class="bulk-action-type-btn" onclick="selectBulkActionType('preset')" data-type="preset">
                                <span style="font-size: 24px;"></span>
                                <span>Apply Preset</span>
                            </button>
                        </div>
                        
                        <!-- SETTINGS PANEL -->
                        <div id="bulk-settings-panel" class="bulk-action-panel">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #e2e8f0;"> Select Settings to Change:</div>
                            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                                <button class="btn btn-sm" onclick="bulkSettingsSelectAll()" style="background: #475569;">Check All</button>
                                <button class="btn btn-sm" onclick="bulkSettingsSelectNone()" style="background: #475569;">Uncheck All</button>
                            </div>
                            <div id="bulk-settings-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 250px; overflow-y: auto;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                        
                        <!-- COMMAND PANEL -->
                        <div id="bulk-command-panel" class="bulk-action-panel" style="display: none;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #e2e8f0;"> Select Command:</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button class="bulk-command-btn" onclick="selectBulkCommand('sync_settings')"> Sync Settings</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('sync_apps')"> Sync App List</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('check_update')"> Check Updates</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('clear_lockout')"> Clear Lockout</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('sync_screen_time')"> Sync Screen Time</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('force_reconnect')"> Force Reconnect</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('ping')"> Ping Device</button>
                                <button class="bulk-command-btn" onclick="selectBulkCommand('reboot')"> Reboot Device</button>
                            </div>
                            <div style="margin-top: 16px;">
                                <div style="font-weight: 600; margin-bottom: 8px; color: #e2e8f0;">Or Custom Command:</div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="bulk-custom-command" placeholder="Command name (e.g., my_command)" 
                                           style="flex: 1; padding: 10px; background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 8px; color: white;">
                                    <button class="btn btn-primary" onclick="selectBulkCommand(document.getElementById('bulk-custom-command').value)">Use</button>
                                </div>
                            </div>
                            <div id="bulk-selected-command" style="margin-top: 12px; padding: 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; display: none;">
                                <strong style="color: #22c55e;">Selected:</strong> <span id="bulk-command-name"></span>
                            </div>
                        </div>
                        
                        <!-- PRESET PANEL -->
                        <div id="bulk-preset-panel" class="bulk-action-panel" style="display: none;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: #e2e8f0;"> Select Preset:</div>
                            <div style="display: grid; gap: 8px;">
                                <button class="bulk-preset-btn" onclick="selectBulkPreset('strict')">
                                    <span style="font-size: 20px;"></span>
                                    <div>
                                        <strong>Strict</strong>
                                        <div style="font-size: 11px; color: #94a3b8;">Maximum protection - blocks everything</div>
                                    </div>
                                </button>
                                <button class="bulk-preset-btn" onclick="selectBulkPreset('recommended')">
                                    <span style="font-size: 20px;"></span>
                                    <div>
                                        <strong>Recommended</strong>
                                        <div style="font-size: 11px; color: #94a3b8;">Balanced - blocks harmful content</div>
                                    </div>
                                </button>
                                <button class="bulk-preset-btn" onclick="selectBulkPreset('light')">
                                    <span style="font-size: 20px;"></span>
                                    <div>
                                        <strong>Light</strong>
                                        <div style="font-size: 11px; color: #94a3b8;">Minimal - basic protection only</div>
                                    </div>
                                </button>
                                <button class="bulk-preset-btn" onclick="selectBulkPreset('off')">
                                    <span style="font-size: 20px;"></span>
                                    <div>
                                        <strong>Off</strong>
                                        <div style="font-size: 11px; color: #94a3b8;">All restrictions disabled</div>
                                    </div>
                                </button>
                            </div>
                            <div id="bulk-selected-preset" style="margin-top: 12px; padding: 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; display: none;">
                                <strong style="color: #a78bfa;">Selected:</strong> <span id="bulk-preset-name"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="padding-top: 16px; border-top: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; margin-top: 16px;">
                <div id="bulk-action-summary" style="font-size: 13px; color: #94a3b8;"></div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="closeModal('bulk-actions-modal')" style="background: #475569;">Close</button>
                    <button class="btn btn-success" id="bulk-apply-btn" onclick="executeBulkAction()" disabled> Apply to Selected</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div class="modal-overlay hidden" id="edit-group-modal" style="z-index: 1100;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-title" id="edit-group-title">Edit Group</div>
            <input type="hidden" id="edit-group-id">
            <div class="input-group">
                <label>Group Name</label>
                <input type="text" id="edit-group-name" placeholder="Group name">
            </div>
            <div class="input-group">
                <label>Devices in this Group</label>
                <div id="edit-group-devices" style="max-height: 250px; overflow-y: auto; background: rgba(51, 65, 85, 0.3); border-radius: 8px; padding: 8px;">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="deleteDeviceGroup()" style="margin-right: auto;"> Delete Group</button>
                <button class="btn" onclick="closeModal('edit-group-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-success" onclick="saveDeviceGroup()"> Save</button>
            </div>
        </div>
    </div>

    <!-- Temp Disable Modal -->
    <div class="modal-overlay hidden temp-disable-modal" id="temp-disable-modal">
        <div class="modal">
            <div class="modal-title"> Temporary Disable Settings</div>
            <p style="color: #94a3b8; margin-bottom: 12px;">Check the settings you want to <strong style="color: #4ade80;">ALLOW</strong> temporarily. Unchecked items will remain <strong style="color: #f87171;">BLOCKED</strong>.</p>
            
            <!-- Countdown display (shows when active) -->
            <div class="temp-countdown hidden" id="temp-countdown-display">
                <div class="temp-countdown-time" id="temp-countdown-time">--:--</div>
                <div class="temp-countdown-label">Time remaining until restrictions restore</div>
            </div>
            
            <!-- Quick actions -->
            <div class="temp-disable-actions">
                <button onclick="tempSelectAll()"> Allow All</button>
                <button onclick="tempDeselectAll()"> Block All</button>
                <button onclick="tempInvert()"> Invert</button>
            </div>
            
            <!-- Settings checkboxes grid -->
            <div class="temp-disable-grid" id="temp-disable-grid">
                <!-- Will be populated by JS -->
            </div>
            
            <!-- Time selector -->
            <div class="input-group">
                <label>Duration (auto re-enables after)</label>
                <div class="time-selector" id="time-selector">
                    <button class="time-btn" data-minutes="15" onclick="selectTime(15)">15 min</button>
                    <button class="time-btn" data-minutes="30" onclick="selectTime(30)">30 min</button>
                    <button class="time-btn selected" data-minutes="60" onclick="selectTime(60)">1 hour</button>
                    <button class="time-btn" data-minutes="120" onclick="selectTime(120)">2 hours</button>
                    <button class="time-btn" data-minutes="0" onclick="selectTime(0)">Custom</button>
                    <button class="time-btn" data-minutes="-1" onclick="selectTime(-1)">No limit</button>
                </div>
                <div class="custom-time-input" id="custom-time-input">
                    <input type="number" id="custom-minutes" min="1" max="1440" value="45" placeholder="Minutes">
                    <span style="color: #94a3b8;">minutes</span>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('temp-disable-modal')" style="background: #475569;">Cancel</button>
                <button class="btn" onclick="cancelTempDisable()" style="background: #dc2626;" id="cancel-temp-btn" disabled> Cancel & Re-enable</button>
                <button class="btn btn-primary" onclick="applyTempDisable()" style="background: linear-gradient(135deg, #16a34a, #15803d);"> Apply Temp Disable</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal-overlay hidden" id="notification-modal">
        <div class="modal">
            <div class="modal-title"> Send Notification</div>
            <div class="input-group">
                <label>Title</label>
                <input type="text" id="notify-title" placeholder="Notification title">
            </div>
            <div class="input-group">
                <label>Message</label>
                <textarea id="notify-message" rows="3" placeholder="Your message..."></textarea>
            </div>
            <div class="input-group">
                <label>Notification Type</label>
                <select id="notify-type">
                    <option value="normal">Normal (can be swiped away)</option>
                    <option value="persistent">Persistent (stays until action taken)</option>
                    <option value="alarm">Alarm (high priority with sound)</option>
                    <option value="silent">Silent (no sound)</option>
                </select>
            </div>
            <div class="input-group">
                <label>Priority</label>
                <select id="notify-priority">
                    <option value="default">Default</option>
                    <option value="high">High (heads-up notification)</option>
                    <option value="low">Low (no popup)</option>
                </select>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="notify-vibrate" checked>
                <label for="notify-vibrate">Vibrate</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="notify-sound" checked>
                <label for="notify-sound">Play sound</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="notify-repeat">
                <label for="notify-repeat">Repeat every 5 minutes until dismissed</label>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('notification-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-primary" onclick="sendNotification()">Send</button>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="modal-overlay hidden" id="pin-modal">
        <div class="modal">
            <div class="modal-title"> Reset Device PIN</div>
            <div class="input-group">
                <label>New PIN (4-8 digits)</label>
                <input type="text" id="new-pin" placeholder="Enter new PIN" maxlength="8">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('pin-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-warning" onclick="resetPIN()">Reset PIN</button>
            </div>
        </div>
    </div>

    <!-- Uninstall Modal -->
    <div class="modal-overlay hidden" id="uninstall-modal">
        <div class="modal">
            <div class="modal-title"> Remove Filter</div>
            <p style="color: #ef4444; margin-bottom: 20px;"> This will completely remove Limitly from the device. This action cannot be undone!</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('uninstall-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-danger" onclick="uninstallFilter()">Remove Filter</button>
            </div>
        </div>
    </div>

    <!-- Delete Device from Dashboard Modal -->
    <div class="modal-overlay hidden" id="delete-device-modal">
        <div class="modal">
            <div class="modal-title"> Delete Device from Dashboard</div>
            <p style="color: #f59e0b; margin-bottom: 12px;"> This will remove this device from the dashboard completely.</p>
            <p style="color: #94a3b8; margin-bottom: 20px; font-size: 13px;">Use this to clean up devices that have been uninstalled or are no longer in use. If the app is still installed on the device, it will re-register itself.</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('delete-device-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-danger" onclick="deleteDeviceFromDashboard()">Delete Device</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay hidden" id="rename-modal">
        <div class="modal">
            <div class="modal-title"> Rename Device</div>
            <div class="input-group">
                <label>Device Name</label>
                <input type="text" id="new-device-name" placeholder="Enter device name">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('rename-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-primary" onclick="renameDevice()">Save</button>
            </div>
        </div>
    </div>

    <!-- Add App Modal -->
    <div class="modal-overlay hidden" id="add-app-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-title"> Add Approved App</div>
            <div class="input-group">
                <label>App Name *</label>
                <input type="text" id="app-name" placeholder="e.g., Khan Academy">
            </div>
            <div class="input-group">
                <label>Description</label>
                <input type="text" id="app-description" placeholder="e.g., Educational videos and courses">
            </div>
            <div class="input-group">
                <label>Category</label>
                <select id="app-category" onchange="toggleCustomCategory('app')">
                    <option value="Education"> Education</option>
                    <option value="Productivity"> Productivity</option>
                    <option value="Communication"> Communication</option>
                    <option value="Utilities"> Utilities</option>
                    <option value="Games"> Games</option>
                    <option value="Entertainment"> Entertainment</option>
                    <option value="Health"> Health</option>
                    <option value="Finance"> Finance</option>
                    <option value="Music"> Music</option>
                    <option value="Books"> Books</option>
                    <option value="News"> News</option>
                    <option value="Religious"> Religious</option>
                    <option value="Jewish"> Jewish</option>
                    <option value="Torah"> Torah</option>
                    <option value="Other"> Other</option>
                    <option value="__custom__"> Custom Category...</option>
                </select>
            </div>
            <div class="input-group" id="app-custom-category-group" style="display: none;">
                <label>Custom Category Name</label>
                <input type="text" id="app-custom-category" placeholder="e.g., Sifrei Kodesh, Shiurim">
            </div>
            <div class="input-group">
                <label>Direct Download URL (APK)</label>
                <input type="text" id="app-download-url" placeholder="https://example.com/app.apk">
            </div>
            <div class="input-group">
                <label>OR Play Store Link</label>
                <input type="text" id="app-playstore-url" placeholder="https://play.google.com/store/apps/details?id=...">
            </div>
            <div style="display: flex; gap: 12px;">
                <div class="input-group" style="flex: 1;">
                    <label>Version</label>
                    <input type="text" id="app-version" placeholder="e.g., 1.2.3">
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>Size</label>
                    <input type="text" id="app-size" placeholder="e.g., 25 MB">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('add-app-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-success" onclick="addApprovedApp()">Add App</button>
            </div>
        </div>
    </div>

    <!-- Add Global App Modal -->
    <div class="modal-overlay hidden" id="add-global-app-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-title"> Add Global App (All Devices)</div>
            <div class="input-group">
                <label>App Name *</label>
                <input type="text" id="global-app-name" placeholder="e.g., Khan Academy">
            </div>
            <div class="input-group">
                <label>Package Name</label>
                <input type="text" id="global-app-package" placeholder="e.g., org.khanacademy.android">
            </div>
            <div class="input-group">
                <label>Description</label>
                <input type="text" id="global-app-description" placeholder="e.g., Educational videos and courses">
            </div>
            <div class="input-group">
                <label>Category</label>
                <select id="global-app-category" onchange="toggleCustomCategory('global-app')">
                    <option value="Education"> Education</option>
                    <option value="Productivity"> Productivity</option>
                    <option value="Communication"> Communication</option>
                    <option value="Utilities"> Utilities</option>
                    <option value="Games"> Games</option>
                    <option value="Entertainment"> Entertainment</option>
                    <option value="Health"> Health</option>
                    <option value="Finance"> Finance</option>
                    <option value="Music"> Music</option>
                    <option value="Books"> Books</option>
                    <option value="News"> News</option>
                    <option value="Religious"> Religious</option>
                    <option value="Jewish"> Jewish</option>
                    <option value="Torah"> Torah</option>
                    <option value="Other"> Other</option>
                    <option value="__custom__"> Custom Category...</option>
                </select>
            </div>
            <div class="input-group" id="global-app-custom-category-group" style="display: none;">
                <label>Custom Category Name</label>
                <input type="text" id="global-app-custom-category" placeholder="e.g., Sifrei Kodesh, Shiurim">
            </div>
            <div class="input-group">
                <label>Direct Download URL (APK) *</label>
                <input type="text" id="global-app-download-url" placeholder="https://example.com/app.apk">
            </div>
            <div style="display: flex; gap: 12px;">
                <div class="input-group" style="flex: 1;">
                    <label>Version</label>
                    <input type="text" id="global-app-version" placeholder="e.g., 1.2.3">
                </div>
                <div class="input-group" style="flex: 1;">
                    <label>Size</label>
                    <input type="text" id="global-app-size" placeholder="e.g., 25 MB">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('add-global-app-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-success" onclick="addGlobalApp()">Add Global App</button>
            </div>
        </div>
    </div>

    <!-- Support Tickets Modal -->
    <div class="modal-overlay hidden" id="support-tickets-modal">
        <div class="modal" style="max-width: 800px; width: 95%;">
            <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span> Support Tickets</span>
                <span id="ticket-stats" style="font-size: 12px; color: #94a3b8;"></span>
            </div>
            
            <!-- Filters -->
            <div class="ticket-filters">
                <button class="filter-btn active" onclick="filterTickets('all')" data-filter="all">All</button>
                <button class="filter-btn" onclick="filterTickets('pending')" data-filter="pending"> Pending</button>
                <button class="filter-btn" onclick="filterTickets('app_request')" data-filter="app_request"> App Requests</button>
                <button class="filter-btn" onclick="filterTickets('problem_report')" data-filter="problem_report"> Problems</button>
                <button class="filter-btn" onclick="filterTickets('diagnostics')" data-filter="diagnostics"> Diagnostics</button>
                <button class="filter-btn" onclick="filterTickets('cleared')" data-filter="cleared" style="margin-left:auto;opacity:0.7"> Cleared</button>
            </div>
            
            <!-- Ticket List -->
            <div class="ticket-list" id="ticket-list">
                <div class="empty-tickets">
                    <div class="empty-tickets-icon"></div>
                    <div>Loading tickets...</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('support-tickets-modal')" style="background: #475569;">Close</button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div class="modal-overlay hidden" id="ticket-detail-modal">
        <div class="modal" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-title" id="ticket-detail-title">Ticket Details</div>
            
            <div id="ticket-detail-content">
                <!-- Populated by JS -->
            </div>
            
            <!-- Reply Section -->
            <div class="reply-box">
                <div style="font-weight: 600; margin-bottom: 8px;"> Reply to User</div>
                <textarea class="reply-input" id="ticket-reply" placeholder="Write your response to the user..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('ticket-detail-modal')" style="background: #475569;">Close</button>
                <button class="btn" id="clear-ticket-btn" onclick="clearTicketFromAdmin()" style="background: #64748b;"> Clear</button>
                <button class="btn" onclick="createOverrideFromCurrentTicket()" style="background: #f97316;"> Add APK Fix</button>
                <button class="btn" onclick="approveAndWhitelistWebsite()" id="approve-whitelist-btn" style="background: #10b981; display: none;"> Approve & Whitelist</button>
                <button class="btn" onclick="updateTicketStatus('rejected')" style="background: #ef4444;"> Reject</button>
                <button class="btn" onclick="updateTicketStatus('in-progress')" style="background: #3b82f6;"> In Progress</button>
                <button class="btn btn-success" onclick="updateTicketStatus('resolved')"> Resolve</button>
            </div>
        </div>
    </div>

    <!-- Generic Modal (for dialogs) - higher z-index to appear on top of other modals -->
    <div class="modal-overlay hidden" id="generic-modal" style="z-index: 1100;">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-title" id="generic-modal-title">Dialog</div>
            <div id="generic-modal-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Time Requests Modal -->
    <div class="modal-overlay hidden" id="time-requests-modal">
        <div class="modal" style="max-width: 700px; width: 95%;">
            <div class="modal-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span> Screen Time Requests</span>
                <span id="time-request-stats" style="font-size: 12px; color: #94a3b8;"></span>
            </div>
            
            <!-- Filters -->
            <div class="ticket-filters">
                <button class="filter-btn active" onclick="filterTimeRequests('all')" data-filter="all">All</button>
                <button class="filter-btn" onclick="filterTimeRequests('pending')" data-filter="pending"> Pending</button>
                <button class="filter-btn" onclick="filterTimeRequests('approved')" data-filter="approved"> Approved</button>
                <button class="filter-btn" onclick="filterTimeRequests('denied')" data-filter="denied"> Denied</button>
            </div>
            
            <!-- Request List -->
            <div class="ticket-list" id="time-request-list" style="max-height: 500px; overflow-y: auto;">
                <div class="empty-requests">
                    <div class="empty-requests-icon"></div>
                    <div>Loading time requests...</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('time-requests-modal')" style="background: #475569;">Close</button>
            </div>
        </div>
    </div>

    <!-- Set App Limit Modal -->
    <div class="modal-overlay hidden" id="set-app-limit-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-title"> Set App Limit</div>
            
            <!-- Search/Filter -->
            <div class="input-group">
                <label>Search Apps</label>
                <input type="text" id="app-limit-search" placeholder="Type to filter apps..." oninput="filterAppLimitList()">
            </div>
            
            <!-- App Selection -->
            <div class="input-group">
                <label>Select App</label>
                <div id="app-limit-list" style="max-height: 300px; overflow-y: auto; background: rgba(51, 65, 85, 0.3); border-radius: 8px; border: 1px solid rgba(71, 85, 105, 0.5);">
                    <div style="padding: 20px; text-align: center; color: #64748b;">Loading apps...</div>
                </div>
            </div>
            
            <!-- Selected App Display -->
            <div id="selected-app-display" style="display: none; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 24px;" id="selected-app-icon"></span>
                    <div>
                        <div style="font-weight: 600; color: #22c55e;" id="selected-app-name">App Name</div>
                        <div style="font-size: 11px; color: #64748b;" id="selected-app-package">com.example.app</div>
                    </div>
                </div>
            </div>
            
            <!-- Time Limit -->
            <div class="input-group">
                <label>Daily Limit</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                    <button class="btn time-preset-btn" onclick="setLimitPreset(15)" style="background: #475569;">15 min</button>
                    <button class="btn time-preset-btn" onclick="setLimitPreset(30)" style="background: #475569;">30 min</button>
                    <button class="btn time-preset-btn" onclick="setLimitPreset(60)" style="background: #6366f1;">1 hour</button>
                    <button class="btn time-preset-btn" onclick="setLimitPreset(120)" style="background: #475569;">2 hours</button>
                    <button class="btn time-preset-btn" onclick="setLimitPreset(180)" style="background: #475569;">3 hours</button>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" id="limit-app-minutes" placeholder="60" min="0" max="1440" value="60" style="flex: 1;">
                    <span style="color: #94a3b8;">minutes</span>
                </div>
                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Set to 0 to remove limit</div>
            </div>
            
            <input type="hidden" id="limit-app-package">
            
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('set-app-limit-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-primary" onclick="saveAppLimit()" id="save-app-limit-btn" disabled>Save Limit</button>
            </div>
        </div>
    </div>

    <!-- Set Category Limit Modal -->
    <div class="modal-overlay hidden" id="set-category-limit-modal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-title"> Set Category Limit</div>
            <div class="input-group">
                <label>Category</label>
                <select id="limit-category-name">
                    <option value="SOCIAL"> Social Media</option>
                    <option value="GAMES"> Games</option>
                    <option value="ENTERTAINMENT"> Entertainment</option>
                    <option value="PRODUCTIVITY"> Productivity</option>
                    <option value="EDUCATION"> Education</option>
                    <option value="CREATIVITY"> Creativity</option>
                    <option value="READING"> Reading</option>
                    <option value="HEALTH"> Health</option>
                    <option value="SHOPPING"> Shopping</option>
                    <option value="TRAVEL"> Travel</option>
                    <option value="UTILITIES"> Utilities</option>
                    <option value="OTHER"> Other</option>
                </select>
            </div>
            <div class="input-group">
                <label>Daily Limit (minutes)</label>
                <input type="number" id="limit-category-minutes" placeholder="120" min="0" max="1440">
                <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Set to 0 to remove limit</div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('set-category-limit-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-primary" onclick="saveCategoryLimit()">Save Limit</button>
            </div>
        </div>
    </div>

    <!-- Grant Time Extension Modal -->
    <div class="modal-overlay hidden" id="grant-time-modal" style="z-index: 1100;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-title"> Grant Extra Time</div>
            <div id="grant-time-app-info" style="margin-bottom: 16px;"></div>
            <div class="input-group">
                <label>Extra Minutes to Grant</label>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                    <button class="btn" onclick="setGrantTime(15)" style="background: #475569;">15 min</button>
                    <button class="btn" onclick="setGrantTime(30)" style="background: #475569;">30 min</button>
                    <button class="btn" onclick="setGrantTime(60)" style="background: #475569;">1 hour</button>
                    <button class="btn" onclick="setGrantTime(120)" style="background: #475569;">2 hours</button>
                </div>
                <input type="number" id="grant-time-minutes" placeholder="30" min="1" max="480" value="30">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('grant-time-modal')" style="background: #475569;">Cancel</button>
                <button class="btn btn-success" onclick="confirmGrantTime()"> Grant Time</button>
            </div>
        </div>
    </div>

    <!-- Partners Panel Modal -->
    <div class="modal-overlay hidden" id="partners-panel-modal">
        <div class="modal" style="max-width: 800px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-title"> Partner Management</div>
            <div id="partners-panel-content">
                <!-- Populated by JS -->
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('partners-panel-modal')" style="background: #475569;">Close</button>
            </div>
        </div>
    </div>

    <!-- PINs Panel Modal -->
    <div class="modal-overlay hidden" id="pins-panel-modal">
        <div class="modal" style="max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-title"> Device PIN Database</div>
            <div id="pins-panel-content">
                <!-- Populated by JS -->
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('pins-panel-modal'); lockPinDatabase();" style="background: #475569;">Close & Lock</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAf9DWBFzjOSSDaMNs2Ye3Lbyolu9aip3Y",
            authDomain: "yeshivafilter-fec0e.firebaseapp.com",
            databaseURL: "https://yeshivafilter-fec0e-default-rtdb.firebaseio.com",
            projectId: "yeshivafilter-fec0e",
            storageBucket: "yeshivafilter-fec0e.firebasestorage.app",
            messagingSenderId: "908103316099",
            appId: "1:908103316099:web:b54c3b6a313e90ec0f6bf6",
            measurementId: "G-VVZSNMF5RW"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // =====================================================
        // SECURITY: HMAC Command Signing
        // This secret MUST match the one in FirebaseManager.kt and SecurityManager.kt
        // =====================================================
        const COMMAND_HMAC_SECRET = 'bZvMlg5MSXFoixlPAv6zvb9XAWTCuqwsVqAs/U7jG5U=';

        // Sign command data using HMAC-SHA256
        async function signCommand(commandData) {
            try {
                // Create a consistent string from command data (excluding signature)
                const dataToSign = JSON.stringify({
                    action: commandData.action,
                    timestamp: commandData.timestamp,
                    createdBy: commandData.createdBy
                });
                
                // Convert secret and data to bytes
                const encoder = new TextEncoder();
                const keyData = encoder.encode(COMMAND_HMAC_SECRET);
                const messageData = encoder.encode(dataToSign);
                
                // Import key for HMAC
                const key = await crypto.subtle.importKey(
                    'raw',
                    keyData,
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['sign']
                );
                
                // Sign the data
                const signature = await crypto.subtle.sign('HMAC', key, messageData);
                
                // Convert to base64
                const signatureArray = new Uint8Array(signature);
                const signatureBase64 = btoa(String.fromCharCode(...signatureArray));
                
                return signatureBase64;
            } catch (e) {
                console.error('Failed to sign command:', e);
                return null;
            }
        }

        let currentUser = null;
        let currentUserRole = null;  // 'owner', 'admin', 'partner', or 'worker'
        let currentPartnerId = null; // Partner's ID for filtering devices
        let devicesData = {};
        let selectedDeviceId = null;
        let selectedDevicesForBulk = new Set();  // For bulk delete
        let deviceFilterMode = 'all';  // 'all', 'offline', 'uninstalled', 'alerts'
        let currentTab = 'quick';
        let isLoggingIn = false;

        // =====================================================
        // AUTH STATE
        // =====================================================
        // Clear any existing session on first load of new dashboard
        if (!sessionStorage.getItem('dashboard_v8_loaded')) {
            sessionStorage.setItem('dashboard_v8_loaded', 'true');
            auth.signOut();
        }
        
        auth.onAuthStateChanged((user) => {
            if (user && !isLoggingIn) {
                currentUser = user;
                document.getElementById('user-email').textContent = user.email;
                
                // Check user role from database
                database.ref('users/' + user.uid).once('value').then(async (snapshot) => {
                    const userData = snapshot.val();
                    if (userData && userData.role) {
                        currentUserRole = userData.role;
                        currentPartnerId = userData.partner_id || null; // Store partner ID for filtering
                        
                        const roleEl = document.getElementById('user-role');
                        roleEl.textContent = userData.role.charAt(0).toUpperCase() + userData.role.slice(1);
                        roleEl.className = 'role-badge role-' + userData.role;
                        
                        // Check if partner is active
                        if (userData.role === 'partner') {
                            const emailKey = user.email.replace(/[.#$\/\[\]]/g, '_');
                            const partnerSnap = await database.ref('partner_emails/' + emailKey).once('value');
                            const partnerData = partnerSnap.val();
                            if (partnerData && partnerData.active === false) {
                                alert('Your partner account has been disabled. Contact the administrator.');
                                auth.signOut();
                                return;
                            }
                            // Make sure we have the partner_id
                            if (!currentPartnerId && partnerData) {
                                currentPartnerId = partnerData.partner_id;
                            }
                        }
                    } else {
                        // Check if this email is a partner
                        const emailKey = user.email.replace(/[.#$\/\[\]]/g, '_');
                        const partnerSnap = await database.ref('partner_emails/' + emailKey).once('value');
                        const partnerData = partnerSnap.val();
                        
                        if (partnerData && partnerData.role === 'partner') {
                            // This is a partner - set their role
                            currentUserRole = 'partner';
                            currentPartnerId = partnerData.partner_id; // Store partner ID
                            document.getElementById('user-role').textContent = 'Partner';
                            document.getElementById('user-role').className = 'role-badge role-partner';
                            
                            // Check if active
                            if (partnerData.active === false) {
                                alert('Your partner account has been disabled. Contact the administrator.');
                                auth.signOut();
                                return;
                            }
                            
                            // Save user record with partner role
                            await database.ref('users/' + user.uid).set({
                                email: user.email,
                                role: 'partner',
                                partner_id: partnerData.partner_id,
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            });
                        } else {
                            // Not a partner - this is the PARTNER dashboard, redirect them
                            currentUserRole = 'owner';
                            currentPartnerId = null; // Owner sees all devices
                            document.getElementById('user-role').textContent = 'Owner';
                            document.getElementById('user-role').className = 'role-badge role-owner';
                        }
                    }
                    
                    // Hide Partners tab for non-owners
                    updateTabVisibility();
                });
                
                showDashboard();
                setupFirebaseConnectionMonitor();
                console.log(' Calling setupSupportTicketsListener...');
                setupSupportTicketsListener(); // Initialize support tickets
                setupTimeRequestsListener(); // Initialize time requests
            } else if (!isLoggingIn) {
                currentUser = null;
                currentUserRole = null;
                document.getElementById('dashboard').classList.remove('active');
                document.getElementById('auth-screen').style.display = 'flex';
            }
        });
        
        // Show/hide tabs based on user role
        function updateTabVisibility() {
            // Hide Partners button for non-owners
            const partnersBtn = document.getElementById('partners-btn');
            if (partnersBtn) {
                if (currentUserRole === 'owner') {
                    partnersBtn.style.display = '';
                } else {
                    partnersBtn.style.display = 'none';
                }
            }
        }

        // =====================================================
        // LOGIN / LOGOUT
        // =====================================================
        function showLogin() {
            document.getElementById('login-box').classList.remove('hidden');
            document.getElementById('forgot-box').classList.add('hidden');
        }

        function showForgotPassword() {
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('forgot-box').classList.remove('hidden');
        }

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');

            if (!email || !password) {
                errorEl.textContent = 'Please fill in all fields';
                errorEl.classList.remove('hidden');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Logging in...';
            isLoggingIn = true;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                errorEl.classList.add('hidden');
                currentUser = auth.currentUser;
                document.getElementById('user-email').textContent = currentUser.email;
                showDashboard();
            } catch (error) {
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.remove('hidden');
                isLoggingIn = false;
            }

            btn.disabled = false;
            btn.textContent = 'Login';
        }

        async function sendPasswordReset() {
            const email = document.getElementById('forgot-email').value;
            const errorEl = document.getElementById('forgot-error');

            if (!email) {
                errorEl.textContent = 'Please enter your email';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showToast('Password reset email sent!');
                showLogin();
            } catch (error) {
                errorEl.textContent = getAuthErrorMessage(error.code);
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            auth.signOut();
            showToast('Logged out');
        }

        function getAuthErrorMessage(code) {
            const messages = {
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/invalid-email': 'Invalid email address',
                'auth/too-many-requests': 'Too many attempts. Try again later',
                'auth/email-already-in-use': 'Email already in use',
                'auth/invalid-credential': 'Invalid email or password'
            };
            return messages[code] || 'Authentication failed: ' + code;
        }

        // =====================================================
        // DASHBOARD
        // =====================================================
        function showDashboard() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('dashboard').classList.add('active');
            isLoggingIn = false;
            loadDevices();
        }
        
        function setupFirebaseConnectionMonitor() {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', snap => {
                const statusDot = document.getElementById('firebase-status');
                const statusText = document.getElementById('firebase-status-text');
                
                if (snap.val() === true) {
                    statusDot.className = 'connection-dot online';
                    statusText.textContent = 'Connected';
                } else {
                    statusDot.className = 'connection-dot offline';
                    statusText.textContent = 'Disconnected';
                }
            });
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // =====================================================
        // LOAD DEVICES - Filtered by partner_id if set
        // =====================================================
        function loadDevices() {
            database.ref('devices').on('value', (snapshot) => {
                const allDevices = snapshot.val() || {};
                
                // PARTNER FILTERING: If user has a partner_id, only show their devices
                if (currentPartnerId) {
                    devicesData = {};
                    Object.entries(allDevices).forEach(([id, device]) => {
                        if (device.info?.partner_id === currentPartnerId) {
                            devicesData[id] = device;
                        }
                    });
                    console.log(`Partner ${currentPartnerId}: Showing ${Object.keys(devicesData).length} of ${Object.keys(allDevices).length} devices`);
                } else {
                    // Owner/Admin sees all devices
                    devicesData = allDevices;
                }
                
                renderDeviceList();
                updateStats();
            });
        }

        function refreshDevices() {
            showToast('Refreshing...');
            if (selectedDeviceId) {
                renderDeviceDetail(selectedDeviceId);
            }
            renderDeviceList();
        }

        // Track selected devices for bulk operations
        
        function renderDeviceList() {
            const container = document.getElementById('device-list');
            const deviceIds = Object.keys(devicesData);

            if (deviceIds.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No devices registered</div>';
                return;
            }

            // Filter devices based on mode
            const filteredIds = deviceIds.filter(id => {
                const device = devicesData[id];
                const info = device.info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                const isUninstalled = info.status === 'uninstalled';
                const hasAlert = info.tamperDetected || (info.failedPinAttempts || 0) >= 3 || (device.alerts && Object.keys(device.alerts).length > 0);
                
                if (deviceFilterMode === 'offline') return !isOnline && !isUninstalled;
                if (deviceFilterMode === 'uninstalled') return isUninstalled;
                if (deviceFilterMode === 'alerts') return hasAlert;
                return true; // 'all'
            });

            // Bulk actions header
            const bulkHeader = `
                <div style="background: rgba(30, 41, 59, 0.5); padding: 12px; border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(51, 65, 85, 0.5);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="select-all-devices" onchange="toggleSelectAll()" style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: #cbd5e1;">Select All (${filteredIds.length})</span>
                        </label>
                        <span id="selected-count" style="font-size: 12px; color: #94a3b8;">0 selected</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="deviceFilterMode='all'; renderDeviceList();" style="padding: 4px 12px; font-size: 12px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.3); background: ${deviceFilterMode === 'all' ? 'rgba(59, 130, 246, 0.2)' : 'transparent'}; color: ${deviceFilterMode === 'all' ? '#60a5fa' : '#94a3b8'}; cursor: pointer;">All</button>
                        <button onclick="deviceFilterMode='offline'; renderDeviceList();" style="padding: 4px 12px; font-size: 12px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.3); background: ${deviceFilterMode === 'offline' ? 'rgba(239, 68, 68, 0.2)' : 'transparent'}; color: ${deviceFilterMode === 'offline' ? '#ef4444' : '#94a3b8'}; cursor: pointer;">Offline</button>
                        <button onclick="deviceFilterMode='uninstalled'; renderDeviceList();" style="padding: 4px 12px; font-size: 12px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.3); background: ${deviceFilterMode === 'uninstalled' ? 'rgba(168, 85, 247, 0.2)' : 'transparent'}; color: ${deviceFilterMode === 'uninstalled' ? '#a855f7' : '#94a3b8'}; cursor: pointer;">Uninstalled</button>
                        <button onclick="deviceFilterMode='alerts'; renderDeviceList();" style="padding: 4px 12px; font-size: 12px; border-radius: 6px; border: 1px solid rgba(148, 163, 184, 0.3); background: ${deviceFilterMode === 'alerts' ? 'rgba(251, 191, 36, 0.2)' : 'transparent'}; color: ${deviceFilterMode === 'alerts' ? '#fbbf24' : '#94a3b8'}; cursor: pointer;"> Alerts</button>
                        <button onclick="bulkDeleteDevices()" id="bulk-delete-btn" disabled style="padding: 4px 16px; font-size: 12px; border-radius: 6px; border: none; background: #dc2626; color: white; cursor: not-allowed; font-weight: 600; opacity: 0.5;"> Delete Selected</button>
                    </div>
                </div>
            `;

            const devicesHtml = filteredIds.map(id => {
                const device = devicesData[id];
                const info = device.info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                const isUninstalled = info.status === 'uninstalled';
                const hasAlert = info.tamperDetected || (info.failedPinAttempts || 0) >= 3 || (device.alerts && Object.keys(device.alerts).length > 0);
                const isPermanentlyLocked = (info.failedPinAttempts || 0) >= 10 || info.lockoutStatus?.isPermanentlyLocked;
                const isLockedOut = info.lockoutStatus?.isLockedOut;
                const updateStatus = getUpdateStatus(device);
                const isSelected = selectedDevicesForBulk.has(id);
                
                let statusIcon = '';
                if (isUninstalled) statusIcon = '';
                else if (isPermanentlyLocked) statusIcon = '';
                else if (isLockedOut) statusIcon = '';
                else if (hasAlert) statusIcon = '';
                
                return `
                    <div class="device-item ${selectedDeviceId === id ? 'selected' : ''} ${isUninstalled ? 'device-uninstalled' : ''}" style="${isPermanentlyLocked ? 'border-left: 3px solid #dc2626;' : (isLockedOut ? 'border-left: 3px solid #f59e0b;' : '')}; display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleDeviceSelection('${id}')" onclick="event.stopPropagation();" style="width: 16px; height: 16px; cursor: pointer; flex-shrink: 0;">
                        <div onclick="selectDevice('${id}')" style="flex: 1; cursor: pointer;">
                            <div class="device-name" style="${isUninstalled ? 'opacity: 0.6;' : ''}">
                                <span class="status-dot ${isUninstalled ? 'status-uninstalled' : (isOnline ? 'status-online' : 'status-offline')}"></span>
                                ${info.name || 'Unnamed Device'}
                                ${statusIcon}
                            </div>
                            <div class="device-info" style="${isUninstalled ? 'opacity: 0.6;' : ''}">
                                ${isUninstalled ? ' Uninstalled' : isPermanentlyLocked ? '<span style="color:#ef4444;"> DISABLED</span>' : isLockedOut ? '<span style="color:#f59e0b;"> Locked</span>' : (info.model || 'Unknown') + '  ' + formatLastSeen(info.lastSeen)}
                            </div>
                            ${updateStatus.html}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = bulkHeader + devicesHtml;
            updateBulkDeleteUI();
        }

        function toggleDeviceSelection(deviceId) {
            if (selectedDevicesForBulk.has(deviceId)) {
                selectedDevicesForBulk.delete(deviceId);
            } else {
                selectedDevicesForBulk.add(deviceId);
            }
            updateBulkDeleteUI();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('select-all-devices');
            const deviceIds = Object.keys(devicesData).filter(id => {
                const device = devicesData[id];
                const info = device.info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                const isUninstalled = info.status === 'uninstalled';
                const hasAlert = info.tamperDetected || (info.failedPinAttempts || 0) >= 3 || (device.alerts && Object.keys(device.alerts).length > 0);
                
                if (deviceFilterMode === 'offline') return !isOnline && !isUninstalled;
                if (deviceFilterMode === 'uninstalled') return isUninstalled;
                if (deviceFilterMode === 'alerts') return hasAlert;
                return true;
            });
            
            if (checkbox.checked) {
                deviceIds.forEach(id => selectedDevicesForBulk.add(id));
            } else {
                selectedDevicesForBulk.clear();
            }
            renderDeviceList();
        }

        function updateBulkDeleteUI() {
            const count = selectedDevicesForBulk.size;
            const countEl = document.getElementById('selected-count');
            const deleteBtn = document.getElementById('bulk-delete-btn');
            const selectAllCheckbox = document.getElementById('select-all-devices');
            
            if (countEl) countEl.textContent = `${count} selected`;
            
            if (deleteBtn) {
                deleteBtn.disabled = count === 0;
                deleteBtn.style.opacity = count === 0 ? '0.5' : '1';
                deleteBtn.style.cursor = count === 0 ? 'not-allowed' : 'pointer';
            }
            
            const filteredIds = Object.keys(devicesData).filter(id => {
                const device = devicesData[id];
                const info = device.info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                const isUninstalled = info.status === 'uninstalled';
                const hasAlert = info.tamperDetected || (info.failedPinAttempts || 0) >= 3 || (device.alerts && Object.keys(device.alerts).length > 0);
                
                if (deviceFilterMode === 'offline') return !isOnline && !isUninstalled;
                if (deviceFilterMode === 'uninstalled') return isUninstalled;
                if (deviceFilterMode === 'alerts') return hasAlert;
                return true;
            });
            
            if (selectAllCheckbox && filteredIds.length > 0) {
                selectAllCheckbox.checked = filteredIds.every(id => selectedDevicesForBulk.has(id));
                selectAllCheckbox.indeterminate = !selectAllCheckbox.checked && filteredIds.some(id => selectedDevicesForBulk.has(id));
            }
        }

        async function bulkDeleteDevices() {
            const count = selectedDevicesForBulk.size;
            if (count === 0) return;
            
            const deviceNames = Array.from(selectedDevicesForBulk).map(id => {
                const device = devicesData[id];
                return device?.info?.name || 'Unnamed Device';
            }).slice(0, 5);
            
            const namesList = deviceNames.join('\n ');
            const more = count > 5 ? `\n ... and ${count - 5} more` : '';
            
            if (!confirm(` DELETE ${count} DEVICE${count > 1 ? 'S' : ''}?\n\nThis will permanently remove:\n ${namesList}${more}\n\nThis action cannot be undone!`)) {
                return;
            }
            
            showToast(`Deleting ${count} devices...`, false);
            
            let deleted = 0;
            let failed = 0;
            
            for (const deviceId of selectedDevicesForBulk) {
                try {
                    await database.ref(`devices/${deviceId}`).remove();
                    deleted++;
                    if (selectedDeviceId === deviceId) selectedDeviceId = null;
                } catch (err) {
                    console.error(`Failed to delete ${deviceId}:`, err);
                    failed++;
                }
            }
            
            selectedDevicesForBulk.clear();
            showAllDevices();
            
            if (failed === 0) {
                showToast(` Successfully deleted ${deleted} device${deleted > 1 ? 's' : ''}!`, false);
            } else {
                showToast(` Deleted ${deleted}, failed ${failed}`, true);
            }
        }

        function quickDeleteDevice(deviceId) {
            console.log('Attempting to delete device:', deviceId);
            if (!confirm('Delete this device from the dashboard?')) {
                console.log('Delete cancelled by user');
                return;
            }
            console.log('Deleting device from Firebase...');
            database.ref(`devices/${deviceId}`).remove()
                .then(() => {
                    console.log('Device deleted successfully');
                    showToast('Device deleted');
                    if (selectedDeviceId === deviceId) selectedDeviceId = null;
                    showAllDevices();
                })
                .catch(err => {
                    console.error('Failed to delete device:', err);
                    showToast('Failed to delete: ' + err.message, true);
                });
        }


        function getUpdateStatus(device) {
            const settings = device.settings || {};
            const updateDeadline = settings.update_deadline || 0;
            const updateAvailable = settings.update_available || false;
            
            if (!updateAvailable || !updateDeadline) {
                return { html: '', status: 'none' };
            }
            
            const now = Date.now();
            const remaining = updateDeadline - now;
            
            if (remaining <= 0) {
                return { 
                    html: '<div class="device-update-status device-update-overdue"> UPDATE OVERDUE</div>',
                    status: 'overdue'
                };
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            
            return {
                html: `<div class="device-update-status device-update-pending"> ${hours}h ${minutes}m left</div>`,
                status: 'pending'
            };
        }

        function updateStats() {
            const devices = Object.values(devicesData);
            const online = devices.filter(d => d.info?.online && (Date.now() - (d.info?.lastSeen || 0)) < 60000).length;
            const alertDevices = devices.filter(d => 
                d.info?.tamperDetected || 
                (d.info?.failedPinAttempts || 0) >= 3 ||
                (d.alerts && Object.keys(d.alerts).length > 0)
            );
            const alerts = alertDevices.length;
            
            document.getElementById('total-devices').textContent = `${devices.length} Devices`;
            document.getElementById('online-count').textContent = `${online} Online`;
            
            const alertsBadge = document.getElementById('alerts-count');
            alertsBadge.textContent = `${alerts} Alerts`;
            alertsBadge.className = alerts > 0 ? 'stat-badge has-alerts' : 'stat-badge';
            
            // Update push update modal count
            document.getElementById('push-update-device-count').textContent = `${devices.length} device(s) will receive the update`;
        }

        function showDeviceWithAlerts() {
            const alertDevice = Object.entries(devicesData).find(([id, d]) => 
                d.info?.tamperDetected || 
                (d.info?.failedPinAttempts || 0) >= 3 ||
                (d.alerts && Object.keys(d.alerts).length > 0)
            );
            if (alertDevice) {
                selectDevice(alertDevice[0]);
                showToast('Showing device with alerts');
            } else {
                showToast('No devices with alerts');
            }
        }

        function showAllDevices() {
            selectedDeviceId = null;
            renderDeviceList();
            document.getElementById('main-content').innerHTML = `
                <div class="no-device-selected">
                    <span></span>
                    <h2>Select a device</h2>
                    <p>Choose a device from the list to manage it</p>
                </div>
            `;
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return 'Never';
            const diff = Date.now() - timestamp;
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
            if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
            return `${Math.floor(diff / 86400000)}d ago`;
        }

        // =====================================================
        // DEVICE DETAIL
        // =====================================================
        function selectDevice(deviceId) {
            selectedDeviceId = deviceId;
            currentTab = 'quick';
            renderDeviceList();
            renderDeviceDetail(deviceId);
        }

        function renderDeviceDetail(deviceId) {
            const device = devicesData[deviceId];
            if (!device) return;

            const info = device.info || {};
            const settings = device.settings || {};
            const logs = device.logs || {};
            const apps = device.apps || {};
            const screenTime = device.screenTime || {};
            const fcm = device.fcm || {};  // FCM token data
            const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
            const hasAlert = info.tamperDetected || (info.failedPinAttempts || 0) >= 3;
            const updateStatus = getUpdateStatus(device);
            
            // Get today's screen time
            const today = new Date().toISOString().split('T')[0];
            const todayScreenTime = screenTime[today] || {};
            const totalMinutes = todayScreenTime.totalMinutes || 0;
            
            // Count blocked attempts
            const blockedAttempts = Object.values(logs).filter(l => 
                l.action && (l.action.includes('blocked') || l.action.includes('denied') || l.action.includes('prevented'))
            );
            const todayBlocked = blockedAttempts.filter(l => {
                if (!l.timestamp) return false;
                const logDate = new Date(l.timestamp).toISOString().split('T')[0];
                return logDate === today;
            }).length;
            
            // Check lockout status
            const failedAttempts = info.failedPinAttempts || 0;
            const isPermanentlyLocked = failedAttempts >= 10 || info.lockoutStatus?.isPermanentlyLocked;
            const isLockedOut = info.lockoutStatus?.isLockedOut && !isPermanentlyLocked;
            const resetCode = generateResetCode(deviceId);

            // Check for alerts in the alerts node
            const alerts = device.alerts || {};
            const alertList = Object.entries(alerts);
            const hasAlerts = alertList.length > 0 || info.tamperDetected || (info.failedPinAttempts || 0) >= 3;

            document.getElementById('main-content').innerHTML = `
                ${hasAlerts ? `
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <span style="font-weight: 700; font-size: 16px;"> Security Alert${alertList.length > 1 ? 's' : ''}</span>
                            <button onclick="acknowledgeAlert('${deviceId}')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Clear All & Unlock</button>
                        </div>
                        ${alertList.length > 0 ? alertList.map(([alertId, alert]) => {
                            const alertInfo = getAlertDescription(alert.type);
                            const time = new Date(alert.timestamp).toLocaleString();
                            return `
                                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600; margin-bottom: 4px;">${alertInfo.title}</div>
                                            <div style="font-size: 12px; opacity: 0.9;">${alertInfo.desc}</div>
                                            <div style="font-size: 11px; opacity: 0.7; margin-top: 4px;"> ${time}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : `
                            <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                                <div style="font-weight: 600;">${info.tamperDetected ? 'Tamper Detected' : `${info.failedPinAttempts} Failed PIN Attempts`}</div>
                                <div style="font-size: 12px; opacity: 0.9;">Security alert triggered on device.</div>
                            </div>
                        `}
                    </div>
                ` : ''}
                
                ${isPermanentlyLocked ? `
                    <div class="lockout-box permanent">
                        <div class="lockout-header">
                            <div class="lockout-title"> Device Permanently Locked</div>
                            <button onclick="clearLockout('${deviceId}')" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Clear Lockout</button>
                        </div>
                        <div style="font-size: 13px; opacity: 0.9;">Too many failed PIN attempts (${failedAttempts}). Device is disabled until admin reset.</div>
                        <div class="reset-code-display">
                            <div class="reset-code-label">Admin Reset Code</div>
                            <div class="reset-code">${resetCode}</div>
                            <div class="reset-code-hint">Give this code to the user. They enter it on the "Device Disabled" screen to unlock.</div>
                        </div>
                    </div>
                ` : isLockedOut ? `
                    <div class="lockout-box">
                        <div class="lockout-header">
                            <div class="lockout-title"> Device Temporarily Locked</div>
                            <button onclick="clearLockout('${deviceId}')" style="background: rgba(0,0,0,0.2); border: none; color: #1e293b; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;"> Clear Lockout</button>
                        </div>
                        <div style="font-size: 13px;">${failedAttempts} failed PIN attempts. User must wait before trying again.</div>
                    </div>
                ` : ''}
                
                ${updateStatus.status !== 'none' ? `
                    <div class="update-banner ${updateStatus.status}">
                        <div>
                            <div class="update-banner-text">${updateStatus.status === 'overdue' ? ' Update Overdue - Device Locked!' : ' Update Pending'}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
                                ${updateStatus.status === 'overdue' ? 'User must install update to use device' : 'User has time remaining to install'}
                            </div>
                        </div>
                        <button class="update-banner-btn" onclick="sendCommand('check_update')">Force Install Now</button>
                    </div>
                ` : ''}

                <div class="device-header">
                    <div>
                        <div class="device-title">
                            <span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}"></span>
                            ${info.name || 'Unnamed Device'}
                            ${info.status === 'uninstalled' ? '<span style="color: #ef4444; font-size: 12px; margin-left: 8px;"> Uninstalled</span>' : ''}
                        </div>
                        <div class="device-meta">
                            ${info.model || 'Unknown'}  Android ${info.androidVersion || '?'}  
                            ${isOnline ? ' Online' : ' ' + formatLastSeen(info.lastSeen)}
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="btn" onclick="refreshDevices()" style="background:#0ea5e9;"></button>
                        <button class="btn btn-primary" onclick="openModal('notification-modal')"> Notify</button>
                        <button class="btn btn-success" onclick="openTempDisableModal()"> Temp Disable</button>
                        <button class="btn btn-warning" onclick="openModal('pin-modal')"> PIN</button>
                        <button class="btn btn-purple" onclick="sendCommand('check_update')"> Update</button>
                        <button class="btn btn-danger" onclick="openModal('uninstall-modal')" title="Uninstall from device"></button>
                        <button class="btn" onclick="openModal('delete-device-modal')" style="background:#6b7280;" title="Delete from dashboard"></button>
                    </div>
                </div>

                <!-- Quick Stats - NEW -->
                <div class="quick-stats-grid">
                    <div class="quick-stat ${isOnline ? 'online' : 'offline'}">
                        <div class="quick-stat-value">${isOnline ? '' : ''}</div>
                        <div class="quick-stat-label">${isOnline ? 'Online' : 'Offline'}</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${Math.floor(totalMinutes / 60)}h ${totalMinutes % 60}m</div>
                        <div class="quick-stat-label">Screen Time Today</div>
                    </div>
                    <div class="quick-stat ${todayBlocked > 0 ? 'warning' : ''}">
                        <div class="quick-stat-value">${todayBlocked}</div>
                        <div class="quick-stat-label">Blocked Today</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${info.battery || '?'}%</div>
                        <div class="quick-stat-label">Battery</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${info.failedPinAttempts || 0}</div>
                        <div class="quick-stat-label">Failed PINs</div>
                    </div>
                    <div class="quick-stat">
                        <div class="quick-stat-value">${info.isDeviceOwner ? '' : ''}</div>
                        <div class="quick-stat-label">Protected</div>
                    </div>
                </div>

                <!-- Screenshot Section -->
                <div class="screenshot-section" id="screenshot-section">
                    <div class="screenshot-header">
                        <div class="screenshot-title"> Screenshot</div>
                        <div class="screenshot-buttons">
                            <button class="screenshot-clear-btn hidden" id="clear-screenshot-btn" onclick="clearScreenshot()"> Clear</button>
                            <button class="screenshot-btn" id="capture-btn" onclick="captureScreenshot()">
                                <span></span> Capture
                            </button>
                        </div>
                    </div>
                    <div class="screenshot-container" id="screenshot-container">
                        <div class="screenshot-placeholder" id="screenshot-placeholder">
                            <div class="screenshot-placeholder-icon"></div>
                            <div class="screenshot-placeholder-text">Click "Capture" to take a screenshot</div>
                        </div>
                        <img class="screenshot-image hidden" id="screenshot-image" onclick="openScreenshotFullscreen()">
                    </div>
                    <div class="screenshot-meta">
                        <div class="screenshot-status" id="screenshot-status"></div>
                        <div class="screenshot-time" id="screenshot-time"></div>
                    </div>
                </div>

                <!-- Device Actions Section -->
                <div class="device-actions-section">
                    <div class="device-actions-title"> Device Actions</div>
                    <div class="device-actions-buttons">
                        <button class="action-btn ping-btn" id="ping-btn" onclick="pingDevice()" title="Wake device and force status update">
                             Ping Device
                        </button>
                        <button class="action-btn reconnect-btn" id="reconnect-btn" onclick="forceReconnect()" title="Force Firebase reconnect">
                             Force Reconnect
                        </button>
                        <button class="action-btn" id="wake-push-btn" onclick="sendWakePush()" title="Send FCM push to wake device (works even when offline!)" style="background: linear-gradient(135deg, #ec4899, #be185d);">
                             Wake Push
                        </button>
                        <button class="action-btn temp-disable-btn" id="open-temp-disable-btn" onclick="openTempDisableModal()" title="Temporarily disable selected restrictions">
                             Temp Disable
                        </button>
                    </div>
                    <div class="ping-status" id="ping-status"></div>
                    <div class="temp-status" id="temp-status"></div>
                    
                    <!-- FCM Token Info -->
                    <div id="fcm-info" style="margin-top: 8px; font-size: 11px; color: #64748b;">
                        ${device.info?.hasGms === false 
                            ? '<span style="color: #6b7280;"> No Google Play Services - FCM unavailable</span>' 
                            : (fcm.token 
                                ? `<span title="${fcm.token}"> FCM: ${fcm.token.substring(0, 20)}...</span>` 
                                : '<span style="color: #f97316;"> FCM not registered. Make sure device is running latest version.</span>')}
                    </div>
                    
                    <!-- Kosher Store App Updates -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;"> Kosher Store Apps</div>
                        <div id="app-updates-status" style="font-size: 13px; color: #94a3b8; margin-bottom: 8px;">
                            ${info.pendingAppUpdates ? `<span style="color: #f97316;"> ${info.pendingAppUpdates} app update(s) available</span>` : ' All apps up to date'}
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="action-btn" onclick="checkAppUpdates()" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);" title="Check for app updates">
                                 Check Updates
                            </button>
                            <button class="action-btn" onclick="updateAllApps()" style="background: linear-gradient(135deg, #f97316, #ea580c);" title="Update all apps" ${!info.pendingAppUpdates ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                 Update All
                            </button>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn ${currentTab === 'quick' ? 'active' : ''}" onclick="switchTab('quick')"> Quick</button>
                    <button class="tab-btn ${currentTab === 'blocked' ? 'active' : ''}" onclick="switchTab('blocked')"> Blocked</button>
                    <button class="tab-btn ${currentTab === 'screentime' ? 'active' : ''}" onclick="switchTab('screentime')"> Screen Time</button>
                    <button class="tab-btn ${currentTab === 'store' ? 'active' : ''}" onclick="switchTab('store')"> Store</button>
                    <button class="tab-btn ${currentTab === 'apps' ? 'active' : ''}" onclick="switchTab('apps')"> Apps</button>
                    <button class="tab-btn ${currentTab === 'config' ? 'active' : ''}" onclick="switchTab('config')"> Config</button>
                    <button class="tab-btn ${currentTab === 'log' ? 'active' : ''}" onclick="switchTab('log')"> Log</button>
                </div>

                <div class="tab-content ${currentTab === 'quick' ? 'active' : ''}" id="tab-quick">
                    ${renderQuickTab(settings)}
                </div>
                <div class="tab-content ${currentTab === 'blocked' ? 'active' : ''}" id="tab-blocked">
                    ${renderBlockedTab(logs)}
                </div>
                <div class="tab-content ${currentTab === 'screentime' ? 'active' : ''}" id="tab-screentime">
                    ${renderScreenTimeTab(device)}
                </div>
                <div class="tab-content ${currentTab === 'store' ? 'active' : ''}" id="tab-store">
                    ${renderStoreTab(device.approved_apps || {}, deviceId)}
                </div>
                <div class="tab-content ${currentTab === 'apps' ? 'active' : ''}" id="tab-apps">
                    ${renderAppsTab(apps)}
                </div>
                <div class="tab-content ${currentTab === 'config' ? 'active' : ''}" id="tab-config">
                    ${renderConfigTab(info, settings, deviceId)}
                </div>
                <div class="tab-content ${currentTab === 'log' ? 'active' : ''}" id="tab-log">
                    ${renderLogTab(logs)}
                </div>
            `;
            
            // Load existing screenshot if any
            loadLatestScreenshot();
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                const tabs = ['quick', 'blocked', 'screentime', 'store', 'apps', 'config', 'log'];
                btn.classList.toggle('active', tabs[i] === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // =====================================================
        // TAB RENDERERS
        // =====================================================
        
        // App Store Tab - Manage approved apps for kids
        function renderStoreTab(approvedApps, deviceId) {
            const deviceApps = Object.entries(approvedApps || {});
            
            let html = `
                <div class="card">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> Global Apps (All Devices)</span>
                        <button class="btn btn-success" onclick="openModal('add-global-app-modal')"> Add Global</button>
                    </div>
                    <div class="card-content" id="global-apps-list">
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
                            These apps are available on ALL devices.
                        </p>
                        <div id="global-apps-container">Loading...</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 16px;">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> Device-Specific Apps</span>
                        <button class="btn btn-primary" onclick="openModal('add-app-modal')"> Add for This Device</button>
                    </div>
                    <div class="card-content">
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
                            Apps only available on this specific device.
                        </p>
            `;

            if (deviceApps.length === 0) {
                html += '<div style="text-align: center; padding: 20px; color: #64748b;">No device-specific apps. Click "Add for This Device" to add.</div>';
            } else {
                const grouped = {};
                deviceApps.forEach(([id, app]) => {
                    const cat = app.category || 'Other';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push({id, ...app});
                });

                for (const [category, catApps] of Object.entries(grouped)) {
                    html += '<div style="margin-top: 12px;">';
                    html += '<div style="font-weight: 600; color: #e2e8f0; margin-bottom: 8px;">' + getCategoryEmoji(category) + ' ' + category + '</div>';
                    
                    catApps.forEach(app => {
                        html += createAppRow(app, false);
                    });
                    
                    html += '</div>';
                }
            }

            html += '</div></div>';
            
            // Search Play Store section
            html += `
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header" onclick="toggleCard(this)">
                        <span class="card-title"> Search Play Store</span><span></span>
                    </div>
                    <div class="card-content collapsed">
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 12px;">
                            Search for apps on Play Store and add them to approved list.
                        </p>
                        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                            <input type="text" id="playstore-search" placeholder="Search apps..." style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white;" onkeypress="if(event.key==='Enter')searchPlayStore()">
                            <button class="btn btn-primary" onclick="searchPlayStore()">Search</button>
                        </div>
                        <div id="playstore-results"></div>
                    </div>
                </div>
            `;
            
            // Load global apps after render
            setTimeout(loadGlobalApps, 100);
            
            return html;
        }

        function createAppRow(app, isGlobal) {
            const category = app.category || 'Other';
            return `
                <div style="background: #334155; padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: #f1f5f9;">
                            ${app.name}
                            ${isGlobal ? '<span style="color: #22c55e; font-size: 11px; margin-left: 8px;"> Global</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: #94a3b8;">${app.description || app.packageName || 'No description'}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                            <span style="color: #22c55e;"> Auto-download</span>
                             <span style="color: #a78bfa;">${getCategoryEmoji(category)} ${category}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm" onclick="editAppCategory('${app.id || app.packageName?.replace(/\\./g, '_')}', ${isGlobal}, '${app.name}', '${category}')" style="background: #a78bfa;" title="Change category"></button>
                        <button class="btn btn-sm" onclick="showApkUrls('${app.packageName}', '${app.name}')" style="background: #10b981;" title="Show download URLs"></button>
                        <button class="btn btn-danger btn-sm" onclick="${isGlobal ? 'removeGlobalApp' : 'removeApprovedApp'}('${app.id}')"></button>
                    </div>
                </div>
            `;
        }

        function showApkUrls(packageName, appName) {
            const xapkUrl = `https://d.apkpure.com/b/XAPK/${packageName}?version=latest`;
            const apkUrl = `https://d.apkpure.com/b/APK/${packageName}?version=latest`;
            
            alert(` "${appName}" Download URLs\n\nWhen a phone downloads this app, it tries:\n\n1 XAPK:\n${xapkUrl}\n\n2 APK:\n${apkUrl}\n\n Phone downloads directly from APKPure!\n(Server IPs are blocked, but phone IPs work)\n\n If download fails on phone, use " APK Fixes" to add a manual override.`);
        }

        function editAppApk(appId, isGlobal, appName) {
            const newUrl = prompt(`Enter APK download URL for "${appName}":\n\n(Get it from APKMirror.com or APKPure.com)\n\nOr click Cancel and use the  button to auto-fetch`);
            if (newUrl === null) return; // Cancelled
            
            const path = isGlobal ? `app_store/global_apps/${appId}/downloadUrl` : `devices/${selectedDeviceId}/approved_apps/${appId}/downloadUrl`;
            
            database.ref(path).set(newUrl)
                .then(() => {
                    showToast('APK URL updated!');
                    if (isGlobal) loadGlobalApps();
                    else renderDeviceDetail(selectedDeviceId);
                })
                .catch(err => showToast('Failed to update', true));
        }

        function editAppCategory(appId, isGlobal, appName, currentCategory) {
            const categories = [
                'Education', 'Productivity', 'Communication', 'Utilities',
                'Games', 'Entertainment', 'Health', 'Finance', 'Music',
                'Books', 'News', 'Religious', 'Jewish', 'Torah', 'Other'
            ];
            
            let options = categories.map((cat, i) => `${i + 1}. ${getCategoryEmoji(cat)} ${cat}${cat === currentCategory ? ' (current)' : ''}`).join('\n');
            options += '\n\n0. Custom category...';
            
            const choice = prompt(`Change category for "${appName}":\n\nCurrent: ${getCategoryEmoji(currentCategory)} ${currentCategory}\n\n${options}\n\nEnter number (1-${categories.length}) or 0 for custom:`);
            
            if (choice === null) return; // Cancelled
            
            let newCategory;
            const num = parseInt(choice);
            
            if (num === 0) {
                newCategory = prompt('Enter custom category name:');
                if (!newCategory || !newCategory.trim()) return;
                newCategory = newCategory.trim();
            } else if (num >= 1 && num <= categories.length) {
                newCategory = categories[num - 1];
            } else {
                showToast('Invalid selection', true);
                return;
            }
            
            if (newCategory === currentCategory) {
                showToast('Category unchanged');
                return;
            }
            
            const path = isGlobal ? `app_store/global_apps/${appId}/category` : `devices/${selectedDeviceId}/approved_apps/${appId}/category`;
            
            database.ref(path).set(newCategory)
                .then(() => {
                    showToast(`Category changed to ${newCategory}!`);
                    if (isGlobal) loadGlobalApps();
                    else renderDeviceDetail(selectedDeviceId);
                })
                .catch(err => showToast('Failed to update category', true));
        }

        function loadGlobalApps() {
            database.ref('app_store/global_apps').once('value').then(snapshot => {
                const container = document.getElementById('global-apps-container');
                if (!container) return;
                
                const apps = snapshot.val() || {};
                const appsList = Object.entries(apps);
                
                if (appsList.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">No global apps yet.</div>';
                    return;
                }

                // Group by category
                const grouped = {};
                appsList.forEach(([id, app]) => {
                    const cat = app.category || 'Other';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push({id, ...app});
                });

                let html = '';
                for (const [category, catApps] of Object.entries(grouped).sort()) {
                    html += '<div style="margin-top: 12px;">';
                    html += '<div style="font-weight: 600; color: #e2e8f0; margin-bottom: 8px;">' + getCategoryEmoji(category) + ' ' + category + ' (' + catApps.length + ')</div>';
                    
                    catApps.forEach(app => {
                        html += createAppRow(app, true);
                    });
                    
                    html += '</div>';
                }
                container.innerHTML = html;
            }).catch(err => {
                const container = document.getElementById('global-apps-container');
                if (container) container.innerHTML = '<div style="color: #ef4444;">Failed to load global apps</div>';
            });
        }

        async function searchPlayStore() {
            const query = document.getElementById('playstore-search').value.trim();
            if (!query) return;
            
            const resultsDiv = document.getElementById('playstore-results');
            resultsDiv.innerHTML = '<div style="color: #94a3b8;"> Searching... (backend may need to wake up)</div>';
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout for slow backend
            
            try {
                const response = await fetch(`https://kosher-store-backend.onrender.com/search/${encodeURIComponent(query)}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (!data.success || !data.results.length) {
                    resultsDiv.innerHTML = `<div style="color: #64748b;">No results found. <button class="btn btn-sm" onclick="addAppByPackageName()" style="background: #475569; margin-left: 8px;"> Add by Package Name</button></div>`;
                    return;
                }
                
                let html = '';
                data.results.slice(0, 5).forEach(app => {
                    const safeName = app.name.replace(/'/g, "\\'");
                    const pkgName = app.packageName || '';
                    const hasPkg = pkgName.length > 0;
                    html += `
                        <div style="background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center;">
                            <img src="${app.icon}" style="width: 48px; height: 48px; border-radius: 8px; margin-right: 12px;" onerror="this.style.display='none'">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #f1f5f9;">${app.name}</div>
                                <div style="font-size: 11px; color: ${hasPkg ? '#94a3b8' : '#f59e0b'};">${hasPkg ? pkgName : ' Package name missing - enter manually'}</div>
                                <div style="font-size: 11px; color: #64748b;">${app.developer}  ${app.installs || 'N/A'}</div>
                            </div>
                            ${hasPkg ? 
                                `<button class="btn btn-success btn-sm" onclick="addAppFromSearch('${pkgName}', '${safeName}', '${app.icon}')"> Add</button>` :
                                `<button class="btn btn-sm" onclick="addAppManually('${safeName}', '${app.icon}')" style="background: #f59e0b;"> Lookup & Add</button>`
                            }
                        </div>
                    `;
                });
                resultsDiv.innerHTML = html;
            } catch (err) {
                clearTimeout(timeoutId);
                if (err.name === 'AbortError') {
                    resultsDiv.innerHTML = `
                        <div style="color: #f59e0b;">
                             Backend is waking up (free tier sleeps after inactivity).<br>
                            <button class="btn btn-primary btn-sm" onclick="searchPlayStore()" style="margin-top: 8px;"> Try Again</button>
                            <button class="btn btn-sm" onclick="addAppByPackageName()" style="margin-top: 8px; margin-left: 8px; background: #475569;"> Add by Package Name</button>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = `
                        <div style="color: #ef4444;">
                            Search failed: ${err.message}<br>
                            <button class="btn btn-primary btn-sm" onclick="searchPlayStore()" style="margin-top: 8px;"> Retry</button>
                        </div>
                    `;
                }
            }
        }

        async function addAppManually(name, icon) {
            // Auto-lookup the package name using the /lookup endpoint
            showToast(`Looking up package name for "${name}"...`);
            
            try {
                const response = await fetch(`https://kosher-store-backend.onrender.com/lookup/${encodeURIComponent(name)}`);
                const data = await response.json();
                
                if (data.success && data.app && data.app.packageName) {
                    // Found it! Add the app
                    showToast(` Found: ${data.app.packageName}`);
                    addAppFromSearch(data.app.packageName, name, icon);
                } else {
                    // Fallback to manual entry
                    const packageName = prompt(`Could not find package name automatically.\n\nEnter package name for "${name}":\n\nYou can find this in the Play Store URL:\nplay.google.com/store/apps/details?id=PACKAGE_NAME`);
                    if (packageName && packageName.trim()) {
                        addAppFromSearch(packageName.trim(), name, icon);
                    }
                }
            } catch (err) {
                // Fallback to manual entry on error
                const packageName = prompt(`Lookup failed. Enter package name for "${name}":\n\nYou can find this in the Play Store URL:\nplay.google.com/store/apps/details?id=PACKAGE_NAME`);
                if (packageName && packageName.trim()) {
                    addAppFromSearch(packageName.trim(), name, icon);
                }
            }
        }

        async function addAppFromSearch(packageName, name, icon) {
            const addGlobal = confirm('Add to Global Apps (all devices)?\n\nClick OK for Global, Cancel for this device only.');
            
            // No downloadUrl needed - phone constructs APKPure URL automatically!
            const appData = {
                name: name,
                packageName: packageName,
                icon: icon,
                description: '',
                category: 'Other',
                addedBy: currentUser?.email || 'dashboard',
                addedAt: firebase.database.ServerValue.TIMESTAMP
            };

            const appId = packageName.replace(/\./g, '_');
            const path = addGlobal ? `app_store/global_apps/${appId}` : `devices/${selectedDeviceId}/approved_apps/${appId}`;
            
            database.ref(path).set(appData)
                .then(() => {
                    showToast(` ${name} added! Phone will download from APKPure automatically.`);
                    if (addGlobal) loadGlobalApps();
                    else renderDeviceDetail(selectedDeviceId);
                })
                .catch(err => showToast('Failed to add app: ' + err.message, true));
        }

        function addAppByPackageName() {
            const packageName = prompt('Enter the package name:\n\nExample: com.whatsapp\n\nYou can find this in the Play Store URL:\nplay.google.com/store/apps/details?id=PACKAGE_NAME');
            
            if (!packageName || !packageName.trim()) return;
            
            const cleanPackage = packageName.trim().toLowerCase();
            
            if (!cleanPackage.includes('.')) {
                showToast('Invalid package name - should contain a dot (e.g., com.whatsapp)', true);
                return;
            }
            
            const appName = prompt(`Enter display name for "${cleanPackage}":\n\n(or leave blank to use package name)`) || cleanPackage;
            
            addAppFromSearch(cleanPackage, appName.trim(), '');
        }

        function removeGlobalApp(appId) {
            if (!confirm('Remove this app from Global list?')) return;
            
            database.ref(`app_store/global_apps/${appId}`).remove()
                .then(() => {
                    showToast('App removed from Global');
                    loadGlobalApps();
                })
                .catch(err => showToast('Failed to remove', true));
        }

        function getCategoryEmoji(category) {
            const emojis = {
                'Education': '', 'Productivity': '', 'Communication': '',
                'Utilities': '', 'Games': '', 'Entertainment': '',
                'Health': '', 'Finance': '', 'Travel': '',
                'Food': '', 'Shopping': '', 'Social': '',
                'News': '', 'Music': '', 'Photo': '',
                'Video': '', 'Books': '', 'Sports': '',
                'Weather': '', 'Other': '',
                'Religious': '', 'Jewish': '', 'Torah': '', 'Kosher': ''
            };
            return emojis[category] || '';
        }

        function toggleCustomCategory(prefix) {
            const select = document.getElementById(prefix + '-category');
            const customGroup = document.getElementById(prefix + '-custom-category-group');
            if (select.value === '__custom__') {
                customGroup.style.display = 'block';
            } else {
                customGroup.style.display = 'none';
            }
        }

        function getSelectedCategory(prefix) {
            const select = document.getElementById(prefix + '-category');
            if (select.value === '__custom__') {
                const customInput = document.getElementById(prefix + '-custom-category');
                return customInput.value.trim() || 'Other';
            }
            return select.value;
        }

        function addApprovedApp() {
            const name = document.getElementById('app-name').value.trim();
            const description = document.getElementById('app-description').value.trim();
            const category = getSelectedCategory('app');
            const downloadUrl = document.getElementById('app-download-url').value.trim();
            const playStoreUrl = document.getElementById('app-playstore-url').value.trim();
            const version = document.getElementById('app-version').value.trim();
            const size = document.getElementById('app-size').value.trim();

            if (!name) {
                showToast('Please enter app name', true);
                return;
            }

            if (!downloadUrl && !playStoreUrl) {
                showToast('Please enter download URL or Play Store link', true);
                return;
            }

            const appData = {
                name,
                description,
                category,
                downloadUrl,
                playStoreUrl,
                version,
                size,
                addedBy: currentUser?.email || 'dashboard',
                addedAt: firebase.database.ServerValue.TIMESTAMP
            };

            const appId = name.toLowerCase().replace(/[^a-z0-9]/g, '_');
            database.ref(`devices/${selectedDeviceId}/approved_apps/${appId}`).set(appData)
                .then(() => {
                    showToast('App added successfully!');
                    closeModal('add-app-modal');
                    // Clear form
                    document.getElementById('app-name').value = '';
                    document.getElementById('app-description').value = '';
                    document.getElementById('app-download-url').value = '';
                    document.getElementById('app-playstore-url').value = '';
                    document.getElementById('app-version').value = '';
                    document.getElementById('app-size').value = '';
                    document.getElementById('app-category').value = 'Education';
                    document.getElementById('app-custom-category-group').style.display = 'none';
                    // Refresh view
                    renderDeviceDetail(selectedDeviceId);
                })
                .catch(err => {
                    showToast('Failed to add app: ' + err.message, true);
                });
        }

        function removeApprovedApp(appId) {
            if (!confirm('Remove this app from the approved list?')) return;
            
            database.ref(`devices/${selectedDeviceId}/approved_apps/${appId}`).remove()
                .then(() => {
                    showToast('App removed');
                    renderDeviceDetail(selectedDeviceId);
                })
                .catch(err => {
                    showToast('Failed to remove app', true);
                });
        }

        function addGlobalApp() {
            const name = document.getElementById('global-app-name').value.trim();
            const packageName = document.getElementById('global-app-package').value.trim();
            const description = document.getElementById('global-app-description').value.trim();
            const category = getSelectedCategory('global-app');
            const downloadUrl = document.getElementById('global-app-download-url').value.trim();
            const version = document.getElementById('global-app-version').value.trim();
            const size = document.getElementById('global-app-size').value.trim();

            if (!name) {
                showToast('Please enter app name', true);
                return;
            }

            if (!downloadUrl) {
                showToast('Please enter download URL', true);
                return;
            }

            const appData = {
                name,
                packageName,
                description,
                category,
                downloadUrl,
                version,
                size,
                addedBy: currentUser?.email || 'dashboard',
                addedAt: firebase.database.ServerValue.TIMESTAMP
            };

            const appId = (packageName || name).toLowerCase().replace(/[^a-z0-9]/g, '_');
            database.ref(`app_store/global_apps/${appId}`).set(appData)
                .then(() => {
                    showToast('Global app added successfully!');
                    closeModal('add-global-app-modal');
                    // Clear form
                    document.getElementById('global-app-name').value = '';
                    document.getElementById('global-app-package').value = '';
                    document.getElementById('global-app-description').value = '';
                    document.getElementById('global-app-download-url').value = '';
                    document.getElementById('global-app-version').value = '';
                    document.getElementById('global-app-size').value = '';
                    document.getElementById('global-app-category').value = 'Education';
                    document.getElementById('global-app-custom-category-group').style.display = 'none';
                    // Refresh
                    loadGlobalApps();
                })
                .catch(err => {
                    showToast('Failed to add app: ' + err.message, true);
                });
        }

        function renderQuickTab(settings) {
            return `
                <div class="preset-grid">
                    <button class="preset-btn" onclick="applyPreset('strict')"><div class="preset-icon"></div><div class="preset-name">Strict</div></button>
                    <button class="preset-btn" onclick="applyPreset('recommended')"><div class="preset-icon"></div><div class="preset-name">Recommended</div></button>
                    <button class="preset-btn" onclick="applyPreset('light')"><div class="preset-icon"></div><div class="preset-name">Light</div></button>
                    <button class="preset-btn" onclick="applyPreset('off')"><div class="preset-icon"></div><div class="preset-name">Off</div></button>
                </div>

                <div class="card">
                    <div class="card-header" style="cursor:default;">
                        <span class="card-title"> MASTER WEB BLOCK</span>
                        ${renderToggle('master_web_block', settings)}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <span class="card-title"> WEBSITE WHITELIST</span><span></span>
                    </div>
                    <div class="card-content">
                        ${renderToggleRow('whitelist_mode_enabled', settings, ' Enable Whitelist Mode (block ALL websites except allowed)')}
                        <div style="padding: 10px 0; color: #94a3b8; font-size: 12px;">
                            When enabled, ALL websites are blocked except those you add below.
                        </div>
                        
                        <div style="margin-top: 12px; padding: 12px; background: #1e293b; border-radius: 8px;">
                            <div style="font-weight: 600; color: #10B981; margin-bottom: 8px;"> Allowed Websites</div>
                            <div id="allowed-websites-list" style="margin-bottom: 12px;">
                                ${renderAllowedWebsites(settings.allowed_websites || [])}
                            </div>
                            
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="new-allowed-website" placeholder="e.g. google.com" 
                                    style="flex: 1; padding: 8px 12px; border-radius: 6px; border: 1px solid #334155; background: #0f172a; color: white; font-size: 13px;"
                                    onkeypress="if(event.key==='Enter')addAllowedWebsiteFromDashboard()">
                                <button class="btn btn-success" onclick="addAllowedWebsiteFromDashboard()" style="padding: 8px 16px;">+ Add</button>
                            </div>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">
                                <button class="btn" onclick="quickAddWebsite('google.com')" style="background: #334155; font-size: 11px; padding: 4px 8px;">+google</button>
                                <button class="btn" onclick="quickAddWebsite('gmail.com')" style="background: #334155; font-size: 11px; padding: 4px 8px;">+gmail</button>
                                <button class="btn" onclick="quickAddWebsite('drive.google.com')" style="background: #334155; font-size: 11px; padding: 4px 8px;">+drive</button>
                                <button class="btn" onclick="quickAddWebsite('docs.google.com')" style="background: #334155; font-size: 11px; padding: 4px 8px;">+docs</button>
                                <button class="btn" onclick="quickAddWebsite('maps.google.com')" style="background: #334155; font-size: 11px; padding: 4px 8px;">+maps</button>
                                <button class="btn" onclick="quickAddWebsite('weather.com')" style="background: #334155; font-size: 11px; padding: 4px 8px;">+weather</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <span class="card-title"> CRITICAL SECURITY</span><span></span>
                    </div>
                    <div class="card-content">
                        ${renderToggleRow('block_factory_reset', settings, ' Block Factory Reset')}
                        ${renderToggleRow('block_safe_mode', settings, ' Block Safe Mode')}
                        ${renderToggleRow('block_developer_options', settings, ' Block Developer Options')}
                        ${renderToggleRow('block_adb', settings, ' Block ADB')}
                        ${renderToggleRow('block_multiple_users', settings, ' Block Multiple Users')}
                        ${renderToggleRow('block_app_data_reset', settings, ' Block App Data Reset')}
                        ${renderToggleRow('block_smart_lock', settings, ' Block Smart Lock')}
                        ${renderToggleRow('block_assistant', settings, ' Block Assistant')}
                        ${renderToggleRow('block_default_apps', settings, ' Block Default App Changes')}
                        ${renderToggleRow('block_accessibility_settings', settings, ' Block Accessibility Settings')}
                        ${renderToggleRow('block_all_settings', settings, ' Block All Settings Access')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                        <span class="card-title"> WHATSAPP & CONTENT</span><span></span>
                    </div>
                    <div class="card-content">
                        ${renderToggleRow('blockWhatsAppChannels', settings, ' Block WhatsApp Channels')}
                        ${renderToggleRow('blockMetaAI', settings, ' Block Meta AI')}
                        ${renderToggleRow('block_youtube_everywhere', settings, ' Block YouTube Everywhere', true)}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                        <span class="card-title"> DNS FILTERING</span><span></span>
                    </div>
                    <div class="card-content">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 13px; color: #94a3b8; margin-bottom: 8px;">Private DNS Address</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="dns-hostname-input" class="text-input" style="flex: 1;" 
                                       placeholder="e.g., 1.1.1.3 or family.cloudflare-dns.com" 
                                       value="${settings.dns_provider || ''}"
                                       onkeypress="if(event.key==='Enter') applyDns()">
                                <button class="btn btn-primary" onclick="applyDns()" style="white-space: nowrap;">Apply</button>
                            </div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 8px;">
                                Enter hostname or IP address. Common IPs auto-convert to hostnames. Leave empty to disable.
                            </div>
                            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">
                                Examples: <span style="color: #94a3b8; cursor: pointer;" onclick="setDnsExample('1.1.1.3')">1.1.1.3</span>  
                                <span style="color: #94a3b8; cursor: pointer;" onclick="setDnsExample('9.9.9.9')">9.9.9.9</span>  
                                <span style="color: #94a3b8; cursor: pointer;" onclick="setDnsExample('family.cloudflare-dns.com')">family.cloudflare-dns.com</span>  
                                <span style="color: #94a3b8; cursor: pointer;" onclick="setDnsExample('dns.adguard-dns.com')">dns.adguard-dns.com</span>
                            </div>
                        </div>
                        <div style="border-top: 1px solid #334155; padding-top: 12px;">
                            ${renderToggleRow('lock_dns_settings', settings, ' Lock DNS Settings (Prevent Changes)')}
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <span class="card-title"> IMPORTANT</span><span></span>
                    </div>
                    <div class="card-content collapsed">
                        ${renderToggleRow('block_play_store', settings, ' Block Play Store')}
                        ${renderToggleRow('block_apk_install', settings, ' Block APK Install')}
                        ${renderToggleRow('block_alt_stores', settings, ' Block Alt App Stores')}
                        ${renderToggleRow('block_vpn', settings, ' Block VPN Apps')}
                        ${renderToggleRow('block_proxy_dns', settings, ' Block Proxy/DNS Apps')}
                        ${renderToggleRow('block_social_media', settings, ' Block Social Media')}
                        ${renderToggleRow('block_google_app', settings, ' Block Google App')}
                        ${renderToggleRow('block_browsers', settings, ' Block All Browsers')}
                        ${renderToggleRow('block_work_profile', settings, ' Block Work Profile')}
                        ${renderToggleRow('block_battery_opt', settings, ' Block Battery Optimization')}
                        ${renderToggleRow('block_airplane_mode', settings, ' Block Airplane Mode')}
                        ${renderToggleRow('block_datetime', settings, ' Block Date/Time Changes')}
                        ${renderToggleRow('block_messaging', settings, ' Block Messaging Apps')}
                        ${renderToggleRow('block_usb_devices', settings, ' Block USB Devices')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <span class="card-title"> BYPASS PROTECTION</span><span></span>
                    </div>
                    <div class="card-content collapsed">
                        ${renderToggleRow('block_secure_folder', settings, ' Block Secure Folder')}
                        ${renderToggleRow('block_guest_mode', settings, ' Block Guest Mode')}
                        ${renderToggleRow('block_screen_recording', settings, ' Block Screen Recording')}
                        ${renderToggleRow('block_google_docs', settings, ' Block Google Docs')}
                        ${renderToggleRow('block_contacts_app', settings, ' Block Contacts App')}
                        ${renderToggleRow('block_all_accessibility', settings, ' Block All Accessibility')}
                        ${renderToggleRow('block_backup_restore', settings, ' Block Backup/Restore')}
                        ${renderToggleRow('block_location_spoofing', settings, ' Block Location Spoofing')}
                        ${renderToggleRow('block_casting', settings, ' Block Casting/Mirroring')}
                        ${renderToggleRow('block_printing', settings, ' Block Printing')}
                        ${renderToggleRow('block_ui_tuner', settings, ' Block UI Tuner')}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <span class="card-title"> ADDITIONAL</span><span></span>
                    </div>
                    <div class="card-content collapsed">
                        ${renderToggleRow('block_file_managers', settings, ' Block File Managers')}
                        ${renderToggleRow('block_bluetooth', settings, ' Block Bluetooth Transfer')}
                        ${renderToggleRow('block_usb', settings, ' Block USB Transfer')}
                        ${renderToggleRow('block_hotspot', settings, ' Block Hotspot')}
                        ${renderToggleRow('block_quick_settings', settings, ' Block Quick Settings')}
                        ${renderToggleRow('block_other_accessibility', settings, ' Block Accessibility Apps')}
                    </div>
                </div>
            `;
        }

        // NEW: Blocked Attempts Tab
        function renderBlockedTab(logs) {
            const blockedLogs = Object.values(logs)
                .filter(l => l.action && (
                    l.action.toLowerCase().includes('blocked') || 
                    l.action.toLowerCase().includes('denied') || 
                    l.action.toLowerCase().includes('prevented') ||
                    l.action.toLowerCase().includes('tried') ||
                    l.action.toLowerCase().includes('attempt')
                ))
                .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            let html = `
                <div class="card">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> Blocked Attempts (${blockedLogs.length})</span>
                    </div>
                    <div class="card-content" style="max-height: 500px; overflow-y: auto; padding: 0;">
            `;

            if (blockedLogs.length === 0) {
                return html + '<div style="text-align: center; padding: 40px; color: #64748b;"> No blocked attempts recorded</div></div></div>';
            }

            return html + blockedLogs.slice(0, 50).map(log => {
                const time = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Unknown';
                const icon = getBlockedIcon(log.action);
                return `
                    <div class="blocked-attempt">
                        <span class="blocked-attempt-icon">${icon}</span>
                        <div class="blocked-attempt-text">
                            <div class="blocked-attempt-action">${log.action || 'Unknown action'}</div>
                            <div class="blocked-attempt-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('') + '</div></div>';
        }

        function getBlockedIcon(action) {
            const a = (action || '').toLowerCase();
            if (a.includes('browser') || a.includes('chrome') || a.includes('web')) return '';
            if (a.includes('app') || a.includes('install')) return '';
            if (a.includes('settings') || a.includes('developer')) return '';
            if (a.includes('vpn') || a.includes('proxy')) return '';
            if (a.includes('youtube') || a.includes('tiktok') || a.includes('social')) return '';
            if (a.includes('pin') || a.includes('password')) return '';
            if (a.includes('factory') || a.includes('reset')) return '';
            return '';
        }

        function renderAppsTab(apps) {
            const categories = Object.keys(apps);
            
            let html = `
                <div style="margin-bottom: 16px;">
                    <button class="btn btn-primary" onclick="requestAppList()"> Refresh App List</button>
                </div>
            `;

            if (categories.length === 0) {
                return html + '<div class="card"><div class="card-content" style="text-align: center; padding: 40px; color: #64748b;">No apps data. Click "Refresh App List" to load.</div></div>';
            }

            return html + categories.map(category => {
                const appList = apps[category] || [];
                const hiddenCount = appList.filter(a => a.isHidden).length;
                
                return `
                    <div class="app-category">
                        <div class="app-category-header" onclick="toggleAppCategory(this)">
                            <span>${category} (${appList.length} apps, ${hiddenCount} hidden)</span>
                            <span></span>
                        </div>
                        <div class="app-list">
                            ${appList.map(app => `
                                <div class="app-item">
                                    <div>
                                        <div class="app-name">${app.name} ${app.isHidden ? '' : ''}</div>
                                        <div class="app-package">${app.packageName}</div>
                                    </div>
                                    <label class="toggle">
                                        <input type="checkbox" ${app.isHidden ? 'checked' : ''} onchange="toggleApp('${app.packageName}', this.checked)">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderConfigTab(info, settings, deviceId) {
            return `
                <div class="config-section">
                    <div class="config-title"> Device Settings</div>
                    <div class="config-row">
                        <span class="config-label">Device Name</span>
                        <span class="config-value">${info.name || 'Unnamed'}</span>
                    </div>
                    <button class="config-btn" onclick="openRenameModal('${info.name || ''}')">Rename Device</button>
                </div>

                <div class="config-section">
                    <div class="config-title"> Security</div>
                    <div class="config-row">
                        <span class="config-label">Failed PIN Attempts</span>
                        <span class="config-value">${info.failedPinAttempts || 0}</span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Device Owner</span>
                        <span class="config-value">${info.isDeviceOwner ? ' Yes' : ' No'}</span>
                    </div>
                    <button class="config-btn" onclick="openModal('pin-modal')">Reset Device PIN</button>
                    <button class="config-btn" onclick="clearLockout()" style="margin-left: 8px; background: #22c55e;">Clear Lockout</button>
                </div>

                <div class="config-section">
                    <div class="config-title"> Updates</div>
                    <div class="config-row">
                        <span class="config-label">App Version</span>
                        <span class="config-value">${info.appVersion || '?'}</span>
                    </div>
                    <div class="config-row">
                        <span class="config-label">Update Status</span>
                        <span class="config-value">${settings.update_available ? ' Pending' : ' Up to date'}</span>
                    </div>
                    <button class="config-btn" onclick="sendCommand('check_update')" style="background: #8b5cf6;">Push Update</button>
                </div>

                <div class="config-section">
                    <div class="config-title"> Device Info</div>
                    <div class="config-row"><span class="config-label">Model</span><span class="config-value">${info.model || 'Unknown'}</span></div>
                    <div class="config-row"><span class="config-label">Android</span><span class="config-value">${info.androidVersion || '?'}</span></div>
                    <div class="config-row"><span class="config-label">Last Seen</span><span class="config-value">${formatLastSeen(info.lastSeen)}</span></div>
                    <div class="config-row"><span class="config-label">Storage</span><span class="config-value">${info.storage ? Math.round(info.storage) + ' MB' : '?'}</span></div>
                </div>

                <div class="config-section">
                    <div class="config-title"> Sync</div>
                    <button class="config-btn" onclick="forceSync()">Force Sync Settings</button>
                    <button class="config-btn" onclick="sendCommand('get_status')" style="margin-left: 8px; background: #475569;">Get Status</button>
                </div>

                <div class="config-section" style="border-color: #ef4444;">
                    <div class="config-title" style="color: #ef4444;"> Danger Zone</div>
                    <button class="config-btn danger" onclick="removeDeviceFromDashboard('${deviceId}')">Remove from Dashboard</button>
                </div>
            `;
        }

        function renderLogTab(logs) {
            const logEntries = Object.values(logs).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            let html = `
                <div class="card">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> Activity Log (${logEntries.length})</span>
                        <button class="btn btn-sm" onclick="clearLogs()" style="background: #ef4444;">Clear</button>
                    </div>
                    <div class="card-content" style="max-height: 500px; overflow-y: auto;">
            `;

            if (logEntries.length === 0) {
                return html + '<div style="text-align: center; padding: 20px; color: #64748b;">No logs yet</div></div></div>';
            }

            return html + logEntries.slice(0, 100).map(log => {
                const time = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Unknown';
                let sourceClass = 'log-local';
                if (log.source === 'remote') sourceClass = 'log-remote';
                else if (log.source === 'system') sourceClass = 'log-system';
                else if ((log.action || '').toLowerCase().includes('block')) sourceClass = 'log-blocked';
                
                return `
                    <div class="log-entry">
                        <div class="log-time">${time}</div>
                        <div class="log-action">${log.action || 'Unknown'}<span class="log-source ${sourceClass}">${log.source || 'local'}</span></div>
                    </div>
                `;
            }).join('') + '</div></div>';
        }

        function renderToggle(key, settings) {
            const checked = settings[key] === true;
            return `
                <label class="toggle">
                    <input type="checkbox" ${checked ? 'checked' : ''} onchange="updateSetting('${key}', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            `;
        }

        function renderToggleRow(key, settings, label, defaultValue = false) {
            // If setting doesn't exist, use default value
            const checked = settings[key] !== undefined ? settings[key] === true : defaultValue;
            return `
                <div class="toggle-row">
                    <span class="toggle-label">${label}</span>
                    <label class="toggle">
                        <input type="checkbox" ${checked ? 'checked' : ''} onchange="updateSetting('${key}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
        }

        // =====================================================
        // UI HELPERS
        // =====================================================
        function toggleCard(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span:last-child');
            content.classList.toggle('collapsed');
            arrow.textContent = content.classList.contains('collapsed') ? '' : '';
        }

        function toggleAppCategory(header) {
            const list = header.nextElementSibling;
            const arrow = header.querySelector('span:last-child');
            list.classList.toggle('expanded');
            arrow.textContent = list.classList.contains('expanded') ? '' : '';
        }

        // =====================================================
        // COMMANDS & ACTIONS
        // =====================================================
        // =====================================================
        // WEBSITE WHITELIST MANAGEMENT
        // =====================================================
        
        function renderAllowedWebsites(websites) {
            if (!websites || websites.length === 0) {
                return '<div style="color: #EF4444; font-size: 12px; padding: 8px;"> No websites allowed - ALL sites will be blocked!</div>';
            }
            
            return websites.map(site => `
                <div style="display: inline-flex; align-items: center; background: #10B981; color: white; padding: 4px 8px; border-radius: 4px; margin: 2px; font-size: 12px;">
                    <span> ${site}</span>
                    <button onclick="removeAllowedWebsiteFromDashboard('${site}')" style="background: none; border: none; color: white; margin-left: 6px; cursor: pointer; font-size: 14px;"></button>
                </div>
            `).join('');
        }
        
        function addAllowedWebsiteFromDashboard() {
            const input = document.getElementById('new-allowed-website');
            let website = input.value.trim().toLowerCase()
                .replace(/^https?:\/\//, '')
                .replace(/^www\./, '');
            
            if (!website || !website.includes('.')) {
                showToast('Enter a valid website (e.g. google.com)', true);
                return;
            }
            
            // Get current allowed websites
            const device = devicesData[selectedDeviceId];
            const settings = device?.settings || {};
            let allowedWebsites = settings.allowed_websites || [];
            
            if (!Array.isArray(allowedWebsites)) {
                allowedWebsites = [];
            }
            
            if (allowedWebsites.includes(website)) {
                showToast('Website already in whitelist', true);
                return;
            }
            
            allowedWebsites.push(website);
            
            // Save to Firebase
            database.ref(`devices/${selectedDeviceId}/settings/allowed_websites`).set(allowedWebsites)
                .then(() => {
                    showToast(` Added ${website} to whitelist`);
                    input.value = '';
                    // Refresh the list
                    document.getElementById('allowed-websites-list').innerHTML = renderAllowedWebsites(allowedWebsites);
                })
                .catch(err => {
                    showToast('Failed to add website: ' + err.message, true);
                });
        }
        
        function removeAllowedWebsiteFromDashboard(website) {
            const device = devicesData[selectedDeviceId];
            const settings = device?.settings || {};
            let allowedWebsites = settings.allowed_websites || [];
            
            if (!Array.isArray(allowedWebsites)) {
                allowedWebsites = [];
            }
            
            allowedWebsites = allowedWebsites.filter(w => w !== website);
            
            // Save to Firebase
            database.ref(`devices/${selectedDeviceId}/settings/allowed_websites`).set(allowedWebsites)
                .then(() => {
                    showToast(`Removed ${website} from whitelist`);
                    // Refresh the list
                    document.getElementById('allowed-websites-list').innerHTML = renderAllowedWebsites(allowedWebsites);
                })
                .catch(err => {
                    showToast('Failed to remove website: ' + err.message, true);
                });
        }
        
        function quickAddWebsite(website) {
            const device = devicesData[selectedDeviceId];
            const settings = device?.settings || {};
            let allowedWebsites = settings.allowed_websites || [];
            
            if (!Array.isArray(allowedWebsites)) {
                allowedWebsites = [];
            }
            
            if (allowedWebsites.includes(website)) {
                showToast('Website already in whitelist', true);
                return;
            }
            
            allowedWebsites.push(website);
            
            database.ref(`devices/${selectedDeviceId}/settings/allowed_websites`).set(allowedWebsites)
                .then(() => {
                    showToast(` Added ${website}`);
                    document.getElementById('allowed-websites-list').innerHTML = renderAllowedWebsites(allowedWebsites);
                })
                .catch(err => showToast('Failed: ' + err.message, true));
        }

        async function sendCommand(action, data = {}) {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            // Create command object
            const commandData = {
                action,
                ...data,
                status: 'pending',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            
            // Sign the command
            const signature = await signCommand({
                action: action,
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            if (signature) {
                commandData.signature = signature;
            }
            
            const commandRef = database.ref(`devices/${selectedDeviceId}/commands`).push();
            commandRef.set(commandData).then(() => {
                console.log("Command sent:", action, signature ? "(signed)" : "(unsigned)");
            }).catch(err => {
                console.error("Command failed:", err);
                showToast('Failed to send command', true);
            });
        }

        function updateSetting(key, value) {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            database.ref(`devices/${selectedDeviceId}/settings/${key}`).set(value)
                .then(() => {
                    showToast(`${key.replace(/_/g, ' ')} ${value ? 'enabled' : 'disabled'}`);
                })
                .catch(err => {
                    console.error("Setting update failed:", err);
                    showToast('Failed to update setting', true);
                });
        }

        function applyDns() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            const hostname = document.getElementById('dns-hostname-input').value.trim();
            
            // Save DNS provider to settings
            database.ref(`devices/${selectedDeviceId}/settings/dns_provider`).set(hostname)
                .then(() => {
                    // Also send command to apply DNS immediately
                    return sendCommand('set_dns', { dns_hostname: hostname });
                })
                .then(() => {
                    if (hostname) {
                        showToast(`DNS set to: ${hostname}`);
                    } else {
                        showToast('DNS filtering disabled');
                    }
                })
                .catch(err => {
                    console.error("DNS update failed:", err);
                    showToast('Failed to update DNS', true);
                });
        }

        function setDnsExample(hostname) {
            document.getElementById('dns-hostname-input').value = hostname;
        }

        function toggleApp(packageName, hidden) {
            if (!selectedDeviceId) return;
            sendCommand('toggle_app', { packageName, hidden });
            showToast(`${hidden ? 'Hiding' : 'Showing'} app...`);
        }

        function requestAppList() {
            sendCommand('sync_apps');
            showToast('Requesting app list... Refresh in a few seconds');
        }

        function applyPreset(preset) {
            if (!selectedDeviceId) return;
            sendCommand('apply_preset', { preset });
            showToast(`Applying ${preset} preset...`);
        }

        function forceSync() {
            sendCommand('sync_settings');
            showToast('Forcing settings sync...');
        }

        // Push Update to All Devices - NEW
        async function confirmPushUpdate() {
            const deviceIds = Object.keys(devicesData);
            let successCount = 0;
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            // Sign once for all devices
            const signature = await signCommand({
                action: 'check_update',
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            for (const id of deviceIds) {
                try {
                    const commandRef = database.ref(`devices/${id}/commands`).push();
                    const commandData = {
                        action: 'check_update',
                        status: 'pending',
                        timestamp: timestamp,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        createdBy: createdBy
                    };
                    if (signature) commandData.signature = signature;
                    
                    await commandRef.set(commandData);
                    successCount++;
                } catch (e) {
                    console.error(`Failed for device ${id}:`, e);
                }
            }
            
            closeModal('push-update-modal');
            showToast(`Update pushed to ${successCount}/${deviceIds.length} device(s)!`);
        }

        // =====================================================
        // BULK ACTIONS - POWERFUL VERSION
        // =====================================================
        
        let selectedBulkDevices = new Set();
        let deviceGroups = {};
        let currentBulkActionType = 'settings';
        let currentBulkCommand = null;
        let currentBulkPreset = null;
        let bulkSettingsToApply = {};
        
        // All available settings
        const ALL_SETTINGS = [
            { key: 'master_web_block', label: ' Master Web Block', type: 'toggle' },
            { key: 'block_social_media', label: ' Social Media', type: 'toggle' },
            { key: 'block_youtube', label: ' YouTube', type: 'toggle' },
            { key: 'block_play_store', label: ' Play Store', type: 'toggle' },
            { key: 'block_browsers', label: ' Browsers', type: 'toggle' },
            { key: 'block_vpn', label: ' VPN Apps', type: 'toggle' },
            { key: 'block_incognito', label: ' Incognito Mode', type: 'toggle' },
            { key: 'block_new_apps', label: ' New App Install', type: 'toggle' },
            { key: 'block_settings', label: ' Settings Access', type: 'toggle' },
            { key: 'block_developer_options', label: ' Developer Options', type: 'toggle' },
            { key: 'block_usb_transfer', label: ' USB Transfer', type: 'toggle' },
            { key: 'block_bluetooth', label: ' Bluetooth', type: 'toggle' },
            { key: 'block_hotspot', label: ' Hotspot', type: 'toggle' },
            { key: 'block_screen_capture', label: ' Screen Capture', type: 'toggle' },
            { key: 'block_gaming', label: ' Gaming Apps', type: 'toggle' },
            { key: 'block_entertainment', label: ' Entertainment', type: 'toggle' },
            { key: 'block_messaging', label: ' Messaging Apps', type: 'toggle' },
            { key: 'block_dating', label: ' Dating Apps', type: 'toggle' },
            { key: 'safe_search', label: ' Safe Search', type: 'toggle' },
            { key: 'block_app_stores', label: ' Alt App Stores', type: 'toggle' }
        ];
        
        function openBulkActionsModal() {
            selectedBulkDevices.clear();
            currentBulkCommand = null;
            currentBulkPreset = null;
            bulkSettingsToApply = {};
            
            loadDeviceGroups();
            renderBulkDeviceList();
            renderBulkGroupButtons();
            renderBulkSettingsGrid();
            updateBulkUI();
            switchBulkTab('select');
            
            openModal('bulk-actions-modal');
        }
        
        // === TAB SWITCHING ===
        function switchBulkTab(tab) {
            document.querySelectorAll('.bulk-tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });
            document.querySelectorAll('.bulk-tab-content').forEach(content => {
                content.style.display = 'none';
                content.classList.remove('active');
            });
            const tabContent = document.getElementById(`bulk-tab-${tab}`);
            if (tabContent) {
                tabContent.style.display = 'block';
                tabContent.classList.add('active');
            }
            
            // Refresh groups list when switching to groups tab
            if (tab === 'groups') {
                renderDeviceGroupsList();
            }
            
            // Show/hide action content based on selection
            if (tab === 'actions') {
                updateBulkActionsVisibility();
            }
        }
        
        // === DEVICE SELECTION ===
        function renderBulkDeviceList() {
            const container = document.getElementById('bulk-device-list');
            const deviceIds = Object.keys(devicesData);
            
            if (deviceIds.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No devices available</div>';
                return;
            }
            
            container.innerHTML = deviceIds.map(id => {
                const device = devicesData[id];
                const info = device.info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                const isUninstalled = info.status === 'uninstalled';
                const isSelected = selectedBulkDevices.has(id);
                
                if (isUninstalled) return '';
                
                // Find which groups this device belongs to
                const deviceGroupNames = Object.entries(deviceGroups)
                    .filter(([gid, g]) => g.devices && g.devices.includes(id))
                    .map(([gid, g]) => g.name)
                    .join(', ');
                
                return `
                    <div class="bulk-device-item ${isSelected ? 'selected' : ''}" 
                         data-device-id="${id}" 
                         data-name="${(info.name || '').toLowerCase()}"
                         onclick="toggleBulkDevice('${id}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} style="margin-right: 10px; pointer-events: none;">
                        <span class="status-dot ${isOnline ? 'status-online' : 'status-offline'}" style="width: 10px; height: 10px; margin-right: 10px;"></span>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #e2e8f0;">${info.name || 'Unnamed Device'}</div>
                            <div style="font-size: 11px; color: #64748b;">${info.model || ''} ${deviceGroupNames ? ' ' + deviceGroupNames : ''}</div>
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');
        }
        
        function toggleBulkDevice(deviceId) {
            if (selectedBulkDevices.has(deviceId)) {
                selectedBulkDevices.delete(deviceId);
            } else {
                selectedBulkDevices.add(deviceId);
            }
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function bulkSelectAll() {
            Object.keys(devicesData).forEach(id => {
                const info = devicesData[id].info || {};
                if (info.status !== 'uninstalled') {
                    selectedBulkDevices.add(id);
                }
            });
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function bulkSelectNone() {
            selectedBulkDevices.clear();
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function bulkSelectOnline() {
            selectedBulkDevices.clear();
            Object.keys(devicesData).forEach(id => {
                const info = devicesData[id].info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                if (isOnline && info.status !== 'uninstalled') {
                    selectedBulkDevices.add(id);
                }
            });
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function bulkSelectOffline() {
            selectedBulkDevices.clear();
            Object.keys(devicesData).forEach(id => {
                const info = devicesData[id].info || {};
                const isOnline = info.online && (Date.now() - (info.lastSeen || 0)) < 60000;
                if (!isOnline && info.status !== 'uninstalled') {
                    selectedBulkDevices.add(id);
                }
            });
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function bulkInvertSelection() {
            Object.keys(devicesData).forEach(id => {
                const info = devicesData[id].info || {};
                if (info.status !== 'uninstalled') {
                    if (selectedBulkDevices.has(id)) {
                        selectedBulkDevices.delete(id);
                    } else {
                        selectedBulkDevices.add(id);
                    }
                }
            });
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function bulkSelectByGroup(groupId) {
            const group = deviceGroups[groupId];
            if (!group || !group.devices) return;
            
            group.devices.forEach(deviceId => {
                if (devicesData[deviceId]) {
                    selectedBulkDevices.add(deviceId);
                }
            });
            renderBulkDeviceList();
            updateBulkUI();
        }
        
        function filterBulkDevices() {
            const search = document.getElementById('bulk-device-search').value.toLowerCase();
            document.querySelectorAll('.bulk-device-item').forEach(item => {
                const name = item.dataset.name || '';
                item.style.display = name.includes(search) ? 'flex' : 'none';
            });
        }
        
        // === DEVICE GROUPS ===
        function loadDeviceGroups() {
            database.ref('device_groups').once('value').then(snapshot => {
                deviceGroups = snapshot.val() || {};
                renderBulkGroupButtons();
            });
        }
        
        function renderBulkGroupButtons() {
            const container = document.getElementById('bulk-group-buttons');
            const groups = Object.entries(deviceGroups);
            
            if (groups.length === 0) {
                container.innerHTML = '<span style="color: #64748b; font-size: 12px;">No groups created yet. Go to Groups tab to create.</span>';
                return;
            }
            
            container.innerHTML = groups.map(([id, group]) => `
                <button class="btn btn-sm" onclick="bulkSelectByGroup('${id}')" style="background: #475569;">
                     ${group.name} (${(group.devices || []).length})
                </button>
            `).join('');
        }
        
        function renderDeviceGroupsList() {
            const container = document.getElementById('device-groups-list');
            const groups = Object.entries(deviceGroups);
            
            if (groups.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 12px;"></div>
                        <div>No groups yet</div>
                        <div style="font-size: 12px; margin-top: 4px;">Create a group to quickly select multiple devices</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = groups.map(([id, group]) => {
                const deviceNames = (group.devices || []).map(did => {
                    const d = devicesData[did];
                    return d ? (d.info?.name || 'Unknown') : null;
                }).filter(Boolean);
                
                return `
                    <div class="device-group-card">
                        <div class="group-header">
                            <span class="group-name"> ${group.name}</span>
                            <div>
                                <button class="btn btn-sm" onclick="editDeviceGroup('${id}')" style="background: #3b82f6; margin-right: 4px;"> Edit</button>
                                <button class="btn btn-sm" onclick="bulkSelectByGroup('${id}'); switchBulkTab('select');" style="background: #22c55e;">Select All</button>
                            </div>
                        </div>
                        <div class="group-count">${deviceNames.length} device(s)</div>
                        <div class="group-devices">
                            ${deviceNames.length > 0 
                                ? deviceNames.slice(0, 10).map(n => `<span class="group-device-tag">${n}</span>`).join('') + (deviceNames.length > 10 ? `<span class="group-device-tag">+${deviceNames.length - 10} more</span>` : '')
                                : '<span style="color: #64748b; font-size: 12px;">No devices in group</span>'
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function createDeviceGroup() {
            const name = document.getElementById('new-group-name').value.trim();
            if (!name) {
                showToast('Please enter a group name', true);
                return;
            }
            
            const groupId = 'group_' + Date.now();
            database.ref(`device_groups/${groupId}`).set({
                name: name,
                devices: Array.from(selectedBulkDevices),
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showToast(` Group "${name}" created with ${selectedBulkDevices.size} device(s)`);
                document.getElementById('new-group-name').value = '';
                loadDeviceGroups();
                renderDeviceGroupsList();
            }).catch(err => showToast('Failed to create group', true));
        }
        
        function editDeviceGroup(groupId) {
            const group = deviceGroups[groupId];
            if (!group) return;
            
            document.getElementById('edit-group-id').value = groupId;
            document.getElementById('edit-group-name').value = group.name;
            document.getElementById('edit-group-title').textContent = ` Edit Group: ${group.name}`;
            
            // Render device checkboxes
            const container = document.getElementById('edit-group-devices');
            const deviceIds = Object.keys(devicesData);
            const groupDevices = group.devices || [];
            
            container.innerHTML = deviceIds.map(id => {
                const device = devicesData[id];
                const info = device.info || {};
                if (info.status === 'uninstalled') return '';
                
                const isInGroup = groupDevices.includes(id);
                return `
                    <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; ${isInGroup ? 'background: rgba(34, 197, 94, 0.15);' : ''}" 
                           onmouseover="this.style.background='rgba(99, 102, 241, 0.1)'" 
                           onmouseout="this.style.background='${isInGroup ? 'rgba(34, 197, 94, 0.15)' : 'transparent'}'">
                        <input type="checkbox" class="edit-group-device-cb" data-device-id="${id}" ${isInGroup ? 'checked' : ''} style="margin-right: 10px;">
                        <span style="flex: 1;">${info.name || 'Unnamed'}</span>
                        <span style="font-size: 11px; color: #64748b;">${info.model || ''}</span>
                    </label>
                `;
            }).filter(Boolean).join('');
            
            openModal('edit-group-modal');
        }
        
        function saveDeviceGroup() {
            const groupId = document.getElementById('edit-group-id').value;
            const name = document.getElementById('edit-group-name').value.trim();
            
            if (!name) {
                showToast('Please enter a group name', true);
                return;
            }
            
            const selectedDevices = [];
            document.querySelectorAll('.edit-group-device-cb:checked').forEach(cb => {
                selectedDevices.push(cb.dataset.deviceId);
            });
            
            database.ref(`device_groups/${groupId}`).update({
                name: name,
                devices: selectedDevices,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                showToast(' Group updated');
                closeModal('edit-group-modal');
                loadDeviceGroups();
                renderDeviceGroupsList();
            }).catch(err => showToast('Failed to save group', true));
        }
        
        function deleteDeviceGroup() {
            const groupId = document.getElementById('edit-group-id').value;
            const group = deviceGroups[groupId];
            
            if (!confirm(`Delete group "${group?.name}"?`)) return;
            
            database.ref(`device_groups/${groupId}`).remove().then(() => {
                showToast('Group deleted');
                closeModal('edit-group-modal');
                loadDeviceGroups();
                renderDeviceGroupsList();
            }).catch(err => showToast('Failed to delete', true));
        }
        
        // === ACTION SELECTION ===
        function selectBulkActionType(type) {
            currentBulkActionType = type;
            
            document.querySelectorAll('.bulk-action-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
            
            document.getElementById('bulk-settings-panel').style.display = type === 'settings' ? 'block' : 'none';
            document.getElementById('bulk-command-panel').style.display = type === 'command' ? 'block' : 'none';
            document.getElementById('bulk-preset-panel').style.display = type === 'preset' ? 'block' : 'none';
            
            updateBulkUI();
        }
        
        function renderBulkSettingsGrid() {
            const container = document.getElementById('bulk-settings-grid');
            container.innerHTML = ALL_SETTINGS.map(setting => `
                <div class="bulk-setting-item">
                    <input type="checkbox" id="bulk-setting-${setting.key}" data-key="${setting.key}" onchange="updateBulkSettingSelection()">
                    <label for="bulk-setting-${setting.key}" style="flex: 1; cursor: pointer; color: #e2e8f0; font-size: 13px;">${setting.label}</label>
                    <select id="bulk-setting-value-${setting.key}" style="width: 70px;">
                        <option value="true">ON</option>
                        <option value="false">OFF</option>
                    </select>
                </div>
            `).join('');
        }
        
        function bulkSettingsSelectAll() {
            document.querySelectorAll('#bulk-settings-grid input[type="checkbox"]').forEach(cb => cb.checked = true);
            updateBulkSettingSelection();
        }
        
        function bulkSettingsSelectNone() {
            document.querySelectorAll('#bulk-settings-grid input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateBulkSettingSelection();
        }
        
        function updateBulkSettingSelection() {
            bulkSettingsToApply = {};
            document.querySelectorAll('#bulk-settings-grid input[type="checkbox"]:checked').forEach(cb => {
                const key = cb.dataset.key;
                const value = document.getElementById(`bulk-setting-value-${key}`).value === 'true';
                bulkSettingsToApply[key] = value;
            });
            updateBulkUI();
        }
        
        function selectBulkCommand(command) {
            if (!command) return;
            currentBulkCommand = command;
            
            document.querySelectorAll('.bulk-command-btn').forEach(btn => btn.classList.remove('selected'));
            event?.target?.classList?.add('selected');
            
            document.getElementById('bulk-selected-command').style.display = 'block';
            document.getElementById('bulk-command-name').textContent = command;
            
            updateBulkUI();
        }
        
        function selectBulkPreset(preset) {
            currentBulkPreset = preset;
            
            document.querySelectorAll('.bulk-preset-btn').forEach(btn => btn.classList.remove('selected'));
            event?.target?.closest('.bulk-preset-btn')?.classList.add('selected');
            
            document.getElementById('bulk-selected-preset').style.display = 'block';
            document.getElementById('bulk-preset-name').textContent = preset.charAt(0).toUpperCase() + preset.slice(1);
            
            updateBulkUI();
        }
        
        // === UI UPDATES ===
        function updateBulkUI() {
            const count = selectedBulkDevices.size;
            document.getElementById('bulk-selection-summary').textContent = `${count} device(s) selected`;
            
            updateBulkActionsVisibility();
            updateBulkApplyButton();
            updateBulkActionSummary();
        }
        
        function updateBulkActionsVisibility() {
            const hasSelection = selectedBulkDevices.size > 0;
            document.getElementById('bulk-no-selection').style.display = hasSelection ? 'none' : 'block';
            document.getElementById('bulk-actions-content').style.display = hasSelection ? 'block' : 'none';
        }
        
        function updateBulkApplyButton() {
            const btn = document.getElementById('bulk-apply-btn');
            let canApply = selectedBulkDevices.size > 0;
            
            if (currentBulkActionType === 'settings') {
                canApply = canApply && Object.keys(bulkSettingsToApply).length > 0;
            } else if (currentBulkActionType === 'command') {
                canApply = canApply && currentBulkCommand;
            } else if (currentBulkActionType === 'preset') {
                canApply = canApply && currentBulkPreset;
            }
            
            btn.disabled = !canApply;
        }
        
        function updateBulkActionSummary() {
            const summary = document.getElementById('bulk-action-summary');
            const count = selectedBulkDevices.size;
            
            if (count === 0) {
                summary.textContent = '';
                return;
            }
            
            let action = '';
            if (currentBulkActionType === 'settings') {
                const settingCount = Object.keys(bulkSettingsToApply).length;
                action = settingCount > 0 ? `Change ${settingCount} setting(s)` : 'Select settings to change';
            } else if (currentBulkActionType === 'command') {
                action = currentBulkCommand ? `Send "${currentBulkCommand}"` : 'Select a command';
            } else if (currentBulkActionType === 'preset') {
                action = currentBulkPreset ? `Apply "${currentBulkPreset}" preset` : 'Select a preset';
            }
            
            summary.textContent = `${count} device(s)  ${action}`;
        }
        
        // === EXECUTE BULK ACTION ===
        async function executeBulkAction() {
            if (selectedBulkDevices.size === 0) {
                showToast('No devices selected', true);
                return;
            }
            
            const totalCount = selectedBulkDevices.size;
            let successCount = 0;
            
            // Confirm
            let confirmMsg = `Apply action to ${totalCount} device(s)?`;
            if (currentBulkActionType === 'settings') {
                confirmMsg += `\n\nSettings to change: ${Object.keys(bulkSettingsToApply).length}`;
            } else if (currentBulkActionType === 'command') {
                confirmMsg += `\n\nCommand: ${currentBulkCommand}`;
            } else if (currentBulkActionType === 'preset') {
                confirmMsg += `\n\nPreset: ${currentBulkPreset}`;
            }
            
            if (!confirm(confirmMsg)) return;
            
            showToast(`Applying to ${totalCount} device(s)...`);
            
            for (const deviceId of selectedBulkDevices) {
                try {
                    if (currentBulkActionType === 'settings') {
                        await applySettingsToDevice(deviceId, bulkSettingsToApply);
                    } else if (currentBulkActionType === 'command') {
                        await sendCommandToDevice(deviceId, currentBulkCommand);
                    } else if (currentBulkActionType === 'preset') {
                        await applyPresetToDevice(deviceId, currentBulkPreset);
                    }
                    successCount++;
                } catch (e) {
                    console.error(`Failed for ${deviceId}:`, e);
                }
            }
            
            closeModal('bulk-actions-modal');
            showToast(` Applied to ${successCount}/${totalCount} device(s)`);
        }
        
        async function applySettingsToDevice(deviceId, settings) {
            return database.ref(`devices/${deviceId}/settings`).update(settings);
        }
        
        async function applyPresetToDevice(deviceId, preset) {
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            const signature = await signCommand({
                action: 'apply_preset',
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            const commandRef = database.ref(`devices/${deviceId}/commands`).push();
            const commandData = {
                action: 'apply_preset',
                preset: preset,
                status: 'pending',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            return commandRef.set(commandData);
        }
        
        async function sendCommandToDevice(deviceId, command) {
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            const signature = await signCommand({
                action: command,
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            const commandRef = database.ref(`devices/${deviceId}/commands`).push();
            const commandData = {
                action: command,
                status: 'pending',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            return commandRef.set(commandData);
        }
        
        // Keep old function names for backwards compatibility
        function selectAllDevices() { bulkSelectAll(); }
        function deselectAllDevices() { bulkSelectNone(); }
        function updateBulkSelectedCount() { updateBulkUI(); }
        function onBulkActionChange() {}
        function applyBulkAction() { executeBulkAction(); }

        function sendNotification() {
            const title = document.getElementById('notify-title').value;
            const message = document.getElementById('notify-message').value;
            const type = document.getElementById('notify-type').value;
            const priority = document.getElementById('notify-priority').value;
            const vibrate = document.getElementById('notify-vibrate').checked;
            const sound = document.getElementById('notify-sound').checked;
            const repeat = document.getElementById('notify-repeat').checked;
            
            if (!title || !message) {
                showToast('Please fill title and message', true);
                return;
            }
            
            sendCommand('send_notification', {
                title,
                message,
                type,
                priority,
                vibrate,
                sound,
                repeat
            });
            
            closeModal('notification-modal');
            showToast('Notification sent!');
            
            document.getElementById('notify-title').value = '';
            document.getElementById('notify-message').value = '';
        }

        function resetPIN() {
            const pin = document.getElementById('new-pin').value;
            if (pin.length < 4 || pin.length > 8 || !/^\d+$/.test(pin)) {
                showToast('PIN must be 4-8 digits', true);
                return;
            }
            sendCommand('reset_pin', { newPin: pin });
            closeModal('pin-modal');
            showToast('PIN reset sent!');
            document.getElementById('new-pin').value = '';
        }

        function uninstallFilter() {
            const deviceId = selectedDeviceId;
            
            // Send uninstall command first
            sendCommand('uninstall');
            closeModal('uninstall-modal');
            showToast('Uninstalling filter...');
            
            // Remove device from Firebase after a delay (let command be received first)
            setTimeout(() => {
                database.ref(`devices/${deviceId}`).remove()
                    .then(() => {
                        showToast('Device removed successfully');
                        selectedDeviceId = null;
                        showAllDevices();
                    })
                    .catch(err => {
                        console.log('Device removal error:', err);
                        // Still clear selection
                        selectedDeviceId = null;
                        showAllDevices();
                    });
            }, 2000);
        }

        function deleteDeviceFromDashboard() {
            const deviceId = selectedDeviceId;
            if (!deviceId) {
                showToast('No device selected', true);
                closeModal('delete-device-modal');
                return;
            }
            
            database.ref(`devices/${deviceId}`).remove()
                .then(() => {
                    showToast('Device deleted from dashboard');
                    closeModal('delete-device-modal');
                    selectedDeviceId = null;
                    showAllDevices();
                })
                .catch(err => {
                    showToast('Failed to delete device: ' + err.message, true);
                    closeModal('delete-device-modal');
                });
        }

        function removeDeviceFromDashboard(deviceId) {
            if (!confirm('Remove this device from the dashboard? This will delete all data for this device.')) return;
            
            database.ref(`devices/${deviceId}`).remove()
                .then(() => {
                    showToast('Device removed');
                    selectedDeviceId = null;
                    showAllDevices();
                })
                .catch(err => {
                    showToast('Failed to remove device', true);
                });
        }

        function acknowledgeAlert(deviceId, alertId = null) {
            // Clear tamper flags
            database.ref(`devices/${deviceId}/info`).update({
                tamperDetected: false,
                failedPinAttempts: 0,
                lockoutStatus: null
            });
            
            // Clear specific alert or all alerts
            if (alertId) {
                database.ref(`devices/${deviceId}/alerts/${alertId}`).remove();
            } else {
                // Clear all alerts
                database.ref(`devices/${deviceId}/alerts`).remove();
            }
            
            // Also clear any security lockout
            database.ref(`devices/${deviceId}/security_lockout`).remove();
            
            // Send unlock command to device
            sendCommand('clear_security_lockout');
            
            showToast('Alert cleared - device unlocked');
            renderDeviceDetail(deviceId);
        }
        
        function getAlertDescription(type) {
            const descriptions = {
                'crash_loop_attack': {
                    title: 'Crash Loop Detected',
                    desc: 'App restarted multiple times quickly. Usually happens during setup or updates.',
                    severity: 'medium'
                },
                'accessibility_disabled': {
                    title: 'Accessibility Service Disabled',
                    desc: 'Someone tried to disable the accessibility service.',
                    severity: 'high'
                },
                'device_admin_disabled': {
                    title: 'Device Admin Disabled',
                    desc: 'Someone tried to disable device admin permissions.',
                    severity: 'critical'
                },
                'tamper_detected': {
                    title: 'Tamper Attempt',
                    desc: 'Suspicious activity detected on the device.',
                    severity: 'high'
                },
                'failed_pin': {
                    title: 'Failed PIN Attempts',
                    desc: 'Multiple wrong PIN attempts.',
                    severity: 'medium'
                },
                'safe_mode': {
                    title: 'Safe Mode Boot',
                    desc: 'Device was booted in safe mode.',
                    severity: 'high'
                }
            };
            return descriptions[type] || { title: type, desc: 'Unknown alert type', severity: 'medium' };
        }

        function clearLockout(deviceId = selectedDeviceId) {
            if (!deviceId) {
                showToast('No device selected', true);
                return;
            }
            
            // Clear lockout in Firebase
            database.ref(`devices/${deviceId}/info`).update({
                failedPinAttempts: 0,
                lockoutStatus: null
            });
            
            // Send command to device
            sendCommand('clear_lockout');
            showToast('Lockout cleared!');
            renderDeviceDetail(deviceId);
        }
        
        function generateResetCode(deviceId) {
            // Generate a reset code based on device ID
            // This should match the algorithm in SecurityManager.kt
            if (!deviceId) return '--------';
            
            let hash = 0;
            const str = deviceId + 'YESHIVA_ADMIN_2024';
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            return Math.abs(hash).toString(16).toUpperCase().padStart(8, '0').substring(0, 8);
        }

        function clearLogs() {
            if (!selectedDeviceId || !confirm('Clear all logs?')) return;
            database.ref(`devices/${selectedDeviceId}/logs`).remove();
            showToast('Logs cleared');
            renderDeviceDetail(selectedDeviceId);
        }

        function openRenameModal(currentName) {
            document.getElementById('new-device-name').value = currentName;
            openModal('rename-modal');
        }

        function renameDevice() {
            const name = document.getElementById('new-device-name').value.trim();
            if (!name) {
                showToast('Please enter a name', true);
                return;
            }
            database.ref(`devices/${selectedDeviceId}/info/name`).set(name);
            closeModal('rename-modal');
            showToast('Device renamed!');
        }

        // =====================================================
        // MODALS
        // =====================================================
        function openModal(id) {
            // Hide main content to prevent rendering issues
            const mainContainer = document.querySelector('.main-container');
            const header = document.querySelector('.header');
            if (mainContainer) mainContainer.style.visibility = 'hidden';
            if (header) header.style.visibility = 'hidden';
            document.getElementById(id).classList.remove('hidden');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
            // Show main content again
            const mainContainer = document.querySelector('.main-container');
            const header = document.querySelector('.header');
            if (mainContainer) mainContainer.style.visibility = 'visible';
            if (header) header.style.visibility = 'visible';
        }

        // Close modal on background click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.classList.add('hidden');
            });
        });

        // Enter key to login
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });

        // Auto-refresh device details every 30 seconds
        setInterval(() => {
            if (selectedDeviceId && devicesData[selectedDeviceId]) {
                // Soft refresh - just update stats
                updateStats();
            }
        }, 30000);

        // =====================================================
        // SCREENSHOT CAPTURE (Base64 version - no Firebase Storage needed)
        // =====================================================
        
        let screenshotListener = null;

        function captureScreenshot() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            const btn = document.getElementById('capture-btn');
            if (!btn) return;
            
            btn.disabled = true;
            btn.classList.add('capturing');
            btn.innerHTML = '<span class="screenshot-spinner"></span> Capturing...';
            
            // Send capture command
            sendCommand('capture_screenshot');
            
            // Update status
            const status = document.getElementById('screenshot-status');
            if (status) {
                status.className = 'screenshot-status capturing';
                status.innerHTML = '<div class="screenshot-spinner"></div> Capturing...';
            }
            
            // Start listening for screenshot updates
            listenForScreenshot();
            
            // Timeout after 30 seconds
            setTimeout(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.classList.remove('capturing');
                    btn.innerHTML = '<span></span> Capture';
                }
            }, 30000);
        }

        function clearScreenshot() {
            const placeholder = document.getElementById('screenshot-placeholder');
            const image = document.getElementById('screenshot-image');
            const clearBtn = document.getElementById('clear-screenshot-btn');
            const status = document.getElementById('screenshot-status');
            const time = document.getElementById('screenshot-time');
            
            // Hide image, show placeholder
            if (image) {
                image.classList.add('hidden');
                image.src = '';
            }
            if (placeholder) {
                placeholder.classList.remove('hidden');
                placeholder.style.display = '';
            }
            
            // Hide clear button
            if (clearBtn) clearBtn.classList.add('hidden');
            
            // Clear status
            if (status) {
                status.innerHTML = '';
                status.className = 'screenshot-status';
            }
            if (time) time.textContent = '';
        }

        function listenForScreenshot() {
            if (!selectedDeviceId) return;
            
            // Remove previous listener
            if (screenshotListener) {
                database.ref(`devices/${selectedDeviceId}/latestScreenshot`).off('value', screenshotListener);
            }
            
            screenshotListener = database.ref(`devices/${selectedDeviceId}/latestScreenshot`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;
                updateScreenshotUI(data);
            });
        }

        function updateScreenshotUI(data) {
            const btn = document.getElementById('capture-btn');
            const clearBtn = document.getElementById('clear-screenshot-btn');
            const placeholder = document.getElementById('screenshot-placeholder');
            const image = document.getElementById('screenshot-image');
            const status = document.getElementById('screenshot-status');
            const time = document.getElementById('screenshot-time');
            
            if (!status) return; // UI not ready
            
            switch (data.status) {
                case 'capturing':
                    status.className = 'screenshot-status capturing';
                    status.innerHTML = '<div class="screenshot-spinner"></div> Capturing...';
                    if (clearBtn) clearBtn.classList.add('hidden');
                    break;
                    
                case 'success':
                    // Show image - handle both Base64 and URL formats
                    if (placeholder) {
                        placeholder.style.display = 'none';
                        placeholder.classList.add('hidden');
                    }
                    if (image) {
                        image.classList.remove('hidden');
                        // Check if it's Base64 or URL
                        if (data.imageBase64) {
                            image.src = 'data:image/jpeg;base64,' + data.imageBase64;
                        } else if (data.url) {
                            image.src = data.url;
                        }
                    }
                    
                    // Update fullscreen image too
                    const fullImg = document.getElementById('screenshot-fullscreen-img');
                    if (fullImg) {
                        if (data.imageBase64) {
                            fullImg.src = 'data:image/jpeg;base64,' + data.imageBase64;
                        } else if (data.url) {
                            fullImg.src = data.url;
                        }
                    }
                    
                    // Show clear button
                    if (clearBtn) clearBtn.classList.remove('hidden');
                    
                    // Update status
                    status.className = 'screenshot-status success';
                    status.innerHTML = ' Captured';
                    
                    // Update time
                    if (time && data.timestamp) {
                        time.textContent = new Date(data.timestamp).toLocaleTimeString();
                    }
                    
                    // Reset button
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('capturing');
                        btn.innerHTML = '<span></span> Capture';
                    }
                    break;
                    
                case 'error':
                    status.className = 'screenshot-status error';
                    status.innerHTML = ' ' + (data.error || 'Failed');
                    if (clearBtn) clearBtn.classList.add('hidden');
                    
                    // Reset button
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.remove('capturing');
                        btn.innerHTML = '<span></span> Capture';
                    }
                    break;
            }
        }

        function openScreenshotFullscreen() {
            const fullscreen = document.getElementById('screenshot-fullscreen');
            if (fullscreen) fullscreen.classList.remove('hidden');
        }

        function closeScreenshotFullscreen() {
            const fullscreen = document.getElementById('screenshot-fullscreen');
            if (fullscreen) fullscreen.classList.add('hidden');
        }

        function loadLatestScreenshot() {
            if (!selectedDeviceId) return;
            
            database.ref(`devices/${selectedDeviceId}/latestScreenshot`).once('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.status === 'success' && (data.imageBase64 || data.url)) {
                    updateScreenshotUI(data);
                }
            });
            
            // Start listening for updates
            listenForScreenshot();
        }

        // ESC key to close fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeScreenshotFullscreen();
            }
        });

        // =====================================================
        // DEVICE PING & CONNECTION MANAGEMENT
        // =====================================================

        let pingListener = null;

        async function pingDevice() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            const btn = document.getElementById('ping-btn');
            const statusEl = document.getElementById('ping-status');
            
            if (!btn) return;
            
            btn.disabled = true;
            btn.classList.add('pinging');
            btn.innerHTML = ' Pinging...';
            
            if (statusEl) {
                statusEl.className = 'ping-status waiting';
                statusEl.textContent = ' Waiting for device response...';
            }
            
            const commandId = 'ping_' + Date.now();
            const commandRef = database.ref(`devices/${selectedDeviceId}/commands/${commandId}`);
            const startTime = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            // Sign the ping command
            const signature = await signCommand({
                action: 'ping',
                timestamp: startTime,
                createdBy: createdBy
            });
            
            const commandData = {
                action: 'ping',
                timestamp: startTime,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            commandRef.set(commandData).then(() => {
                // Listen for response
                pingListener = commandRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.status === 'completed') {
                        const responseTime = Date.now() - startTime;
                        
                        if (statusEl) {
                            statusEl.className = 'ping-status success';
                            statusEl.textContent = ` Device responded in ${responseTime}ms`;
                        }
                        
                        showToast(`Device responded in ${responseTime}ms`, false);
                        resetPingButton();
                        
                        // Stop listening
                        commandRef.off('value', pingListener);
                        pingListener = null;
                        
                        // Refresh device info
                        if (devicesData[selectedDeviceId]) {
                            renderDeviceDetails(devicesData[selectedDeviceId], selectedDeviceId);
                        }
                        
                    } else if (data && data.status === 'failed') {
                        if (statusEl) {
                            statusEl.className = 'ping-status error';
                            statusEl.textContent = ' Ping failed: ' + (data.error || 'Unknown error');
                        }
                        showToast('Ping failed: ' + (data.error || 'Unknown error'), true);
                        resetPingButton();
                        
                        commandRef.off('value', pingListener);
                        pingListener = null;
                    }
                });
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (pingListener) {
                        commandRef.off('value', pingListener);
                        pingListener = null;
                        
                        if (statusEl) {
                            statusEl.className = 'ping-status error';
                            statusEl.textContent = ' No response after 30s - device may be offline';
                        }
                        showToast('No response - device may be offline', true);
                        resetPingButton();
                    }
                }, 30000);
                
            }).catch((error) => {
                if (statusEl) {
                    statusEl.className = 'ping-status error';
                    statusEl.textContent = ' Failed to send ping: ' + error.message;
                }
                showToast('Failed to send ping: ' + error.message, true);
                resetPingButton();
            });
        }

        function resetPingButton() {
            const btn = document.getElementById('ping-btn');
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('pinging');
                btn.innerHTML = ' Ping Device';
            }
        }

        async function forceReconnect() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            const btn = document.getElementById('reconnect-btn');
            const statusEl = document.getElementById('ping-status');
            
            if (!btn) return;
            
            btn.disabled = true;
            btn.classList.add('reconnecting');
            btn.innerHTML = ' Reconnecting...';
            
            if (statusEl) {
                statusEl.className = 'ping-status waiting';
                statusEl.textContent = ' Sending reconnect command...';
            }
            
            const commandId = 'reconnect_' + Date.now();
            const commandRef = database.ref(`devices/${selectedDeviceId}/commands/${commandId}`);
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            const signature = await signCommand({
                action: 'force_reconnect',
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            const commandData = {
                action: 'force_reconnect',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            commandRef.set(commandData).then(() => {
                if (statusEl) {
                    statusEl.className = 'ping-status success';
                    statusEl.textContent = ' Reconnect command sent - device will reconnect shortly';
                }
                showToast('Reconnect command sent', false);
                
                // Reset button after delay
                setTimeout(() => {
                    resetReconnectButton();
                }, 2000);
                
            }).catch((error) => {
                if (statusEl) {
                    statusEl.className = 'ping-status error';
                    statusEl.textContent = ' Failed: ' + error.message;
                }
                showToast('Failed to send reconnect command: ' + error.message, true);
                resetReconnectButton();
            });
        }

        function resetReconnectButton() {
            const btn = document.getElementById('reconnect-btn');
            if (btn) {
                btn.disabled = false;
                btn.classList.remove('reconnecting');
                btn.innerHTML = ' Force Reconnect';
            }
        }

        // =====================================================
        // FCM WAKE PUSH - Works even when device is offline!
        // =====================================================

        async function sendWakePush() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }

            const btn = document.getElementById('wake-push-btn');
            const statusEl = document.getElementById('ping-status');
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = ' Sending...';
            }
            
            if (statusEl) {
                statusEl.className = 'ping-status';
                statusEl.textContent = ' Sending wake push via FCM...';
            }

            try {
                // First check if device has GMS
                const infoSnapshot = await database.ref(`devices/${selectedDeviceId}/info`).once('value');
                const deviceInfo = infoSnapshot.val() || {};
                
                if (deviceInfo.hasGms === false) {
                    throw new Error('Device has no Google Play Services - FCM is unavailable. Use Force Reconnect instead (device reconnects every 15 min).');
                }

                // Get FCM token from device info
                const fcmSnapshot = await database.ref(`devices/${selectedDeviceId}/fcm/token`).once('value');
                const fcmToken = fcmSnapshot.val();
                
                if (!fcmToken) {
                    throw new Error('Device has no FCM token registered. Make sure device is running latest version (V1.55+).');
                }

                // Create a wake command that will be picked up when device reconnects
                // AND trigger FCM via Cloud Function
                const commandId = 'wake_' + Date.now();
                const timestamp = Date.now();
                const createdBy = currentUser?.email || 'dashboard';
                
                const signature = await signCommand({
                    action: 'wake',
                    timestamp: timestamp,
                    createdBy: createdBy
                });

                // 1. Write command to Firebase (backup method)
                const commandData = {
                    action: 'wake',
                    timestamp: timestamp,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: createdBy,
                    source: 'fcm_wake'
                };
                if (signature) commandData.signature = signature;

                await database.ref(`devices/${selectedDeviceId}/commands/${commandId}`).set(commandData);

                // 2. Call Cloud Function to send FCM push
                // The Cloud Function URL - update this after deploying
                const cloudFunctionUrl = `https://us-central1-yeshivafilter-fec0e.cloudfunctions.net/sendWakePush`;
                
                try {
                    const response = await fetch(cloudFunctionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            deviceId: selectedDeviceId,
                            fcmToken: fcmToken,
                            action: 'wake',
                            commandId: commandId
                        })
                    });

                    if (response.ok) {
                        if (statusEl) {
                            statusEl.className = 'ping-status success';
                            statusEl.textContent = ' Wake push sent via FCM! Device should reconnect shortly.';
                        }
                        showToast('Wake push sent!', false);
                        
                        // Log the action
                        logAdminAction(`Sent FCM wake push to ${selectedDeviceId}`);
                    } else {
                        throw new Error('Cloud Function returned error');
                    }
                } catch (fcmError) {
                    // Cloud Function might not be deployed yet
                    console.warn('FCM Cloud Function not available:', fcmError);
                    if (statusEl) {
                        statusEl.className = 'ping-status';
                        statusEl.textContent = ' FCM function not deployed. Command written to database instead.';
                    }
                    showToast('Wake command saved - FCM function not deployed yet', false);
                }

            } catch (error) {
                console.error('Wake push error:', error);
                if (statusEl) {
                    statusEl.className = 'ping-status error';
                    statusEl.textContent = ' ' + error.message;
                }
                showToast('Failed: ' + error.message, true);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = ' Wake Push';
                }
            }
        }

        // =====================================================
        // KOSHER STORE APP UPDATES
        // =====================================================

        async function checkAppUpdates() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            const statusEl = document.getElementById('app-updates-status');
            if (statusEl) {
                statusEl.innerHTML = ' Checking for updates...';
            }
            
            const commandId = 'check_app_updates_' + Date.now();
            const commandRef = database.ref(`devices/${selectedDeviceId}/commands/${commandId}`);
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            const signature = await signCommand({
                action: 'check_app_updates',
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            const commandData = {
                action: 'check_app_updates',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            commandRef.set(commandData).then(() => {
                showToast('Checking for app updates...', false);
                
                // Listen for command completion
                commandRef.on('value', (snap) => {
                    const cmd = snap.val();
                    if (cmd && cmd.status === 'completed') {
                        commandRef.off();
                        if (statusEl) {
                            statusEl.innerHTML = ` ${cmd.result}`;
                        }
                        showToast(cmd.result, false);
                        // Refresh device view
                        setTimeout(() => selectDevice(selectedDeviceId), 1000);
                    } else if (cmd && cmd.status === 'failed') {
                        commandRef.off();
                        if (statusEl) {
                            statusEl.innerHTML = ` ${cmd.error || 'Check failed'}`;
                        }
                        showToast('Failed to check updates: ' + (cmd.error || 'Unknown error'), true);
                    }
                });
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    commandRef.off();
                }, 30000);
                
            }).catch((error) => {
                if (statusEl) {
                    statusEl.innerHTML = ' Failed to send command';
                }
                showToast('Failed: ' + error.message, true);
            });
        }

        async function updateAllApps() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            if (!confirm(' UPDATE ALL APPS\\n\\nThis will download and install all pending app updates.\\n\\nContinue?')) {
                return;
            }
            
            const statusEl = document.getElementById('app-updates-status');
            if (statusEl) {
                statusEl.innerHTML = ' Starting updates...';
            }
            
            const commandId = 'update_all_apps_' + Date.now();
            const commandRef = database.ref(`devices/${selectedDeviceId}/commands/${commandId}`);
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            const signature = await signCommand({
                action: 'update_all_apps',
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            const commandData = {
                action: 'update_all_apps',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            commandRef.set(commandData).then(() => {
                showToast('Starting app updates...', false);
                
                // Listen for command updates
                commandRef.on('value', (snap) => {
                    const cmd = snap.val();
                    if (cmd) {
                        if (cmd.progress && statusEl) {
                            statusEl.innerHTML = ` ${cmd.progress}`;
                        }
                        if (cmd.status === 'completed') {
                            commandRef.off();
                            if (statusEl) {
                                statusEl.innerHTML = ` ${cmd.result}`;
                            }
                            showToast(cmd.result, false);
                            // Refresh device view
                            setTimeout(() => selectDevice(selectedDeviceId), 2000);
                        } else if (cmd.status === 'failed') {
                            commandRef.off();
                            if (statusEl) {
                                statusEl.innerHTML = ` ${cmd.error || 'Update failed'}`;
                            }
                            showToast('Failed: ' + (cmd.error || 'Unknown error'), true);
                        }
                    }
                });
                
                // Timeout after 5 minutes (updates can take a while)
                setTimeout(() => {
                    commandRef.off();
                }, 300000);
                
            }).catch((error) => {
                if (statusEl) {
                    statusEl.innerHTML = ' Failed to send command';
                }
                showToast('Failed: ' + error.message, true);
            });
        }

        // =====================================================
        // TEMP DISABLE / ENABLE ALL RESTRICTIONS
        // =====================================================

        async function tempDisableAll() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            // Confirm with user
            if (!confirm(' TEMP DISABLE ALL\\n\\nThis will:\\n Remove ALL blocking restrictions\\n Unhide ALL apps\\n Enable developer options & ADB\\n\\nOnly PIN protection will remain.\\n\\nContinue?')) {
                return;
            }
            
            const btn = document.getElementById('temp-disable-btn');
            const statusEl = document.getElementById('temp-status');
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = ' Disabling...';
            }
            
            if (statusEl) {
                statusEl.className = 'temp-status';
                statusEl.textContent = ' Sending disable command...';
            }
            
            const commandId = 'temp_disable_' + Date.now();
            const commandRef = database.ref(`devices/${selectedDeviceId}/commands/${commandId}`);
            const timestamp = Date.now();
            const createdBy = currentUser?.email || 'dashboard';
            
            const signature = await signCommand({
                action: 'temp_disable_all',
                timestamp: timestamp,
                createdBy: createdBy
            });
            
            const commandData = {
                action: 'temp_disable_all',
                timestamp: timestamp,
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                createdBy: createdBy
            };
            if (signature) commandData.signature = signature;
            
            commandRef.set(commandData).then(() => {
                // Listen for completion
                commandRef.on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.status === 'completed') {
                        if (statusEl) {
                            statusEl.className = 'temp-status disabled';
                            statusEl.textContent = ' FILTER TEMPORARILY DISABLED';
                        }
                        showToast('Filter disabled - all restrictions removed', false);
                        resetTempDisableButton();
                        commandRef.off('value');
                        
                        // Also set all toggles to false in Firebase
                        setAllSettingsFalse();
                        
                    } else if (data && data.status === 'failed') {
                        if (statusEl) {
                            statusEl.className = 'temp-status';
                            statusEl.textContent = ' Failed: ' + (data.error || 'Unknown error');
                        }
                        showToast('Failed to disable: ' + (data.error || 'Unknown error'), true);
                        resetTempDisableButton();
                        commandRef.off('value');
                    }
                });
                
                // Timeout
                setTimeout(() => {
                    commandRef.off('value');
                    resetTempDisableButton();
                }, 30000);
                
            }).catch((error) => {
                if (statusEl) {
                    statusEl.textContent = ' Failed: ' + error.message;
                }
                showToast('Failed: ' + error.message, true);
                resetTempDisableButton();
            });
        }

        function tempEnableAll() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            if (!confirm(' RE-ENABLE FILTER\\n\\nThis will restore all restrictions from your saved settings.\\n\\nContinue?')) {
                return;
            }
            
            const btn = document.getElementById('temp-enable-btn');
            const statusEl = document.getElementById('temp-status');
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = ' Enabling...';
            }
            
            if (statusEl) {
                statusEl.className = 'temp-status';
                statusEl.textContent = ' Re-enabling filter...';
            }
            
            // Clear temp_disabled flag in settings
            database.ref(`devices/${selectedDeviceId}/settings/temp_disabled`).set(false)
                .then(async () => {
                    // Send command to re-apply all settings
                    const commandId = 'temp_enable_' + Date.now();
                    const timestamp = Date.now();
                    const createdBy = currentUser?.email || 'dashboard';
                    const signature = await signCommand({
                        action: 'temp_enable_all',
                        timestamp: timestamp,
                        createdBy: createdBy
                    });
                    return database.ref(`devices/${selectedDeviceId}/commands/${commandId}`).set({
                        action: 'temp_enable_all',
                        status: 'pending',
                        timestamp: timestamp,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        createdBy: createdBy,
                        signature: signature
                    });
                })
                .then(() => {
                    if (statusEl) {
                        statusEl.className = 'temp-status enabled';
                        statusEl.textContent = ' Filter re-enabled - settings will sync';
                    }
                    showToast('Filter re-enabled', false);
                    resetTempEnableButton();
                    
                    // Refresh device view
                    setTimeout(() => {
                        if (devicesData[selectedDeviceId]) {
                            renderDeviceDetails(devicesData[selectedDeviceId], selectedDeviceId);
                        }
                    }, 2000);
                })
                .catch((error) => {
                    if (statusEl) {
                        statusEl.textContent = ' Failed: ' + error.message;
                    }
                    showToast('Failed: ' + error.message, true);
                    resetTempEnableButton();
                });
        }

        function setAllSettingsFalse() {
            if (!selectedDeviceId) return;
            
            const allFalseSettings = {
                block_play_store: false,
                block_apk_install: false,
                block_developer_options: false,
                block_adb: false,
                block_vpn: false,
                block_factory_reset: false,
                block_safe_mode: false,
                block_app_data_reset: false,
                block_multiple_users: false,
                block_work_profile: false,
                block_social_media: false,
                block_google_app: false,
                block_proxy_dns: false,
                block_hotspot: false,
                block_file_managers: false,
                block_bluetooth: false,
                block_usb: false,
                block_quick_settings: false,
                block_other_accessibility: false,
                block_alt_stores: false,
                lock_dns_settings: false,
                dns_provider: '',
                master_web_block: false,
                block_smart_lock: false,
                block_assistant: false,
                block_airplane_mode: false,
                block_datetime: false,
                block_messaging: false,
                block_battery_opt: false,
                block_default_apps: false,
                block_usb_devices: false,
                blockWhatsAppChannels: false,
                blockMetaAI: false,
                block_youtube_everywhere: true,  // YouTube stays blocked even when "all false"
                temp_disabled: true
            };
            
            database.ref(`devices/${selectedDeviceId}/settings`).update(allFalseSettings)
                .then(() => {
                    console.log('All settings set to false in Firebase');
                })
                .catch((error) => {
                    console.error('Failed to update settings:', error);
                });
        }

        function resetTempDisableButton() {
            const btn = document.getElementById('open-temp-disable-btn');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = ' Temp Disable';
            }
        }

        // =====================================================
        // TEMP DISABLE MODAL - GRANULAR CONTROL
        // =====================================================

        // All available settings with friendly names
        const allBlockSettings = [
            { key: 'block_play_store', label: ' Play Store' },
            { key: 'block_apk_install', label: ' APK Install' },
            { key: 'block_developer_options', label: ' Developer Options' },
            { key: 'block_adb', label: ' ADB/USB Debug' },
            { key: 'block_vpn', label: ' VPN Apps' },
            { key: 'block_factory_reset', label: ' Factory Reset' },
            { key: 'block_safe_mode', label: ' Safe Mode' },
            { key: 'block_app_data_reset', label: ' App Data Reset' },
            { key: 'block_multiple_users', label: ' Multiple Users' },
            { key: 'block_work_profile', label: ' Work Profile' },
            { key: 'block_social_media', label: ' Social Media' },
            { key: 'block_google_app', label: ' Google App' },
            { key: 'block_proxy_dns', label: ' Proxy/DNS Apps' },
            { key: 'block_hotspot', label: ' Hotspot/Tethering' },
            { key: 'block_file_managers', label: ' File Managers' },
            { key: 'block_bluetooth', label: ' Bluetooth' },
            { key: 'block_usb', label: ' USB Transfer' },
            { key: 'block_quick_settings', label: ' Quick Settings' },
            { key: 'block_other_accessibility', label: ' Other Accessibility' },
            { key: 'block_alt_stores', label: ' Alt App Stores' },
            { key: 'lock_dns_settings', label: ' DNS Settings' },
            { key: 'blockWhatsAppChannels', label: ' WhatsApp Channels' },
            { key: 'blockMetaAI', label: ' Meta AI' },
            { key: 'block_youtube_everywhere', label: ' YouTube Everywhere' },
            { key: 'master_web_block', label: ' Master Web Block' },
            { key: 'block_smart_lock', label: ' Smart Lock' },
            { key: 'block_assistant', label: ' Google Assistant' },
            { key: 'block_airplane_mode', label: ' Airplane Mode' },
            { key: 'block_datetime', label: ' Date/Time' },
            { key: 'block_messaging', label: ' Messaging Apps' },
            { key: 'block_battery_opt', label: ' Battery Settings' },
            { key: 'block_default_apps', label: ' Default Apps' },
            { key: 'block_usb_devices', label: ' USB Devices' }
        ];

        let tempDisableMinutes = 60; // Default 1 hour
        let tempDisableTimer = null;
        let tempDisableEndTime = null;

        function openTempDisableModal() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            // Populate the grid with checkboxes
            const grid = document.getElementById('temp-disable-grid');
            grid.innerHTML = '';
            
            // Get current settings from device
            const deviceSettings = devicesData[selectedDeviceId]?.settings || {};
            
            allBlockSettings.forEach(setting => {
                const isBlocked = deviceSettings[setting.key] === true;
                const div = document.createElement('div');
                div.className = `temp-disable-item ${isBlocked ? 'blocked' : 'allowed'}`;
                div.innerHTML = `
                    <input type="checkbox" id="temp-${setting.key}" checked data-key="${setting.key}">
                    <label for="temp-${setting.key}">${setting.label}</label>
                `;
                div.onclick = (e) => {
                    if (e.target.tagName !== 'INPUT') {
                        const checkbox = div.querySelector('input');
                        checkbox.checked = !checkbox.checked;
                    }
                };
                grid.appendChild(div);
            });
            
            // Check if temp disable is currently active
            checkTempDisableStatus();
            
            openModal('temp-disable-modal');
        }

        function checkTempDisableStatus() {
            if (!selectedDeviceId) return;
            
            database.ref(`devices/${selectedDeviceId}/temp_disable_info`).once('value', (snapshot) => {
                const info = snapshot.val();
                const countdownEl = document.getElementById('temp-countdown-display');
                const cancelBtn = document.getElementById('cancel-temp-btn');
                
                if (info && info.active && info.end_time > Date.now()) {
                    // Temp disable is active
                    countdownEl.classList.remove('hidden');
                    countdownEl.classList.add('active');
                    cancelBtn.disabled = false;
                    tempDisableEndTime = info.end_time;
                    startCountdownTimer();
                } else {
                    countdownEl.classList.add('hidden');
                    countdownEl.classList.remove('active');
                    cancelBtn.disabled = true;
                    tempDisableEndTime = null;
                }
            });
        }

        function startCountdownTimer() {
            if (tempDisableTimer) clearInterval(tempDisableTimer);
            
            const updateCountdown = () => {
                const now = Date.now();
                const remaining = tempDisableEndTime - now;
                
                if (remaining <= 0) {
                    clearInterval(tempDisableTimer);
                    document.getElementById('temp-countdown-time').textContent = '00:00';
                    document.getElementById('temp-countdown-display').classList.add('hidden');
                    document.getElementById('cancel-temp-btn').disabled = true;
                    showToast('Temp disable expired - filter re-enabled', false);
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                document.getElementById('temp-countdown-time').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };
            
            updateCountdown();
            tempDisableTimer = setInterval(updateCountdown, 1000);
        }

        function selectTime(minutes) {
            tempDisableMinutes = minutes;
            
            // Update button styles
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.minutes) === minutes);
            });
            
            // Show/hide custom input
            const customInput = document.getElementById('custom-time-input');
            if (minutes === 0) {
                customInput.classList.add('visible');
            } else {
                customInput.classList.remove('visible');
            }
        }

        function tempSelectAll() {
            document.querySelectorAll('#temp-disable-grid input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
        }

        function tempDeselectAll() {
            document.querySelectorAll('#temp-disable-grid input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function tempInvert() {
            document.querySelectorAll('#temp-disable-grid input[type="checkbox"]').forEach(cb => {
                cb.checked = !cb.checked;
            });
        }

        function applyTempDisable() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            // Get duration
            let durationMinutes = tempDisableMinutes;
            if (durationMinutes === 0) {
                durationMinutes = parseInt(document.getElementById('custom-minutes').value) || 60;
            }
            
            // Get which settings to allow (checked = allow, unchecked = keep blocked)
            const settingsToAllow = {};
            const settingsToBlock = {};
            
            document.querySelectorAll('#temp-disable-grid input[type="checkbox"]').forEach(cb => {
                const key = cb.dataset.key;
                if (cb.checked) {
                    settingsToAllow[key] = false; // Allow = set to false (not blocked)
                } else {
                    settingsToBlock[key] = true; // Block = set to true
                }
            });
            
            // Merge into one update
            const settingsUpdate = { ...settingsToAllow, ...settingsToBlock, temp_disabled: true };
            
            // Calculate end time (-1 = no limit)
            const endTime = durationMinutes === -1 ? -1 : Date.now() + (durationMinutes * 60 * 1000);
            
            const tempInfo = {
                active: true,
                start_time: Date.now(),
                end_time: endTime,
                duration_minutes: durationMinutes,
                allowed_settings: Object.keys(settingsToAllow),
                blocked_settings: Object.keys(settingsToBlock)
            };
            
            // Show loading
            showToast('Applying temp disable...', false);
            
            // Update Firebase
            Promise.all([
                database.ref(`devices/${selectedDeviceId}/settings`).update(settingsUpdate),
                database.ref(`devices/${selectedDeviceId}/temp_disable_info`).set(tempInfo)
            ]).then(async () => {
                // Send command to device
                const commandId = 'temp_disable_' + Date.now();
                const timestamp = Date.now();
                const createdBy = currentUser?.email || 'dashboard';
                const signature = await signCommand({
                    action: 'temp_disable_selective',
                    timestamp: timestamp,
                    createdBy: createdBy
                });
                return database.ref(`devices/${selectedDeviceId}/commands/${commandId}`).set({
                    action: 'temp_disable_selective',
                    settings: settingsUpdate,
                    end_time: endTime,
                    status: 'pending',
                    timestamp: timestamp,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: createdBy,
                    signature: signature
                });
            }).then(() => {
                const durationText = durationMinutes === -1 ? 'No time limit' : `${durationMinutes} minutes`;
                showToast(` Temp disable applied (${durationText})`, false);
                
                // Update status display
                const statusEl = document.getElementById('temp-status');
                if (statusEl) {
                    statusEl.className = 'temp-status disabled';
                    statusEl.textContent = ` Temp disabled for ${durationText}`;
                }
                
                // Start countdown if there's a time limit
                if (durationMinutes !== -1) {
                    tempDisableEndTime = endTime;
                    document.getElementById('temp-countdown-display').classList.remove('hidden');
                    document.getElementById('temp-countdown-display').classList.add('active');
                    document.getElementById('cancel-temp-btn').disabled = false;
                    startCountdownTimer();
                    
                    // Schedule auto re-enable
                    scheduleAutoReEnable(durationMinutes);
                }
                
                closeModal('temp-disable-modal');
                
            }).catch((error) => {
                showToast('Failed: ' + error.message, true);
            });
        }

        function scheduleAutoReEnable(minutes) {
            // The device will handle this via temp_disable_info.end_time
            // But we'll also set a backup in Firebase
            database.ref(`devices/${selectedDeviceId}/scheduled_reenable`).set({
                time: Date.now() + (minutes * 60 * 1000),
                active: true
            });
        }

        function cancelTempDisable() {
            if (!selectedDeviceId) return;
            
            if (!confirm(' Cancel temp disable and re-enable all restrictions?')) {
                return;
            }
            
            // Clear temp disable
            Promise.all([
                database.ref(`devices/${selectedDeviceId}/settings/temp_disabled`).set(false),
                database.ref(`devices/${selectedDeviceId}/temp_disable_info`).remove(),
                database.ref(`devices/${selectedDeviceId}/scheduled_reenable`).remove()
            ]).then(async () => {
                // Send re-enable command
                const commandId = 'reenable_' + Date.now();
                const timestamp = Date.now();
                const createdBy = currentUser?.email || 'dashboard';
                const signature = await signCommand({
                    action: 'temp_enable_all',
                    timestamp: timestamp,
                    createdBy: createdBy
                });
                return database.ref(`devices/${selectedDeviceId}/commands/${commandId}`).set({
                    action: 'temp_enable_all',
                    status: 'pending',
                    timestamp: timestamp,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: createdBy,
                    signature: signature
                });
            }).then(async () => {
                showToast(' Temp disable cancelled - filter re-enabled', false);
                
                // Clear countdown
                if (tempDisableTimer) clearInterval(tempDisableTimer);
                document.getElementById('temp-countdown-display').classList.add('hidden');
                document.getElementById('cancel-temp-btn').disabled = true;
                
                // Update status
                const statusEl = document.getElementById('temp-status');
                if (statusEl) {
                    statusEl.className = 'temp-status enabled';
                    statusEl.textContent = ' Filter re-enabled';
                }
                
                closeModal('temp-disable-modal');
                
            }).catch((error) => {
                showToast('Failed: ' + error.message, true);
            });
        }

        // ==================== SCREEN TIME MANAGEMENT ====================

        const SCREEN_TIME_CATEGORIES = {
            SOCIAL: { name: 'Social Media', emoji: '' },
            GAMES: { name: 'Games', emoji: '' },
            ENTERTAINMENT: { name: 'Entertainment', emoji: '' },
            PRODUCTIVITY: { name: 'Productivity', emoji: '' },
            EDUCATION: { name: 'Education', emoji: '' },
            CREATIVITY: { name: 'Creativity', emoji: '' },
            READING: { name: 'Reading', emoji: '' },
            HEALTH: { name: 'Health', emoji: '' },
            SHOPPING: { name: 'Shopping', emoji: '' },
            TRAVEL: { name: 'Travel', emoji: '' },
            UTILITIES: { name: 'Utilities', emoji: '' },
            OTHER: { name: 'Other', emoji: '' }
        };

        function renderScreenTimeTab(device) {
            const screenTimeLimits = device.screen_time_limits || {};
            const screenTimeUsage = device.screen_time_usage || {};
            const appLimits = screenTimeLimits.app_limits || {};
            const categoryLimits = screenTimeLimits.category_limits || {};
            const alwaysAllowed = screenTimeLimits.always_allowed || [];
            const downtime = screenTimeLimits.downtime || {};

            let html = `
                <!-- Downtime Section -->
                <div class="screen-time-section">
                    <div class="screen-time-header">
                        <div class="screen-time-title"> Downtime</div>
                        <label class="toggle">
                            <input type="checkbox" ${downtime.enabled ? 'checked' : ''} onchange="toggleDowntime(this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Block all apps during scheduled hours (except Always Allowed)</p>
                    <div class="downtime-config">
                        <span style="color: #94a3b8;">From:</span>
                        <input type="time" class="time-input" id="downtime-start" value="${formatTime24(downtime.start_hour || 22, downtime.start_minute || 0)}" onchange="updateDowntimeSchedule()">
                        <span style="color: #94a3b8;">To:</span>
                        <input type="time" class="time-input" id="downtime-end" value="${formatTime24(downtime.end_hour || 7, downtime.end_minute || 0)}" onchange="updateDowntimeSchedule()">
                        <button class="btn btn-primary" onclick="updateDowntimeSchedule()" style="padding: 8px 16px;">Save</button>
                    </div>
                    ${screenTimeUsage.is_in_downtime ? '<div style="margin-top: 12px; padding: 8px 12px; background: rgba(239, 68, 68, 0.2); border-radius: 8px; color: #fca5a5; font-size: 13px;"> Downtime is currently active</div>' : ''}
                </div>

                <!-- App Limits Section -->
                <div class="screen-time-section">
                    <div class="screen-time-header">
                        <div class="screen-time-title"> App Limits</div>
                        <button class="btn btn-primary" onclick="openSetAppLimitModal()" style="padding: 6px 12px; font-size: 12px;"> Add Limit</button>
                    </div>
                    <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Set daily time limits for specific apps</p>
                    <div id="app-limits-list">
                        ${renderAppLimits(appLimits, screenTimeUsage.app_usage || {})}
                    </div>
                </div>

                <!-- Category Limits Section -->
                <div class="screen-time-section">
                    <div class="screen-time-header">
                        <div class="screen-time-title"> Category Limits</div>
                        <button class="btn btn-primary" onclick="openSetCategoryLimitModal()" style="padding: 6px 12px; font-size: 12px;"> Add Limit</button>
                    </div>
                    <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Set limits for entire app categories</p>
                    <div class="category-grid" id="category-limits-list">
                        ${renderCategoryLimits(categoryLimits, screenTimeUsage.category_usage || {})}
                    </div>
                </div>

                <!-- Always Allowed Section -->
                <div class="screen-time-section">
                    <div class="screen-time-header">
                        <div class="screen-time-title"> Always Allowed</div>
                        <button class="btn btn-success" onclick="addAlwaysAllowedApp()" style="padding: 6px 12px; font-size: 12px;"> Add App</button>
                    </div>
                    <p style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">These apps bypass all limits and downtime</p>
                    <div id="always-allowed-list">
                        ${renderAlwaysAllowed(alwaysAllowed)}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="screen-time-section" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));">
                    <div class="screen-time-title" style="margin-bottom: 12px;"> Quick Actions</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="syncScreenTime()"> Sync Limits</button>
                        <button class="btn" onclick="refreshScreenTimeUsage()" style="background: #475569;"> Refresh Usage</button>
                        <button class="btn btn-danger" onclick="clearAllLimits()"> Clear All Limits</button>
                    </div>
                </div>
            `;

            return html;
        }

        function renderAppLimits(appLimits, appUsage) {
            const entries = Object.entries(appLimits);
            if (entries.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: #64748b;">No app limits set. Click "Add Limit" to create one.</div>';
            }

            return entries.map(([pkg, limit]) => {
                const usage = appUsage[pkg.replace(/\\./g, '_')] || {};
                const usedMin = usage.used_minutes || 0;
                const percent = limit > 0 ? Math.min(100, (usedMin / limit) * 100) : 0;
                const barClass = percent >= 100 ? 'danger' : percent >= 80 ? 'warning' : 'safe';
                const appName = pkg.split('.').pop() || pkg;

                return `
                    <div class="limit-item">
                        <div class="limit-item-info">
                            <div class="limit-item-name">${appName}</div>
                            <div class="limit-item-detail">${pkg}</div>
                            <div class="usage-bar">
                                <div class="usage-bar-fill ${barClass}" style="width: ${percent}%"></div>
                            </div>
                            <div style="font-size: 10px; color: #64748b; margin-top: 4px;">${usedMin}/${limit} min used</div>
                        </div>
                        <div class="limit-item-value">${formatMinutes(limit)}</div>
                        <div class="limit-item-actions">
                            <button class="limit-btn limit-btn-edit" onclick="editAppLimit('${pkg}', ${limit})"></button>
                            <button class="limit-btn limit-btn-delete" onclick="removeAppLimit('${pkg}')"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCategoryLimits(categoryLimits, categoryUsage) {
            const entries = Object.entries(categoryLimits);
            if (entries.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: #64748b; grid-column: 1 / -1;">No category limits set. Click "Add Limit" to create one.</div>';
            }

            return entries.map(([category, limit]) => {
                const catInfo = SCREEN_TIME_CATEGORIES[category] || { name: category, emoji: '' };
                const usage = categoryUsage[category] || {};
                const usedMin = usage.used_minutes || 0;
                const percent = limit > 0 ? Math.min(100, (usedMin / limit) * 100) : 0;
                const barClass = percent >= 100 ? 'danger' : percent >= 80 ? 'warning' : 'safe';

                return `
                    <div class="limit-item">
                        <div class="limit-item-info">
                            <div class="limit-item-name">${catInfo.emoji} ${catInfo.name}</div>
                            <div class="usage-bar">
                                <div class="usage-bar-fill ${barClass}" style="width: ${percent}%"></div>
                            </div>
                            <div style="font-size: 10px; color: #64748b; margin-top: 4px;">${usedMin}/${limit} min</div>
                        </div>
                        <div class="limit-item-value">${formatMinutes(limit)}</div>
                        <div class="limit-item-actions">
                            <button class="limit-btn limit-btn-edit" onclick="editCategoryLimit('${category}', ${limit})"></button>
                            <button class="limit-btn limit-btn-delete" onclick="removeCategoryLimit('${category}')"></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAlwaysAllowed(alwaysAllowed) {
            if (!alwaysAllowed || alwaysAllowed.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: #64748b;">No apps set as always allowed.</div>';
            }

            return alwaysAllowed.map(pkg => {
                const appName = pkg.split('.').pop() || pkg;
                return `
                    <div class="limit-item">
                        <div class="limit-item-info">
                            <div class="limit-item-name"> ${appName}</div>
                            <div class="limit-item-detail">${pkg}</div>
                        </div>
                        <button class="limit-btn limit-btn-delete" onclick="removeAlwaysAllowed('${pkg}')"></button>
                    </div>
                `;
            }).join('');
        }

        function formatTime24(hour, minute) {
            return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        }

        function formatMinutes(min) {
            if (min < 60) return `${min}m`;
            if (min % 60 === 0) return `${min / 60}h`;
            return `${Math.floor(min / 60)}h ${min % 60}m`;
        }

        // Screen Time Actions
        function toggleDowntime(enabled) {
            if (!selectedDeviceId) return;
            
            const startTime = document.getElementById('downtime-start').value.split(':');
            const endTime = document.getElementById('downtime-end').value.split(':');
            
            sendCommand('set_downtime', {
                enabled: enabled,
                start_hour: parseInt(startTime[0]),
                start_minute: parseInt(startTime[1]),
                end_hour: parseInt(endTime[0]),
                end_minute: parseInt(endTime[1])
            });
            
            showToast(enabled ? 'Downtime enabled' : 'Downtime disabled');
        }

        function updateDowntimeSchedule() {
            if (!selectedDeviceId) return;
            
            const startTime = document.getElementById('downtime-start').value.split(':');
            const endTime = document.getElementById('downtime-end').value.split(':');
            const device = devicesData[selectedDeviceId];
            const enabled = device?.screen_time_limits?.downtime?.enabled || false;
            
            sendCommand('set_downtime', {
                enabled: enabled,
                start_hour: parseInt(startTime[0]),
                start_minute: parseInt(startTime[1]),
                end_hour: parseInt(endTime[0]),
                end_minute: parseInt(endTime[1])
            });
            
            showToast('Downtime schedule updated');
        }

        function openSetAppLimitModal(pkg = '', minutes = 60) {
            document.getElementById('limit-app-package').value = pkg;
            document.getElementById('limit-app-minutes').value = minutes;
            document.getElementById('app-limit-search').value = '';
            
            // Reset selection display
            if (pkg) {
                document.getElementById('selected-app-display').style.display = 'block';
                document.getElementById('selected-app-package').textContent = pkg;
                document.getElementById('selected-app-name').textContent = pkg.split('.').pop();
                document.getElementById('save-app-limit-btn').disabled = false;
            } else {
                document.getElementById('selected-app-display').style.display = 'none';
                document.getElementById('save-app-limit-btn').disabled = true;
            }
            
            // Populate app list from device
            populateAppLimitList();
            
            openModal('set-app-limit-modal');
        }

        function populateAppLimitList() {
            const container = document.getElementById('app-limit-list');
            
            if (!selectedDeviceId || !devicesData[selectedDeviceId]) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No device selected</div>';
                return;
            }
            
            const device = devicesData[selectedDeviceId];
            const apps = device.apps || {};
            const existingLimits = device.screen_time_limits?.app_limits || {};
            
            // Get all apps and categorize them
            const appList = Object.entries(apps).map(([pkg, app]) => ({
                package: pkg,
                name: app.name || pkg.split('.').pop(),
                hidden: app.hidden || false,
                system: app.system || false,
                hasLimit: existingLimits[pkg] ? existingLimits[pkg] : null
            })).filter(app => !app.system); // Filter out system apps
            
            if (appList.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No apps found. Try syncing apps first.</div>';
                return;
            }
            
            // Sort: apps with limits first, then alphabetically
            appList.sort((a, b) => {
                if (a.hasLimit && !b.hasLimit) return -1;
                if (!a.hasLimit && b.hasLimit) return 1;
                return a.name.localeCompare(b.name);
            });
            
            // Categorize apps
            const categories = categorizeApps(appList);
            
            let html = '';
            
            // Apps with existing limits first
            const appsWithLimits = appList.filter(a => a.hasLimit);
            if (appsWithLimits.length > 0) {
                html += `<div class="app-category-header" style="padding: 8px 12px; background: rgba(99, 102, 241, 0.2); font-weight: 600; font-size: 12px; color: #a5b4fc;"> Apps with Limits (${appsWithLimits.length})</div>`;
                appsWithLimits.forEach(app => {
                    html += createAppListItem(app, true);
                });
            }
            
            // Then by category
            for (const [category, catApps] of Object.entries(categories)) {
                if (catApps.length === 0) continue;
                const catInfo = getAppCategoryInfo(category);
                html += `<div class="app-category-header" style="padding: 8px 12px; background: rgba(51, 65, 85, 0.5); font-weight: 600; font-size: 12px; color: #94a3b8;">${catInfo.emoji} ${catInfo.name} (${catApps.length})</div>`;
                catApps.forEach(app => {
                    if (!app.hasLimit) { // Don't show again if already in limits section
                        html += createAppListItem(app, false);
                    }
                });
            }
            
            container.innerHTML = html;
        }

        function createAppListItem(app, showLimit) {
            const limitBadge = showLimit && app.hasLimit 
                ? `<span style="background: rgba(99, 102, 241, 0.3); color: #a5b4fc; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 8px;">${formatMinutes(app.hasLimit)}</span>`
                : '';
            const hiddenBadge = app.hidden 
                ? `<span style="background: rgba(239, 68, 68, 0.3); color: #fca5a5; padding: 2px 6px; border-radius: 10px; font-size: 9px; margin-left: 4px;">Hidden</span>`
                : '';
            
            return `
                <div class="app-limit-item" 
                     onclick="selectAppForLimit('${app.package}', '${app.name.replace(/'/g, "\\'")}')"
                     data-package="${app.package}"
                     data-name="${app.name.toLowerCase()}"
                     style="padding: 10px 12px; border-bottom: 1px solid rgba(51, 65, 85, 0.3); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.15s;"
                     onmouseover="this.style.background='rgba(99, 102, 241, 0.1)'"
                     onmouseout="this.style.background='transparent'">
                    <span style="font-size: 20px;">${getAppEmoji(app.package)}</span>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; color: #e2e8f0; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            ${app.name}${limitBadge}${hiddenBadge}
                        </div>
                        <div style="font-size: 10px; color: #64748b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.package}</div>
                    </div>
                </div>
            `;
        }

        function selectAppForLimit(pkg, name) {
            document.getElementById('limit-app-package').value = pkg;
            document.getElementById('selected-app-display').style.display = 'block';
            document.getElementById('selected-app-name').textContent = name;
            document.getElementById('selected-app-package').textContent = pkg;
            document.getElementById('selected-app-icon').textContent = getAppEmoji(pkg);
            document.getElementById('save-app-limit-btn').disabled = false;
            
            // Check if app already has a limit
            const device = devicesData[selectedDeviceId];
            const existingLimit = device?.screen_time_limits?.app_limits?.[pkg];
            if (existingLimit) {
                document.getElementById('limit-app-minutes').value = existingLimit;
            }
            
            // Highlight selected item
            document.querySelectorAll('.app-limit-item').forEach(item => {
                item.style.background = item.dataset.package === pkg ? 'rgba(34, 197, 94, 0.15)' : 'transparent';
            });
        }

        function filterAppLimitList() {
            const searchTerm = document.getElementById('app-limit-search').value.toLowerCase();
            document.querySelectorAll('.app-limit-item').forEach(item => {
                const name = item.dataset.name || '';
                const pkg = item.dataset.package || '';
                const matches = name.includes(searchTerm) || pkg.toLowerCase().includes(searchTerm);
                item.style.display = matches ? 'flex' : 'none';
            });
            
            // Also hide empty category headers
            document.querySelectorAll('.app-category-header').forEach(header => {
                let nextEl = header.nextElementSibling;
                let hasVisibleApps = false;
                while (nextEl && !nextEl.classList.contains('app-category-header')) {
                    if (nextEl.style.display !== 'none') {
                        hasVisibleApps = true;
                        break;
                    }
                    nextEl = nextEl.nextElementSibling;
                }
                header.style.display = hasVisibleApps ? 'block' : 'none';
            });
        }

        function setLimitPreset(minutes) {
            document.getElementById('limit-app-minutes').value = minutes;
            // Update button styles
            document.querySelectorAll('.time-preset-btn').forEach(btn => {
                btn.style.background = '#475569';
            });
            event.target.style.background = '#6366f1';
        }

        function categorizeApps(apps) {
            const categories = {
                social: [],
                games: [],
                entertainment: [],
                productivity: [],
                communication: [],
                other: []
            };
            
            const socialKeywords = ['instagram', 'facebook', 'twitter', 'tiktok', 'snapchat', 'reddit', 'pinterest', 'tumblr', 'linkedin', 'whatsapp', 'telegram', 'discord', 'messenger'];
            const gameKeywords = ['game', 'play', 'craft', 'clash', 'candy', 'puzzle', 'arcade', 'rpg', 'roblox', 'minecraft', 'fortnite', 'pubg'];
            const entertainmentKeywords = ['youtube', 'netflix', 'spotify', 'music', 'video', 'movie', 'tv', 'stream', 'twitch', 'disney', 'hulu', 'prime'];
            const productivityKeywords = ['docs', 'sheets', 'office', 'drive', 'notes', 'calendar', 'mail', 'outlook', 'notion', 'evernote', 'task'];
            const communicationKeywords = ['phone', 'dialer', 'contacts', 'sms', 'message', 'call', 'chat', 'email', 'gmail'];
            
            apps.forEach(app => {
                const lower = (app.package + ' ' + app.name).toLowerCase();
                
                if (socialKeywords.some(k => lower.includes(k))) {
                    categories.social.push(app);
                } else if (gameKeywords.some(k => lower.includes(k))) {
                    categories.games.push(app);
                } else if (entertainmentKeywords.some(k => lower.includes(k))) {
                    categories.entertainment.push(app);
                } else if (productivityKeywords.some(k => lower.includes(k))) {
                    categories.productivity.push(app);
                } else if (communicationKeywords.some(k => lower.includes(k))) {
                    categories.communication.push(app);
                } else {
                    categories.other.push(app);
                }
            });
            
            return categories;
        }

        function getAppCategoryInfo(category) {
            const info = {
                social: { name: 'Social Media', emoji: '' },
                games: { name: 'Games', emoji: '' },
                entertainment: { name: 'Entertainment', emoji: '' },
                productivity: { name: 'Productivity', emoji: '' },
                communication: { name: 'Communication', emoji: '' },
                other: { name: 'Other Apps', emoji: '' }
            };
            return info[category] || { name: category, emoji: '' };
        }

        function getAppEmoji(packageName) {
            const pkg = packageName.toLowerCase();
            if (pkg.includes('instagram')) return '';
            if (pkg.includes('facebook')) return '';
            if (pkg.includes('twitter') || pkg.includes('x.com')) return '';
            if (pkg.includes('tiktok') || pkg.includes('musically')) return '';
            if (pkg.includes('snapchat')) return '';
            if (pkg.includes('youtube')) return '';
            if (pkg.includes('netflix')) return '';
            if (pkg.includes('spotify')) return '';
            if (pkg.includes('whatsapp')) return '';
            if (pkg.includes('telegram')) return '';
            if (pkg.includes('discord')) return '';
            if (pkg.includes('messenger')) return '';
            if (pkg.includes('chrome') || pkg.includes('browser')) return '';
            if (pkg.includes('camera')) return '';
            if (pkg.includes('gallery') || pkg.includes('photos')) return '';
            if (pkg.includes('game') || pkg.includes('play')) return '';
            if (pkg.includes('music')) return '';
            if (pkg.includes('mail') || pkg.includes('gmail')) return '';
            if (pkg.includes('phone') || pkg.includes('dialer')) return '';
            if (pkg.includes('message') || pkg.includes('sms')) return '';
            if (pkg.includes('calendar')) return '';
            if (pkg.includes('clock') || pkg.includes('alarm')) return '';
            if (pkg.includes('settings')) return '';
            if (pkg.includes('calculator')) return '';
            if (pkg.includes('maps')) return '';
            if (pkg.includes('reddit')) return '';
            if (pkg.includes('pinterest')) return '';
            if (pkg.includes('linkedin')) return '';
            if (pkg.includes('roblox')) return '';
            if (pkg.includes('minecraft')) return '';
            return '';
        }

        function editAppLimit(pkg, currentMinutes) {
            openSetAppLimitModal(pkg, currentMinutes);
        }

        function saveAppLimit() {
            const pkg = document.getElementById('limit-app-package').value.trim();
            const minutes = parseInt(document.getElementById('limit-app-minutes').value) || 0;
            
            if (!pkg) {
                showToast('Please select an app first', true);
                return;
            }
            
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            sendCommand('set_app_limit', { packageName: pkg, minutes: minutes });
            closeModal('set-app-limit-modal');
            
            const appName = document.getElementById('selected-app-name').textContent || pkg;
            showToast(minutes > 0 ? `${appName}: ${formatMinutes(minutes)} limit set` : `${appName}: limit removed`);
        }

        function removeAppLimit(pkg) {
            if (!confirm(`Remove limit for ${pkg}?`)) return;
            sendCommand('set_app_limit', { packageName: pkg, minutes: 0 });
            showToast('App limit removed');
        }

        function openSetCategoryLimitModal(category = 'SOCIAL', minutes = 120) {
            document.getElementById('limit-category-name').value = category;
            document.getElementById('limit-category-minutes').value = minutes;
            openModal('set-category-limit-modal');
        }

        function editCategoryLimit(category, currentMinutes) {
            openSetCategoryLimitModal(category, currentMinutes);
        }

        function saveCategoryLimit() {
            const category = document.getElementById('limit-category-name').value;
            const minutes = parseInt(document.getElementById('limit-category-minutes').value) || 0;
            
            sendCommand('set_category_limit', { category: category, minutes: minutes });
            closeModal('set-category-limit-modal');
            showToast(minutes > 0 ? `Category limit set: ${formatMinutes(minutes)}` : 'Category limit removed');
        }

        function removeCategoryLimit(category) {
            if (!confirm(`Remove ${SCREEN_TIME_CATEGORIES[category]?.name || category} limit?`)) return;
            sendCommand('set_category_limit', { category: category, minutes: 0 });
            showToast('Category limit removed');
        }

        function addAlwaysAllowedApp() {
            if (!selectedDeviceId) {
                showToast('No device selected', true);
                return;
            }
            
            // Get installed apps from device
            const device = devicesData[selectedDeviceId];
            const installedApps = device?.installed_apps || device?.apps || {};
            const currentAlwaysAllowed = device?.screen_time_limits?.always_allowed || [];
            
            // Build app list
            let appList = [];
            
            // Convert to array format
            if (Array.isArray(installedApps)) {
                appList = installedApps;
            } else {
                appList = Object.entries(installedApps).map(([pkg, info]) => ({
                    packageName: pkg,
                    name: info?.name || info?.label || pkg.split('.').pop(),
                    ...info
                }));
            }
            
            // Sort: always allowed first, then alphabetically
            appList.sort((a, b) => {
                const aAllowed = currentAlwaysAllowed.includes(a.packageName);
                const bAllowed = currentAlwaysAllowed.includes(b.packageName);
                if (aAllowed && !bAllowed) return -1;
                if (!aAllowed && bAllowed) return 1;
                return (a.name || a.packageName).localeCompare(b.name || b.packageName);
            });
            
            // Create modal content
            let modalHtml = `
                <div style="margin-bottom: 16px;">
                    <input type="text" id="always-allowed-search" placeholder=" Search apps..." 
                           style="width: 100%; padding: 10px 14px; background: rgba(51, 65, 85, 0.5); border: 1px solid rgba(71, 85, 105, 0.5); border-radius: 10px; color: white; font-size: 14px;"
                           oninput="filterAlwaysAllowedApps()">
                </div>
                <div style="max-height: 400px; overflow-y: auto;" id="always-allowed-app-list">
            `;
            
            if (appList.length === 0) {
                modalHtml += `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <div style="font-size: 48px; margin-bottom: 12px;"></div>
                        <div>No apps found on device.</div>
                        <div style="font-size: 12px; margin-top: 8px;">Sync the app list first from the Apps tab.</div>
                    </div>
                `;
            } else {
                // Essential apps section
                const essentialApps = [
                    { packageName: 'com.android.phone', name: 'Phone', emoji: '' },
                    { packageName: 'com.android.mms', name: 'Messages', emoji: '' },
                    { packageName: 'com.google.android.apps.messaging', name: 'Messages', emoji: '' },
                    { packageName: 'com.android.contacts', name: 'Contacts', emoji: '' },
                    { packageName: 'com.android.settings', name: 'Settings', emoji: '' },
                    { packageName: 'com.android.dialer', name: 'Phone', emoji: '' }
                ];
                
                modalHtml += `<div style="margin-bottom: 12px; font-size: 12px; color: #94a3b8; font-weight: 600;">ESSENTIAL APPS</div>`;
                
                essentialApps.forEach(app => {
                    const isAllowed = currentAlwaysAllowed.includes(app.packageName);
                    modalHtml += createAlwaysAllowedAppRow(app.packageName, app.name, isAllowed, app.emoji);
                });
                
                modalHtml += `<div style="margin: 16px 0 12px 0; font-size: 12px; color: #94a3b8; font-weight: 600;">ALL APPS (${appList.length})</div>`;
                
                appList.forEach(app => {
                    const isAllowed = currentAlwaysAllowed.includes(app.packageName);
                    const appName = app.name || app.label || app.packageName.split('.').pop();
                    modalHtml += createAlwaysAllowedAppRow(app.packageName, appName, isAllowed);
                });
            }
            
            modalHtml += `</div>
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 12px; color: #94a3b8;">
                        <span id="always-allowed-count">${currentAlwaysAllowed.length}</span> apps always allowed
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="closeModal('generic-modal')" style="background: #475569;">Done</button>
                    </div>
                </div>
            `;
            
            // Show modal
            document.getElementById('generic-modal-title').textContent = ' Always Allowed Apps';
            document.getElementById('generic-modal-content').innerHTML = modalHtml;
            openModal('generic-modal');
        }
        
        function createAlwaysAllowedAppRow(packageName, appName, isAllowed, emoji = '') {
            const escapedPkg = packageName.replace(/'/g, "\\'");
            return `
                <div class="always-allowed-row" data-package="${packageName}" data-name="${appName.toLowerCase()}" 
                     style="display: flex; align-items: center; padding: 12px; background: ${isAllowed ? 'rgba(34, 197, 94, 0.15)' : 'rgba(51, 65, 85, 0.4)'}; border-radius: 10px; margin-bottom: 8px; border: 1px solid ${isAllowed ? 'rgba(34, 197, 94, 0.3)' : 'transparent'}; transition: all 0.2s;">
                    <div style="width: 40px; height: 40px; background: #334155; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px;">
                        ${emoji}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: #f1f5f9; font-size: 14px;">${appName}</div>
                        <div style="font-size: 11px; color: #64748b; font-family: monospace;">${packageName}</div>
                    </div>
                    <button onclick="toggleAlwaysAllowed('${escapedPkg}', ${!isAllowed}, this)" 
                            style="width: 36px; height: 36px; border-radius: 50%; border: none; cursor: pointer; font-size: 18px; transition: all 0.2s; ${isAllowed ? 'background: #22c55e; color: white;' : 'background: #475569; color: #94a3b8;'}">
                        ${isAllowed ? '' : '+'}
                    </button>
                </div>
            `;
        }
        
        function toggleAlwaysAllowed(packageName, add, buttonEl) {
            sendCommand('set_always_allowed', { packageName: packageName, allowed: add });
            
            // Update UI immediately
            const row = buttonEl.closest('.always-allowed-row');
            if (add) {
                row.style.background = 'rgba(34, 197, 94, 0.15)';
                row.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                buttonEl.style.background = '#22c55e';
                buttonEl.style.color = 'white';
                buttonEl.textContent = '';
                buttonEl.onclick = () => toggleAlwaysAllowed(packageName, false, buttonEl);
            } else {
                row.style.background = 'rgba(51, 65, 85, 0.4)';
                row.style.borderColor = 'transparent';
                buttonEl.style.background = '#475569';
                buttonEl.style.color = '#94a3b8';
                buttonEl.textContent = '+';
                buttonEl.onclick = () => toggleAlwaysAllowed(packageName, true, buttonEl);
            }
            
            // Update count
            const countEl = document.getElementById('always-allowed-count');
            if (countEl) {
                let count = parseInt(countEl.textContent) || 0;
                countEl.textContent = add ? count + 1 : Math.max(0, count - 1);
            }
            
            showToast(add ? ` ${packageName.split('.').pop()} always allowed` : `Removed from always allowed`);
        }
        
        function filterAlwaysAllowedApps() {
            const search = document.getElementById('always-allowed-search').value.toLowerCase();
            const rows = document.querySelectorAll('.always-allowed-row');
            
            rows.forEach(row => {
                const name = row.dataset.name || '';
                const pkg = row.dataset.package || '';
                const matches = name.includes(search) || pkg.toLowerCase().includes(search);
                row.style.display = matches ? 'flex' : 'none';
            });
        }

        function removeAlwaysAllowed(pkg) {
            if (!confirm(`Remove ${pkg} from always allowed?`)) return;
            sendCommand('set_always_allowed', { packageName: pkg, allowed: false });
            showToast('App removed from always allowed');
        }

        function syncScreenTime() {
            sendCommand('sync_screen_time');
            showToast('Syncing screen time limits...');
        }

        function refreshScreenTimeUsage() {
            sendCommand('get_screen_time_usage');
            showToast('Refreshing usage data...');
        }

        function clearAllLimits() {
            if (!confirm(' Clear ALL screen time limits?\n\nThis will remove all app limits, category limits, and downtime settings.')) return;
            
            if (!selectedDeviceId) return;
            
            database.ref(`devices/${selectedDeviceId}/screen_time_limits`).remove()
                .then(() => {
                    sendCommand('sync_screen_time');
                    showToast('All screen time limits cleared');
                })
                .catch(err => showToast('Failed to clear limits', true));
        }

        // ==================== TIME REQUESTS ====================

        let timeRequests = [];
        let currentTimeRequestFilter = 'all';
        let currentGrantRequest = null;

        function setupTimeRequestsListener() {
            console.log(' Setting up time requests listener...');
            
            database.ref('time_requests').orderByChild('timestamp').on('value', (snapshot) => {
                timeRequests = [];
                snapshot.forEach((child) => {
                    const request = child.val();
                    request.id = child.key;
                    timeRequests.push(request);
                });
                
                // Sort by timestamp descending
                timeRequests.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Update badge
                updateTimeRequestBadge();
                
                // Refresh modal if open
                if (!document.getElementById('time-requests-modal').classList.contains('hidden')) {
                    renderTimeRequestList();
                }
            });
        }

        function updateTimeRequestBadge() {
            const pendingCount = timeRequests.filter(r => r.status === 'pending' || !r.status).length;
            const badge = document.getElementById('time-request-count');
            
            if (pendingCount > 0) {
                badge.textContent = pendingCount > 99 ? '99+' : pendingCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function openTimeRequests() {
            renderTimeRequestList();
            openModal('time-requests-modal');
        }

        function filterTimeRequests(filter) {
            currentTimeRequestFilter = filter;
            
            document.querySelectorAll('#time-requests-modal .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            renderTimeRequestList();
        }

        function renderTimeRequestList() {
            const container = document.getElementById('time-request-list');
            
            let filtered = timeRequests;
            if (currentTimeRequestFilter === 'pending') {
                filtered = timeRequests.filter(r => r.status === 'pending' || !r.status);
            } else if (currentTimeRequestFilter === 'approved') {
                filtered = timeRequests.filter(r => r.status === 'approved');
            } else if (currentTimeRequestFilter === 'denied') {
                filtered = timeRequests.filter(r => r.status === 'denied');
            }
            
            // Update stats
            const pending = timeRequests.filter(r => r.status === 'pending' || !r.status).length;
            document.getElementById('time-request-stats').textContent = `${pending} pending  ${timeRequests.length} total`;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-requests">
                        <div class="empty-requests-icon"></div>
                        <div>${currentTimeRequestFilter === 'all' ? 'No time requests yet' : 'No ' + currentTimeRequestFilter + ' requests'}</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(request => {
                const status = request.status || 'pending';
                const statusBadge = status === 'approved' ? 'approved' : status === 'denied' ? 'denied' : 'pending';
                const statusText = status === 'approved' ? ' Approved' : status === 'denied' ? ' Denied' : ' Pending';
                const timeAgo = getTimeAgo(request.timestamp);
                const requestedText = request.requestedMinutes === -1 ? 'Rest of day' : `${request.requestedMinutes} minutes`;
                
                return `
                    <div class="time-request-item ${statusBadge}">
                        <div class="time-request-header">
                            <div>
                                <div class="time-request-app"> ${request.appName || 'Unknown App'}</div>
                                <div class="time-request-device"> ${request.deviceName || request.deviceId}</div>
                            </div>
                            <span class="time-request-badge ${statusBadge}">${statusText}</span>
                        </div>
                        <div class="time-request-details">
                            <strong>Requested:</strong> ${requestedText} more<br>
                            <strong>Current:</strong> ${request.currentUsedMinutes || 0}/${request.currentLimitMinutes || 0} min used<br>
                            <strong>Time:</strong> ${timeAgo}
                        </div>
                        ${request.reason ? `<div class="time-request-reason">"${request.reason}"</div>` : ''}
                        ${status === 'pending' ? `
                            <div class="time-request-actions">
                                <button class="btn btn-success" onclick="openGrantTimeModal('${request.id}', '${request.deviceId}', '${request.packageName}', '${request.appName}', ${request.requestedMinutes})"> Approve</button>
                                <button class="btn btn-danger" onclick="denyTimeRequest('${request.id}', '${request.deviceId}', '${request.packageName}')"> Deny</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function openGrantTimeModal(requestId, deviceId, packageName, appName, requestedMinutes) {
            currentGrantRequest = { requestId, deviceId, packageName, appName, requestedMinutes };
            
            document.getElementById('grant-time-app-info').innerHTML = `
                <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(34, 197, 94, 0.3);">
                    <div style="font-weight: 600; color: #22c55e;"> ${appName}</div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${packageName}</div>
                    <div style="font-size: 12px; color: #94a3b8;">Requested: ${requestedMinutes === -1 ? 'Rest of day' : requestedMinutes + ' min'}</div>
                </div>
            `;
            
            document.getElementById('grant-time-minutes').value = requestedMinutes === -1 ? 120 : requestedMinutes;
            openModal('grant-time-modal');
        }

        function setGrantTime(minutes) {
            document.getElementById('grant-time-minutes').value = minutes;
        }

        async function confirmGrantTime() {
            if (!currentGrantRequest) return;
            
            const minutes = parseInt(document.getElementById('grant-time-minutes').value) || 30;
            const { requestId, deviceId, packageName, appName } = currentGrantRequest;
            
            try {
                // Send command to device
                const timestamp = Date.now();
                const createdBy = currentUser?.email || 'dashboard';
                
                const signature = await signCommand({
                    action: 'grant_time_extension',
                    timestamp: timestamp,
                    createdBy: createdBy
                });
                
                const commandRef = database.ref(`devices/${deviceId}/commands`).push();
                const commandData = {
                    action: 'grant_time_extension',
                    packageName: packageName,
                    extraMinutes: minutes,
                    requestId: requestId,
                    status: 'pending',
                    timestamp: timestamp,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: createdBy
                };
                if (signature) commandData.signature = signature;
                
                await commandRef.set(commandData);
                
                // Update request status
                await database.ref(`time_requests/${requestId}`).update({
                    status: 'approved',
                    approvedMinutes: minutes,
                    approvedAt: firebase.database.ServerValue.TIMESTAMP,
                    approvedBy: currentUser?.email
                });
                
                closeModal('grant-time-modal');
                showToast(` Granted ${minutes} minutes for ${appName}`);
                currentGrantRequest = null;
                
            } catch (error) {
                showToast('Failed to grant time: ' + error.message, true);
            }
        }

        async function denyTimeRequest(requestId, deviceId, packageName) {
            if (!confirm('Deny this time request?')) return;
            
            try {
                // Send command to device
                const timestamp = Date.now();
                const createdBy = currentUser?.email || 'dashboard';
                
                const signature = await signCommand({
                    action: 'deny_time_request',
                    timestamp: timestamp,
                    createdBy: createdBy
                });
                
                const commandRef = database.ref(`devices/${deviceId}/commands`).push();
                const commandData = {
                    action: 'deny_time_request',
                    requestId: requestId,
                    packageName: packageName,
                    status: 'pending',
                    timestamp: timestamp,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: createdBy
                };
                if (signature) commandData.signature = signature;
                await commandRef.set(commandData);
                
                // Update request status
                await database.ref(`time_requests/${requestId}`).update({
                    status: 'denied',
                    deniedAt: firebase.database.ServerValue.TIMESTAMP,
                    deniedBy: currentUser?.email
                });
                
                showToast('Time request denied');
                
            } catch (error) {
                showToast('Failed to deny request: ' + error.message, true);
            }
        }

        function getTimeAgo(timestamp) {
            if (!timestamp) return 'Unknown';
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            return Math.floor(seconds / 86400) + ' days ago';
        }

        // ==================== SUPPORT TICKETS ====================

        let supportTickets = [];
        let currentTicketFilter = 'all';
        let currentTicketId = null;

        // Initialize support tickets listener
        function setupSupportTicketsListener() {
            console.log(' Setting up support tickets listener...');
            
            database.ref('support_tickets').orderByChild('timestamp').on('value', (snapshot) => {
                console.log(' Support tickets snapshot received:', snapshot.exists(), 'children:', snapshot.numChildren());
                
                supportTickets = [];
                snapshot.forEach((child) => {
                    const ticket = child.val();
                    ticket.id = child.key;
                    console.log(' Ticket found:', child.key, ticket.type, ticket.title);
                    supportTickets.push(ticket);
                });
                
                console.log(' Total tickets loaded:', supportTickets.length);
                
                // Sort by timestamp descending (newest first)
                supportTickets.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                // Update badge count
                updateSupportBadge();
                
                // If modal is open, refresh the list
                if (!document.getElementById('support-tickets-modal').classList.contains('hidden')) {
                    renderTicketList();
                }
            }, (error) => {
                console.error(' Support tickets listener error:', error);
            });
        }

        function updateSupportBadge() {
            const pendingCount = supportTickets.filter(t => t.status === 'pending' || !t.status).length;
            const badge = document.getElementById('support-ticket-count');
            
            if (pendingCount > 0) {
                badge.textContent = pendingCount > 99 ? '99+' : pendingCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function openSupportTickets() {
            renderTicketList();
            openModal('support-tickets-modal');
        }

        function filterTickets(filter) {
            currentTicketFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            
            renderTicketList();
        }

        function renderTicketList() {
            const container = document.getElementById('ticket-list');
            
            // Filter tickets
            let filtered = supportTickets;
            
            // Handle "cleared" filter specially - show only admin-cleared tickets
            if (currentTicketFilter === 'cleared') {
                filtered = supportTickets.filter(t => t.adminCleared === true);
            } else {
                // For all other filters, exclude admin-cleared tickets
                filtered = supportTickets.filter(t => !t.adminCleared);
                
                // Then apply the specific filter
                if (currentTicketFilter === 'pending') {
                    filtered = filtered.filter(t => t.status === 'pending' || !t.status);
                } else if (currentTicketFilter === 'app_request') {
                    filtered = filtered.filter(t => t.type === 'app_request');
                } else if (currentTicketFilter === 'problem_report') {
                    filtered = filtered.filter(t => t.type === 'problem_report');
                } else if (currentTicketFilter === 'diagnostics') {
                    filtered = filtered.filter(t => t.type === 'diagnostics');
                }
            }
            
            // Update stats (exclude admin-cleared from counts)
            const activeTickets = supportTickets.filter(t => !t.adminCleared);
            const pending = activeTickets.filter(t => t.status === 'pending' || !t.status).length;
            const total = activeTickets.length;
            const cleared = supportTickets.filter(t => t.adminCleared).length;
            document.getElementById('ticket-stats').textContent = `${pending} pending / ${total} active${cleared > 0 ? ` / ${cleared} cleared` : ''}`;
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-tickets">
                        <div class="empty-tickets-icon"></div>
                        <div>No tickets found</div>
                        <div style="font-size: 12px; margin-top: 8px;">Tickets from the Support app will appear here</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(ticket => {
                const date = ticket.timestamp ? new Date(ticket.timestamp).toLocaleString() : 'Unknown';
                const statusClass = (ticket.status || 'pending').replace('_', '-');
                const typeClass = ticket.type || 'other';
                const typeName = {
                    'app_request': ' App Request',
                    'problem_report': ' Problem',
                    'diagnostics': ' Diagnostics'
                }[ticket.type] || ' Other';
                
                // Show restore button for cleared tickets
                const isCleared = ticket.adminCleared === true;
                const restoreBtn = isCleared ? `<button class="btn" onclick="event.stopPropagation(); unclearTicket('${ticket.id}')" style="background:#3b82f6;padding:4px 8px;font-size:11px;margin-left:8px"> Restore</button>` : '';
                
                return `
                    <div class="ticket-item ${(!ticket.status || ticket.status === 'pending') ? 'unread' : ''} ${isCleared ? 'cleared' : ''}" onclick="openTicketDetail('${ticket.id}')" style="${isCleared ? 'opacity:0.6' : ''}">
                        <div class="ticket-header">
                            <div class="ticket-title">
                                <span class="ticket-type-badge ${typeClass}">${typeName}</span>
                                ${ticket.title || 'No Title'}
                                ${restoreBtn}
                            </div>
                            <span class="ticket-status ${statusClass}">${formatTicketStatus(ticket.status)}</span>
                        </div>
                        <div class="ticket-meta">
                            ${date}
                            ${ticket.deviceName ? `<span class="ticket-device"> ${ticket.deviceName}</span>` : ''}
                            ${isCleared ? `<span style="color:#64748b;margin-left:8px"> Cleared</span>` : ''}
                        </div>
                        ${ticket.description ? `<div class="ticket-description">${truncateText(ticket.description, 100)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function formatTicketStatus(status) {
            const statusMap = {
                'pending': ' Pending',
                'in-progress': ' In Progress',
                'resolved': ' Resolved',
                'rejected': ' Rejected'
            };
            return statusMap[status] || ' Pending';
        }

        function truncateText(str, len) {
            if (!str) return '';
            return str.length > len ? str.substring(0, len) + '...' : str;
        }

        function openTicketDetail(ticketId) {
            currentTicketId = ticketId;
            const ticket = supportTickets.find(t => t.id === ticketId);
            if (!ticket) return;
            
            const date = ticket.timestamp ? new Date(ticket.timestamp).toLocaleString() : 'Unknown';
            
            let content = `
                <div class="ticket-detail-section">
                    <div class="ticket-detail-label">Status</div>
                    <div class="ticket-detail-value">
                        <span class="ticket-status ${(ticket.status || 'pending').replace('_', '-')}">${formatTicketStatus(ticket.status)}</span>
                        ${ticket.adminCleared ? '<span style="background:#64748b;color:white;padding:2px 8px;border-radius:4px;margin-left:8px;font-size:11px"> Cleared from your view</span>' : ''}
                    </div>
                </div>
                
                <div class="ticket-detail-section">
                    <div class="ticket-detail-label">Submitted</div>
                    <div class="ticket-detail-value">${date}</div>
                </div>
                
                <div class="ticket-detail-section">
                    <div class="ticket-detail-label">Device</div>
                    <div class="ticket-detail-value">${ticket.deviceName || 'Unknown'} <span style="color: #64748b; font-size: 12px;">(${ticket.deviceId || 'N/A'})</span></div>
                </div>
            `;
            
            // Type-specific content
            if (ticket.type === 'app_request') {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Requested App</div>
                        <div class="ticket-detail-value" style="font-size: 18px; font-weight: 600;">${ticket.appName || 'N/A'}</div>
                    </div>
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Category</div>
                        <div class="ticket-detail-value">${ticket.category || 'N/A'}</div>
                    </div>
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Reason</div>
                        <div class="ticket-detail-value">${ticket.reason || ticket.description || 'No reason provided'}</div>
                    </div>
                `;
            } else if (ticket.type === 'problem_report') {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Problem Type</div>
                        <div class="ticket-detail-value">${formatProblemType(ticket.problemType)}</div>
                    </div>
                    ${ticket.appName ? `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Related App/Website</div>
                        <div class="ticket-detail-value">${ticket.appName}</div>
                    </div>
                    ` : ''}
                `;
                
                // Special handling for website_blocked - show blocked URL info
                if (ticket.problemType === 'website_blocked') {
                    content += `
                        <div class="ticket-detail-section" style="background: #1e3a5f; border-radius: 8px; padding: 12px; margin: 8px 0;">
                            <div class="ticket-detail-label" style="color: #60a5fa;"> Blocked Website Details</div>
                            ${ticket.blockedHostname ? `
                            <div class="ticket-detail-value" style="font-size: 18px; font-weight: 600; color: #fbbf24;">${ticket.blockedHostname}</div>
                            ` : ''}
                            ${ticket.blockedUrl && ticket.blockedUrl !== ticket.blockedHostname ? `
                            <div class="ticket-detail-value" style="font-size: 12px; color: #94a3b8; word-break: break-all;">${ticket.blockedUrl}</div>
                            ` : ''}
                            ${ticket.blockedPackage ? `
                            <div class="ticket-detail-value" style="font-size: 11px; color: #64748b; margin-top: 4px;">Package: ${ticket.blockedPackage}</div>
                            ` : ''}
                        </div>
                    `;
                }
                
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Description</div>
                        <div class="ticket-detail-value">${ticket.description || 'No description'}</div>
                    </div>
                `;
                
                // Show diagnostics if included with problem report
                if (ticket.includedDiagnostics && ticket.diagnostics) {
                    content += `
                        <div class="ticket-detail-section">
                            <div class="ticket-detail-label" style="color: #22c55e;"> Diagnostics Included</div>
                        </div>
                    `;
                    content += renderDiagnosticsSection(ticket.diagnostics);
                } else if (ticket.includedDiagnostics === false) {
                    content += `
                        <div class="ticket-detail-section">
                            <div class="ticket-detail-label" style="color: #94a3b8;">Diagnostics not included</div>
                        </div>
                    `;
                }
            } else if (ticket.type === 'diagnostics') {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">User Note</div>
                        <div class="ticket-detail-value">${ticket.description || 'No description provided'}</div>
                    </div>
                `;
                
                if (ticket.diagnostics) {
                    content += renderDiagnosticsSection(ticket.diagnostics);
                }
            } else {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Description</div>
                        <div class="ticket-detail-value">${ticket.description || 'No description'}</div>
                    </div>
                `;
            }
            
            // Show existing reply if any
            if (ticket.adminReply) {
                content += `
                    <div class="existing-reply">
                        <div class="existing-reply-label"> Your Previous Reply</div>
                        <div class="existing-reply-text">${ticket.adminReply}</div>
                    </div>
                `;
            }
            
            document.getElementById('ticket-detail-title').textContent = ticket.title || 'Ticket Details';
            document.getElementById('ticket-detail-content').innerHTML = content;
            document.getElementById('ticket-reply').value = ticket.adminReply || '';
            
            // Update Clear/Restore button based on ticket state
            const clearBtn = document.getElementById('clear-ticket-btn');
            if (ticket.adminCleared) {
                clearBtn.textContent = ' Restore';
                clearBtn.style.background = '#3b82f6';
                clearBtn.onclick = () => unclearTicket(ticket.id);
            } else {
                clearBtn.textContent = ' Clear';
                clearBtn.style.background = '#64748b';
                clearBtn.onclick = clearTicketFromAdmin;
            }
            
            // Show/hide Approve & Whitelist button for website_blocked tickets
            const approveBtn = document.getElementById('approve-whitelist-btn');
            if (ticket.problemType === 'website_blocked' && ticket.blockedHostname) {
                approveBtn.style.display = 'inline-block';
                approveBtn.textContent = ` Approve & Whitelist "${ticket.blockedHostname}"`;
            } else {
                approveBtn.style.display = 'none';
            }
            
            openModal('ticket-detail-modal');
        }

        // Reusable function to render diagnostics section
        function renderDiagnosticsSection(diag) {
            // Check if this is v3 format (has _1_HEALTH_CHECK)
            if (diag._1_HEALTH_CHECK || diag.health_check) {
                return renderDiagnosticsV3(diag);
            }
            // Fall back to old format
            return renderDiagnosticsLegacy(diag);
        }

        // Toggle diagnostics section expansion
        function toggleDiagSection(el) {
            el.closest('.diag-section').classList.toggle('expanded');
        }

        // Render v3 diagnostics format
        function renderDiagnosticsV3(diag) {
            let content = '';
            
            // Get health check (handle both key formats)
            const health = diag._1_HEALTH_CHECK || diag.health_check;
            if (health) {
                const statusClass = health.status === 'OK' ? 'ok' : health.status === 'WARNING' ? 'warning' : 'critical';
                content += `
                    <div class="diag-health-box diag-health-${statusClass}">
                        <div class="diag-health-title">
                            ${health.status === 'OK' ? '' : health.status === 'WARNING' ? '' : ''} 
                            Health Status: ${health.status}
                            ${health.critical_count ? `(${health.critical_count} critical, ${health.warning_count} warnings)` : ''}
                        </div>
                        ${(health.critical_issues || []).map(i => `<div class="diag-issue">${i}</div>`).join('')}
                        ${(health.warnings || []).map(i => `<div class="diag-issue">${i}</div>`).join('')}
                        ${(health.info || []).map(i => `<div class="diag-issue" style="color:#94a3b8">${i}</div>`).join('')}
                    </div>
                `;
            }
            
            // Quick Info Grid
            const device = diag._8_DEVICE || diag.device || {};
            const filterApp = diag.filter_app || {};
            const services = diag._6_SERVICES || diag.services || {};
            const power = diag._10_POWER || diag.power || {};
            
            content += `
                <div class="diagnostics-grid" style="margin-bottom:12px">
                    <div class="diagnostics-item">
                        <div class="diagnostics-item-label">Device</div>
                        <div class="diagnostics-item-value">${device.manufacturer || ''} ${device.model || ''}</div>
                    </div>
                    <div class="diagnostics-item">
                        <div class="diagnostics-item-label">Android</div>
                        <div class="diagnostics-item-value">${device.android_version || device.android || '?'} (API ${device.api_level || device.api || '?'})</div>
                    </div>
                    <div class="diagnostics-item">
                        <div class="diagnostics-item-label">Filter Version</div>
                        <div class="diagnostics-item-value">${filterApp.version || '?'}</div>
                    </div>
                    <div class="diagnostics-item">
                        <div class="diagnostics-item-label">Last Heartbeat</div>
                        <div class="diagnostics-item-value">${filterApp.last_heartbeat || 'Never'}</div>
                    </div>
                    <div class="diagnostics-item">
                        <div class="diagnostics-item-label">Battery</div>
                        <div class="diagnostics-item-value">${power.battery_percent || power.percent || '?'}% ${power.is_charging || power.charging ? '' : ''}</div>
                    </div>
                    <div class="diagnostics-item">
                        <div class="diagnostics-item-label">Uptime</div>
                        <div class="diagnostics-item-value">${power.device_uptime || '?'}</div>
                    </div>
                </div>
            `;

            // Filter State Section
            const filterState = diag._2_FILTER_STATE || diag.filter_state;
            if (filterState) {
                const toggles = filterState.all_toggles || {};
                const enabledToggles = Object.entries(toggles).filter(([k,v]) => v === true);
                content += `
                    <div class="diag-section expanded">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> Filter State (${enabledToggles.length} toggles ON)</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            <div class="diag-kv"><span class="diag-kv-key">Temp Disabled</span><span class="diag-kv-value">${filterState.temp_disabled ? ' YES' : 'No'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Whitelist Mode</span><span class="diag-kv-value">${filterState.whitelist_mode_enabled ? 'ON' : 'Off'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Master Web Block</span><span class="diag-kv-value">${filterState.master_web_block ? 'ON' : 'Off'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Blocks Today</span><span class="diag-kv-value">${filterState.blocks_today || 0}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Failed PINs</span><span class="diag-kv-value">${filterState.failed_pin_attempts || 0}</span></div>
                            ${filterState.last_block_url ? `<div class="diag-kv"><span class="diag-kv-key">Last Block</span><span class="diag-kv-value">${filterState.last_block_url}</span></div>` : ''}
                            <div style="margin-top:8px;font-size:11px;color:#64748b">Active Toggles:</div>
                            <div class="diag-toggle-grid">
                                ${enabledToggles.map(([k,v]) => `<div class="diag-toggle on">${k.replace(/^block_/, '').replace(/_/g, ' ')}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // Services Section
            if (services) {
                const svcStatus = services.service_status || services;
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> Services</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            <div class="diag-kv"><span class="diag-kv-key">Accessibility Enabled</span><span class="diag-kv-value">${services.accessibility_enabled ? ' Yes' : ' No'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">FilterAccessibilityService</span><span class="diag-kv-value">${svcStatus.FilterAccessibilityService ? ' Running' : ' Stopped'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">FilterService</span><span class="diag-kv-value">${svcStatus.FilterService ? ' Running' : ' Stopped'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">AppMonitorService</span><span class="diag-kv-value">${svcStatus.AppMonitorService ? ' Running' : ' Stopped'}</span></div>
                            ${(services.running_detail || services.our_running_services || []).map(s => `
                                <div class="diag-kv"><span class="diag-kv-key">${s.name}</span><span class="diag-kv-value">${s.foreground ? 'FG' : 'BG'}  ${s.uptime || s.running_for || '?'}</span></div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // DPM Policies Section
            const dpm = diag._3_DPM_POLICIES || diag.dpm_policies;
            if (dpm) {
                const restrictions = dpm.user_restrictions || {};
                const activeRestrictions = Object.entries(restrictions).filter(([k,v]) => v === true);
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> DPM Policies (${activeRestrictions.length} restrictions)</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            <div class="diag-kv"><span class="diag-kv-key">Device Owner</span><span class="diag-kv-value">${dpm.is_device_owner ? ' Yes' : ' No'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Admin Active</span><span class="diag-kv-value">${dpm.is_admin_active ? ' Yes' : ' No'}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Hidden Apps</span><span class="diag-kv-value">${dpm.hidden_apps_count || 0}</span></div>
                            <div class="diag-kv"><span class="diag-kv-key">Uninstall Blocked</span><span class="diag-kv-value">${dpm.uninstall_blocked_count || 0}</span></div>
                            ${activeRestrictions.length > 0 ? `
                                <div style="margin-top:8px;font-size:11px;color:#64748b">Active Restrictions:</div>
                                <div class="diag-toggle-grid">
                                    ${activeRestrictions.map(([k]) => `<div class="diag-toggle on">${k.replace(/^no_|^disallow_/i, '')}</div>`).join('')}
                                </div>
                            ` : ''}
                            ${(dpm.hidden_apps || []).length > 0 ? `
                                <div style="margin-top:8px;font-size:11px;color:#64748b">Hidden Apps:</div>
                                <div style="font-size:10px;color:#94a3b8;word-break:break-all">${(dpm.hidden_apps || []).join(', ')}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Logcat Section
            const logcat = diag._4_LOGCAT || diag.logcat;
            if (logcat) {
                const filterLogs = logcat.filter_logs || [];
                const crashLogs = logcat.crash_logs || [];
                const errorLogs = logcat.errors || logcat.error_logs || [];
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> Logcat (${filterLogs.length} filter, ${crashLogs.length} crash, ${errorLogs.length} error)</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            ${filterLogs.length > 0 ? `
                                <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">Filter Logs (${filterLogs.length}):</div>
                                <div class="diag-logs">${filterLogs.slice(-100).join('\n')}</div>
                            ` : ''}
                            ${crashLogs.length > 0 ? `
                                <div style="font-size:11px;color:#ef4444;margin:8px 0 4px">Crash Logs (${crashLogs.length}):</div>
                                <div class="diag-logs" style="border:1px solid #ef4444">${crashLogs.join('\n')}</div>
                            ` : ''}
                            ${errorLogs.length > 0 ? `
                                <div style="font-size:11px;color:#f59e0b;margin:8px 0 4px">Error Logs (${errorLogs.length}):</div>
                                <div class="diag-logs">${errorLogs.join('\n')}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Recent Activity Section
            const activity = diag._5_RECENT_ACTIVITY || diag.recent_activity;
            if (activity) {
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> Recent Activity</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            ${(activity.recent_blocked_urls || []).length > 0 ? `
                                <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">Recent Blocked URLs (${activity.recent_blocked_urls.length}):</div>
                                <div class="diag-logs">${(activity.recent_blocked_urls || []).slice(-20).join('\n')}</div>
                            ` : '<div style="color:#64748b;font-size:12px">No recent blocked URLs</div>'}
                            ${(activity.security_events || []).length > 0 ? `
                                <div style="font-size:11px;color:#f59e0b;margin:8px 0 4px">Security Events (${activity.security_events.length}):</div>
                                <div class="diag-logs">${(activity.security_events || []).slice(-20).join('\n')}</div>
                            ` : ''}
                            ${(activity.audit_log || []).length > 0 ? `
                                <div style="font-size:11px;color:#94a3b8;margin:8px 0 4px">Audit Log (${activity.audit_log.length}):</div>
                                <div class="diag-logs">${(activity.audit_log || []).slice(-30).join('\n')}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // All Settings Section
            const allSettings = diag._7_ALL_SETTINGS || diag.all_settings;
            if (allSettings) {
                const prefFiles = Object.keys(allSettings).filter(k => !k.startsWith('_'));
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> All Settings (${prefFiles.length} pref files)</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            ${prefFiles.map(file => {
                                const settings = allSettings[file] || {};
                                const entries = Object.entries(settings);
                                return `
                                    <div style="font-size:11px;color:#60a5fa;margin:8px 0 4px;font-weight:500">${file} (${entries.length} keys)</div>
                                    <div class="diag-logs" style="max-height:150px">${entries.map(([k,v]) => `${k}: ${JSON.stringify(v)}`).join('\n')}</div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // Crashes Section
            const crashes = diag._14_CRASHES || diag.crashes;
            if (crashes && crashes.length > 0) {
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> Crash Files (${crashes.length})</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            ${crashes.map(crash => `
                                <div style="font-size:11px;color:#ef4444;margin-bottom:4px">${crash.filename || crash.file} - ${crash.time}</div>
                                <div class="diag-logs" style="border:1px solid #ef4444">${(crash.content || '').substring(0, 3000)}</div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Installed Apps Section
            const apps = diag._13_APPS || diag.installed_apps;
            if (apps && apps.length > 0) {
                content += `
                    <div class="diag-section">
                        <div class="diag-section-header" onclick="toggleDiagSection(this)">
                            <span> Installed Apps (${apps.length})</span>
                            <span class="arrow"></span>
                        </div>
                        <div class="diag-section-content">
                            <div class="diag-logs">${apps.map(a => `${a.name || a.pkg} (${a.package || a.pkg})`).join('\n')}</div>
                        </div>
                    </div>
                `;
            }

            // Raw JSON Section (for debugging)
            content += `
                <div class="diag-section">
                    <div class="diag-section-header" onclick="toggleDiagSection(this)">
                        <span> Raw JSON Data</span>
                        <span class="arrow"></span>
                    </div>
                    <div class="diag-section-content">
                        <div class="diag-logs" style="max-height:500px">${JSON.stringify(diag, null, 2)}</div>
                    </div>
                </div>
            `;

            return content;
        }

        // Legacy diagnostics renderer (for old format)
        function renderDiagnosticsLegacy(diag) {
            let content = `
                <div class="ticket-detail-section">
                    <div class="ticket-detail-label">Device Diagnostics</div>
                    <div class="diagnostics-grid">
                        ${diag.device ? `
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Device</div>
                            <div class="diagnostics-item-value">${diag.device.manufacturer || ''} ${diag.device.model || ''}</div>
                        </div>
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Android</div>
                            <div class="diagnostics-item-value">${diag.device.android_version || '?'} (API ${diag.device.api_level || '?'})</div>
                        </div>
                        ` : ''}
                        ${diag.filter ? `
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Filter Version</div>
                            <div class="diagnostics-item-value">${diag.filter.version?.version_name || 'Unknown'}</div>
                        </div>
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Device Owner</div>
                            <div class="diagnostics-item-value">${diag.filter.is_device_owner ? ' Yes' : ' No'}</div>
                        </div>
                        ` : ''}
                        ${diag.memory ? `
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Memory</div>
                            <div class="diagnostics-item-value">${diag.memory.available_mb || '?'}MB / ${diag.memory.total_mb || '?'}MB</div>
                        </div>
                        ` : ''}
                        ${diag.storage ? `
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Storage</div>
                            <div class="diagnostics-item-value">${diag.storage.available_gb || '?'}GB free (${diag.storage.used_percent || '?'}% used)</div>
                        </div>
                        ` : ''}
                        ${diag.network ? `
                        <div class="diagnostics-item">
                            <div class="diagnostics-item-label">Network</div>
                            <div class="diagnostics-item-value">${diag.network.connected ? ' Connected' : ' Disconnected'}${diag.network.has_vpn ? ' (VPN)' : ''}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Show logs if available
            if (diag.logs && diag.logs.length > 0) {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Recent Logs (${diag.logs.length} entries)</div>
                        <div class="logs-container">${diag.logs.join('\n')}</div>
                    </div>
                `;
            }
            
            // Show crash logs if available
            if (diag.crashes && diag.crashes.length > 0) {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label"> Crash Logs (${diag.crashes.length})</div>
                        ${diag.crashes.map(crash => `
                            <div class="logs-container" style="margin-bottom: 8px;">
                                <strong>${crash.filename || 'Crash'}</strong><br>
                                ${(crash.content || '').substring(0, 2000)}${(crash.content || '').length > 2000 ? '...' : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Show installed apps count
            if (diag.installed_apps) {
                content += `
                    <div class="ticket-detail-section">
                        <div class="ticket-detail-label">Installed Apps</div>
                        <div class="ticket-detail-value">${diag.installed_apps.length} apps installed</div>
                    </div>
                `;
            }
            
            // Show policies if available
            if (diag.policies) {
                const enabledPolicies = Object.entries(diag.policies).filter(([k, v]) => v === true).map(([k]) => k.replace(/_/g, ' '));
                if (enabledPolicies.length > 0) {
                    content += `
                        <div class="ticket-detail-section">
                            <div class="ticket-detail-label">Active Policies</div>
                            <div class="ticket-detail-value">${enabledPolicies.join(', ')}</div>
                        </div>
                    `;
                }
            }
            
            return content;
        }

        function formatProblemType(type) {
            const types = {
                'website_blocked': ' Website Blocked',
                'app_not_working': ' App Not Working',
                'app_wrongly_blocked': ' App Wrongly Blocked',
                'app_crash': ' App Keeps Crashing',
                'filter_issue': ' Filter Problem',
                'other': ' Other Issue'
            };
            return types[type] || type || 'Unknown';
        }

        function updateTicketStatus(newStatus) {
            if (!currentTicketId) return;
            
            const reply = document.getElementById('ticket-reply').value.trim();
            
            const updates = {
                status: newStatus,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            if (reply) {
                updates.adminReply = reply;
            }
            
            database.ref(`support_tickets/${currentTicketId}`).update(updates)
                .then(() => {
                    showToast(`Ticket ${newStatus === 'resolved' ? 'resolved' : newStatus === 'rejected' ? 'rejected' : 'updated'}!`, false);
                    closeModal('ticket-detail-modal');
                })
                .catch((error) => {
                    showToast('Failed to update ticket: ' + error.message, true);
                });
        }

        /**
         * Clear ticket from admin view only.
         * Sets adminCleared: true so it hides from admin but stays visible to user.
         * User still sees the ticket until they clear it from their side.
         */
        function clearTicketFromAdmin() {
            if (!currentTicketId) return;
            
            const reply = document.getElementById('ticket-reply').value.trim();
            
            const updates = {
                adminCleared: true,
                adminClearedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // If there's a reply, include it
            if (reply) {
                updates.adminReply = reply;
            }
            
            database.ref(`support_tickets/${currentTicketId}`).update(updates)
                .then(() => {
                    showToast('Ticket cleared from your view (still visible to user)', false);
                    closeModal('ticket-detail-modal');
                })
                .catch((error) => {
                    showToast('Failed to clear ticket: ' + error.message, true);
                });
        }

        /**
         * Restore a cleared ticket back to active view
         */
        function unclearTicket(ticketId) {
            database.ref(`support_tickets/${ticketId}`).update({
                adminCleared: false,
                adminClearedAt: null
            })
                .then(() => {
                    showToast('Ticket restored to active view', false);
                    closeModal('ticket-detail-modal');
                })
                .catch((error) => {
                    showToast('Failed to restore ticket: ' + error.message, true);
                });
        }

        /**
         * Approve a website_blocked ticket and add the website to the device's whitelist.
         * This updates both the ticket status AND pushes the website to the device's settings.
         */
        async function approveAndWhitelistWebsite() {
            if (!currentTicketId) {
                showToast('No ticket selected', true);
                return;
            }
            
            const ticket = supportTickets.find(t => t.id === currentTicketId);
            if (!ticket) {
                showToast('Ticket not found', true);
                return;
            }
            
            if (!ticket.blockedHostname) {
                showToast('No hostname found in ticket', true);
                return;
            }
            
            const hostname = ticket.blockedHostname.toLowerCase();
            const deviceId = ticket.deviceId;
            
            if (!deviceId) {
                showToast('No device ID in ticket - cannot whitelist', true);
                return;
            }
            
            try {
                // 1. Get current whitelist for this device
                const settingsSnapshot = await database.ref(`devices/${deviceId}/settings`).once('value');
                const currentSettings = settingsSnapshot.val() || {};
                const currentWhitelist = currentSettings.allowed_websites || [];
                
                // 2. Add the new hostname if not already in list
                const whitelistSet = new Set(currentWhitelist.map(w => w.toLowerCase()));
                if (!whitelistSet.has(hostname)) {
                    whitelistSet.add(hostname);
                }
                const newWhitelist = Array.from(whitelistSet);
                
                // 3. Update the device's whitelist settings
                await database.ref(`devices/${deviceId}/settings`).update({
                    allowed_websites: newWhitelist,
                    whitelist_mode_enabled: true,  // Ensure whitelist mode is on
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: currentUser?.email || 'admin'
                });
                
                // 4. Mark ticket as resolved with auto-reply
                const reply = document.getElementById('ticket-reply').value.trim() || 
                    ` Approved! The website "${hostname}" has been added to your allowed list. It should work within a few minutes.`;
                
                await database.ref(`support_tickets/${currentTicketId}`).update({
                    status: 'resolved',
                    adminReply: reply,
                    resolvedAction: 'whitelisted',
                    whitelistedHostname: hostname,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    resolvedBy: currentUser?.email || 'admin'
                });
                
                showToast(` Website "${hostname}" whitelisted for device!`, false);
                closeModal('ticket-detail-modal');
                
            } catch (error) {
                console.error('Failed to whitelist:', error);
                showToast('Failed to whitelist: ' + error.message, true);
            }
        }

        // =====================================================
        // APK OVERRIDE MANAGEMENT
        // =====================================================

        let currentEditOverrideId = null;
        let overridesCache = [];

        function openOverridePanel() {
            document.getElementById('override-panel').classList.add('open');
            loadOverrides();
        }

        function closeOverridePanel() {
            document.getElementById('override-panel').classList.remove('open');
        }

        function loadOverrides() {
            const listEl = document.getElementById('override-list');
            listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Loading...</div>';
            
            database.ref('apk_overrides').on('value', (snapshot) => {
                overridesCache = [];
                
                if (!snapshot.exists()) {
                    listEl.innerHTML = `
                        <div class="override-empty">
                            <div class="override-empty-icon"></div>
                            <div>No compatibility fixes needed yet</div>
                            <div style="margin-top: 8px; font-size: 12px;">When users report download issues, add fixes here</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                snapshot.forEach((child) => {
                    const override = child.val();
                    override.id = child.key;
                    overridesCache.push(override);
                    html += renderOverrideCard(override);
                });
                
                listEl.innerHTML = html;
            });
        }

        function renderOverrideCard(override) {
            const enabled = override.status?.enabled !== false;
            const installCount = override.status?.installCount || 0;
            const failureCount = override.status?.failureCount || 0;
            
            let statusClass = enabled ? 'enabled' : 'disabled';
            let statusText = enabled ? 'Active' : 'Disabled';
            
            if (override.expiration?.expiresAt) {
                const daysLeft = Math.ceil((override.expiration.expiresAt - Date.now()) / (1000 * 60 * 60 * 24));
                if (daysLeft <= 7 && daysLeft > 0) {
                    statusClass = 'expiring';
                    statusText = `${daysLeft}d left`;
                } else if (daysLeft <= 0) {
                    statusClass = 'disabled';
                    statusText = 'Expired';
                }
            }
            
            let targeting = [];
            if (override.targeting?.minApiLevel || override.targeting?.maxApiLevel) {
                targeting.push(`API ${override.targeting.minApiLevel || '?'}-${override.targeting.maxApiLevel || '?'}`);
            }
            if (override.targeting?.manufacturers?.length) {
                targeting.push(override.targeting.manufacturers.join(', '));
            }
            if (override.targeting?.deviceModels?.length) {
                targeting.push(override.targeting.deviceModels.join(', '));
            }
            
            return `
                <div class="override-card ${enabled ? '' : 'disabled'}">
                    <div class="override-card-header">
                        <div class="override-card-icon"></div>
                        <div class="override-card-info">
                            <div class="override-card-name">${override.appName || override.packageName}</div>
                            <div class="override-card-package">${override.packageName}</div>
                        </div>
                        <span class="override-card-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="override-card-body">
                        <div class="override-card-row">
                            <span class="override-card-label">Version</span>
                            <span class="override-card-value">${override.override?.version || 'Unknown'}</span>
                        </div>
                        <div class="override-card-row">
                            <span class="override-card-label">Target</span>
                            <span class="override-card-value">${targeting.length ? targeting.join('  ') : 'All devices'}</span>
                        </div>
                        <div class="override-card-row">
                            <span class="override-card-label">Installs</span>
                            <span class="override-card-value">${installCount}  / ${failureCount} </span>
                        </div>
                        ${override.metadata?.notes ? `
                        <div class="override-card-row" style="flex-direction: column; align-items: flex-start;">
                            <span class="override-card-label">Notes</span>
                            <span class="override-card-value" style="font-size: 11px; margin-top: 4px;">${override.metadata.notes}</span>
                        </div>
                        ` : ''}
                        <div class="override-card-actions">
                            <button class="override-card-btn edit" onclick="editOverride('${override.id}')"> Edit</button>
                            <button class="override-card-btn toggle" onclick="toggleOverride('${override.id}', ${!enabled})">
                                ${enabled ? ' Disable' : ' Enable'}
                            </button>
                            <button class="override-card-btn logs" onclick="showOverrideLogs('${override.id}')"></button>
                            <button class="override-card-btn delete" onclick="deleteOverride('${override.id}')"></button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openAddOverrideModal() {
            currentEditOverrideId = null;
            document.getElementById('override-modal-title').textContent = ' Add APK Compatibility Fix';
            
            document.getElementById('override-package').value = '';
            document.getElementById('override-appname').value = '';
            document.getElementById('override-minapi').value = '';
            document.getElementById('override-maxapi').value = '';
            document.getElementById('override-models').value = '';
            document.getElementById('override-manufacturers').value = '';
            document.getElementById('override-url').value = '';
            document.getElementById('override-version').value = '';
            document.getElementById('override-format').value = 'APK';
            document.getElementById('override-size').value = '';
            document.getElementById('override-notes').value = '';
            document.getElementById('override-verify-result').innerHTML = '';
            
            openModal('override-modal');
        }

        function editOverride(id) {
            const override = overridesCache.find(o => o.id === id);
            if (!override) return;
            
            currentEditOverrideId = id;
            document.getElementById('override-modal-title').textContent = ' Edit APK Compatibility Fix';
            
            document.getElementById('override-package').value = override.packageName || '';
            document.getElementById('override-appname').value = override.appName || '';
            document.getElementById('override-minapi').value = override.targeting?.minApiLevel || '';
            document.getElementById('override-maxapi').value = override.targeting?.maxApiLevel || '';
            document.getElementById('override-models').value = (override.targeting?.deviceModels || []).join(', ');
            document.getElementById('override-manufacturers').value = (override.targeting?.manufacturers || []).join(', ');
            document.getElementById('override-url').value = override.override?.downloadUrl || '';
            document.getElementById('override-version').value = override.override?.version || '';
            document.getElementById('override-format').value = override.override?.format || 'APK';
            document.getElementById('override-size').value = override.override?.fileSizeBytes || '';
            document.getElementById('override-notes').value = override.metadata?.notes || '';
            document.getElementById('override-verify-result').innerHTML = '';
            
            openModal('override-modal');
        }

        async function verifyOverrideUrl() {
            const url = document.getElementById('override-url').value.trim();
            const resultEl = document.getElementById('override-verify-result');
            const btn = document.getElementById('override-verify-btn');
            
            if (!url) {
                resultEl.innerHTML = '<div class="override-verify-result error">Please enter a URL</div>';
                return;
            }
            
            btn.disabled = true;
            btn.textContent = ' Verifying...';
            resultEl.innerHTML = '';
            
            try {
                const response = await fetch('https://kosher-store-backend.onrender.com/override/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                const data = await response.json();
                
                if (data.success && data.valid) {
                    resultEl.innerHTML = `
                        <div class="override-verify-result success">
                             Valid APK: ${data.contentLengthMB} MB<br>
                            <small>Type: ${data.contentType}</small>
                        </div>
                    `;
                    document.getElementById('override-size').value = data.contentLength;
                } else if (data.success && !data.valid) {
                    resultEl.innerHTML = `
                        <div class="override-verify-result warning">
                             URL accessible but may not be an APK:<br>
                            ${data.warnings.join('<br>')}
                        </div>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <div class="override-verify-result error">
                             ${data.error || 'Could not verify URL'}<br>
                            ${(data.warnings || []).join('<br>')}
                        </div>
                    `;
                }
            } catch (e) {
                resultEl.innerHTML = `<div class="override-verify-result error"> Verification failed: ${e.message}</div>`;
            }
            
            btn.disabled = false;
            btn.textContent = ' Verify URL';
        }

        function saveOverride() {
            const packageName = document.getElementById('override-package').value.trim();
            const appName = document.getElementById('override-appname').value.trim();
            const url = document.getElementById('override-url').value.trim();
            const version = document.getElementById('override-version').value.trim();
            
            if (!packageName || !appName || !url || !version) {
                showToast('Please fill in all required fields', true);
                return;
            }
            
            const minApi = parseInt(document.getElementById('override-minapi').value) || null;
            const maxApi = parseInt(document.getElementById('override-maxapi').value) || null;
            const models = document.getElementById('override-models').value.split(',').map(s => s.trim()).filter(s => s);
            const manufacturers = document.getElementById('override-manufacturers').value.split(',').map(s => s.trim()).filter(s => s);
            const fileSize = parseInt(document.getElementById('override-size').value) || null;
            const notes = document.getElementById('override-notes').value.trim();
            const format = document.getElementById('override-format').value;
            
            const overrideData = {
                packageName,
                appName,
                targeting: {
                    minApiLevel: minApi,
                    maxApiLevel: maxApi,
                    deviceModels: models.length ? models : null,
                    manufacturers: manufacturers.length ? manufacturers : null
                },
                override: {
                    downloadUrl: url,
                    version,
                    format,
                    fileSizeBytes: fileSize
                },
                metadata: {
                    notes: notes || null,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: currentUser?.email || 'admin'
                },
                status: {
                    enabled: true
                }
            };
            
            if (!currentEditOverrideId) {
                overrideData.metadata.createdAt = firebase.database.ServerValue.TIMESTAMP;
                overrideData.metadata.createdBy = currentUser?.email || 'admin';
                overrideData.status.installCount = 0;
                overrideData.status.failureCount = 0;
            }
            
            const ref = currentEditOverrideId 
                ? database.ref(`apk_overrides/${currentEditOverrideId}`)
                : database.ref('apk_overrides').push();
            
            ref.update(overrideData)
                .then(() => {
                    showToast(currentEditOverrideId ? 'Override updated!' : 'Override created!', false);
                    closeModal('override-modal');
                })
                .catch((error) => {
                    showToast('Failed to save: ' + error.message, true);
                });
        }

        function toggleOverride(id, enable) {
            database.ref(`apk_overrides/${id}/status/enabled`).set(enable)
                .then(() => showToast(enable ? 'Override enabled' : 'Override disabled', false))
                .catch((error) => showToast('Failed: ' + error.message, true));
        }

        function deleteOverride(id) {
            if (!confirm('Delete this compatibility fix?')) return;
            
            database.ref(`apk_overrides/${id}`).remove()
                .then(() => showToast('Override deleted', false))
                .catch((error) => showToast('Failed to delete: ' + error.message, true));
        }

        function showOverrideLogs(id) {
            const logsEl = document.getElementById('override-logs-content');
            logsEl.innerHTML = '<div style="text-align: center; padding: 20px;">Loading logs...</div>';
            openModal('override-logs-modal');
            
            database.ref('apk_override_logs')
                .orderByChild('overrideId')
                .equalTo(id)
                .limitToLast(50)
                .once('value')
                .then((snapshot) => {
                    if (!snapshot.exists()) {
                        logsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">No logs yet</div>';
                        return;
                    }
                    
                    const logs = [];
                    snapshot.forEach((child) => {
                        logs.push({ id: child.key, ...child.val() });
                    });
                    logs.reverse();
                    
                    let html = '';
                    logs.forEach((log) => {
                        const actionClass = log.action.includes('success') ? 'success' : 
                                           log.action.includes('fail') ? 'failed' : 'matched';
                        const time = log.timestamp ? new Date(log.timestamp).toLocaleString() : 'Unknown';
                        
                        html += `
                            <div class="override-log-item">
                                <span class="override-log-action ${actionClass}">${log.action}</span>
                                <span class="override-log-device">${log.deviceModel || 'Unknown device'}</span>
                                ${log.error ? `<div style="color: #ef4444; font-size: 11px; margin-top: 4px;">${log.error}</div>` : ''}
                                <div class="override-log-time">${time}</div>
                            </div>
                        `;
                    });
                    
                    logsEl.innerHTML = html;
                })
                .catch((error) => {
                    logsEl.innerHTML = `<div style="color: #ef4444; padding: 20px;">Error: ${error.message}</div>`;
                });
        }

        // Create override from support ticket (call from ticket detail view)
        function createOverrideFromTicket(ticket) {
            currentEditOverrideId = null;
            document.getElementById('override-modal-title').textContent = ' Add Fix for This Device';
            
            document.getElementById('override-package').value = '';
            document.getElementById('override-appname').value = ticket.appName || '';
            document.getElementById('override-url').value = '';
            document.getElementById('override-version').value = '';
            document.getElementById('override-format').value = 'APK';
            document.getElementById('override-size').value = '';
            document.getElementById('override-verify-result').innerHTML = '';
            
            if (ticket.diagnostics?.device) {
                const device = ticket.diagnostics.device;
                
                if (device.api_level) {
                    document.getElementById('override-minapi').value = device.api_level;
                    document.getElementById('override-maxapi').value = device.api_level;
                }
                
                if (device.manufacturer) {
                    document.getElementById('override-manufacturers').value = device.manufacturer;
                }
                
                if (device.model) {
                    document.getElementById('override-models').value = device.model;
                }
                
                document.getElementById('override-notes').value = 
                    `Fix for ${device.manufacturer || ''} ${device.model || ''} (API ${device.api_level || '?'}) - from support ticket`;
            } else {
                document.getElementById('override-minapi').value = '';
                document.getElementById('override-maxapi').value = '';
                document.getElementById('override-manufacturers').value = '';
                document.getElementById('override-models').value = '';
                document.getElementById('override-notes').value = '';
            }
            
            closeModal('ticket-detail-modal');
            openModal('override-modal');
        }

        // Helper to create override from current ticket in detail view
        function createOverrideFromCurrentTicket() {
            if (!currentTicketId) {
                showToast('No ticket selected', true);
                return;
            }
            const ticket = supportTickets.find(t => t.id === currentTicketId);
            if (!ticket) {
                showToast('Ticket not found', true);
                return;
            }
            createOverrideFromTicket(ticket);
        }

        // =====================================================
        // PARTNERS MANAGEMENT
        // =====================================================
        
        let partners = {};
        
        function openPartnersPanel() {
            const content = document.getElementById('partners-panel-content');
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <p style="color: #94a3b8; font-size: 13px; margin: 0;">
                        Manage partner access. Disable a partner to revoke their dashboard login.
                    </p>
                    <button class="btn btn-success" onclick="openAddPartnerModal()"> Add Partner</button>
                </div>
                <div id="partners-list">Loading...</div>
                
                <div style="margin-top: 20px; padding: 16px; background: #1e293b; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;"> How Partner System Works</div>
                    <ol style="margin: 0; padding-left: 20px; line-height: 1.8; font-size: 13px; color: #94a3b8;">
                        <li>Create user in <a href="https://console.firebase.google.com/project/yeshivafilter-fec0e/authentication/users" target="_blank" style="color: #60a5fa;">Firebase Console  Authentication</a></li>
                        <li>Add them here with their email</li>
                        <li>They log into dashboard with that email/password</li>
                        <li>They see everything except this Partners panel</li>
                        <li>Toggle "Active" off to block their dashboard access</li>
                    </ol>
                </div>
            `;
            loadPartners();
            openModal('partners-panel-modal');
        }
        
        function renderPartnersTab() {
            return `
                <div class="card">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> Partner Licenses</span>
                        <button class="btn btn-success" onclick="openAddPartnerModal()"> Add Partner</button>
                    </div>
                    <div class="card-content">
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
                            Manage partner licenses. Each partner gets a unique APK with their ID baked in.
                            Disable a partner to revoke their license - all their devices will be blocked.
                        </p>
                        <div id="partners-list">Loading...</div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 16px;">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> How to Create Partner APK</span>
                    </div>
                    <div class="card-content" style="font-size: 13px; color: #94a3b8;">
                        <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Add partner here and note their <strong>Partner ID</strong></li>
                            <li>In Android Studio, open <code>LicenseManager.kt</code></li>
                            <li>Change <code>PARTNER_ID = ""</code> to <code>PARTNER_ID = "THEIR_ID"</code></li>
                            <li>Build APK and give to partner</li>
                            <li>To revoke: Toggle "Active" off here</li>
                        </ol>
                    </div>
                </div>
            `;
        }
        
        function loadPartners() {
            database.ref('partners').on('value', (snapshot) => {
                partners = snapshot.val() || {};
                renderPartnersList();
            });
        }
        
        function renderPartnersList() {
            const container = document.getElementById('partners-list');
            if (!container) return;
            
            const partnerList = Object.entries(partners);
            
            if (partnerList.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">No partners yet. Click "Add Partner" to create one.</p>';
                return;
            }
            
            container.innerHTML = partnerList.map(([id, p]) => {
                const isActive = p.active === true;
                const lastSeen = p.last_seen ? new Date(p.last_seen).toLocaleString() : 'Never';
                const expires = p.expires ? new Date(p.expires).toLocaleDateString() : 'Never';
                const isExpired = p.expires && Date.now() > p.expires;
                
                return `
                    <div style="background: #0f172a; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 4px solid ${isActive && !isExpired ? '#22c55e' : '#ef4444'};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 16px; color: #f1f5f9;">${p.name || id}</div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 6px;">
                                    ID: <code style="background: #1e293b; padding: 2px 8px; border-radius: 4px; color: #94a3b8;">${id}</code>
                                </div>
                                <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                    Last seen: ${lastSeen}  Expires: ${expires} ${isExpired ? '<span style="color:#ef4444; font-weight: 600;">(EXPIRED)</span>' : ''}
                                </div>
                                ${p.devices_limit ? `<div style="font-size: 12px; color: #64748b; margin-top: 2px;">Device limit: ${p.devices_limit}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="checkbox" ${isActive ? 'checked' : ''} 
                                    onchange="togglePartner('${id}', this.checked)"
                                    style="width: 20px; height: 20px; cursor: pointer; accent-color: #22c55e;">
                                <button class="btn" onclick="editPartner('${id}')" style="background: #3b82f6; padding: 6px 12px;"></button>
                                <button class="btn" onclick="deletePartner('${id}')" style="background: #ef4444; padding: 6px 12px;"></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function togglePartner(id, active) {
            database.ref(`partners/${id}/active`).set(active)
                .then(() => {
                    showToast(`Partner ${active ? 'activated' : 'REVOKED'}!`, !active);
                })
                .catch(err => showToast('Error: ' + err.message, true));
        }
        
        function openAddPartnerModal() {
            // Close partners panel first
            closeModal('partners-panel-modal');
            
            const html = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <p style="color: #94a3b8; font-size: 13px; margin-bottom: 8px;">
                        First create the user in <a href="https://console.firebase.google.com/project/yeshivafilter-fec0e/authentication/users" target="_blank" style="color: #60a5fa;">Firebase Console  Authentication</a>, 
                        then add them here by their email.
                    </p>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Partner Email (must exist in Firebase Auth)</label>
                        <input type="email" id="new-partner-email" placeholder="partner@email.com" class="text-input">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Partner Name</label>
                        <input type="text" id="new-partner-name" placeholder="Partner Company Name" class="text-input">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Partner ID (for APK tracking)</label>
                        <input type="text" id="new-partner-id" value="PARTNER${Date.now().toString(36).toUpperCase()}" class="text-input" style="font-family: monospace;">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn" onclick="closeModal('generic-modal'); openPartnersPanel();" style="background: #475569; flex: 1;">Cancel</button>
                        <button class="btn btn-success" onclick="saveNewPartner()" style="flex: 1;">Add Partner</button>
                    </div>
                </div>
            `;
            
            document.getElementById('generic-modal-title').textContent = ' Add New Partner';
            document.getElementById('generic-modal-content').innerHTML = html;
            openModal('generic-modal');
        }
        
        async function saveNewPartner() {
            const email = document.getElementById('new-partner-email').value.trim().toLowerCase();
            const name = document.getElementById('new-partner-name').value.trim();
            const partnerId = document.getElementById('new-partner-id').value.trim().toUpperCase().replace(/[^A-Z0-9_]/g, '_');
            
            if (!email || !name) {
                showToast('Email and Name are required', true);
                return;
            }
            
            // Find user by email in the users list or create entry
            // First, let's save the partner info
            const partnerData = {
                name: name,
                email: email,
                partner_id: partnerId,
                role: 'partner',
                active: true,
                created: Date.now(),
                created_by: currentUser?.email || 'owner'
            };
            
            // Save to partners collection (for partner management/APK tracking)
            await database.ref(`partners/${partnerId}`).set({
                name: name,
                email: email,
                active: true,
                created: Date.now()
            });
            
            // We need to find the user's UID by email to save their role
            // For now, save by email (will be linked when they log in)
            const emailKey = email.replace(/[.#$\/\[\]]/g, '_');
            await database.ref(`partner_emails/${emailKey}`).set({
                email: email,
                partner_id: partnerId,
                name: name,
                role: 'partner',
                active: true
            });
            
            showToast('Partner added! They can now log into the dashboard.', false);
            closeModal('generic-modal');
            openPartnersPanel();
        }
        
        function editPartner(id) {
            const p = partners[id];
            if (!p) return;
            
            // Close partners panel first
            closeModal('partners-panel-modal');
            
            const expiresDate = p.expires ? new Date(p.expires).toISOString().split('T')[0] : '';
            
            const html = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Partner ID</label>
                        <input type="text" value="${id}" class="text-input" disabled style="opacity: 0.6;">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Partner Name</label>
                        <input type="text" id="edit-partner-name" value="${p.name || ''}" class="text-input">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Device Limit (0 = unlimited)</label>
                        <input type="number" id="edit-partner-limit" value="${p.devices_limit || 0}" class="text-input">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Expires</label>
                        <input type="date" id="edit-partner-expires" value="${expiresDate}" class="text-input">
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Revoke Message (shown to user when disabled)</label>
                        <input type="text" id="edit-partner-message" value="${p.message || ''}" placeholder="License has been revoked" class="text-input">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn" onclick="closeModal('generic-modal'); openPartnersPanel();" style="background: #475569; flex: 1;">Cancel</button>
                        <button class="btn btn-success" onclick="updatePartner('${id}')" style="flex: 1;">Save Changes</button>
                    </div>
                </div>
            `;
            
            document.getElementById('generic-modal-title').textContent = ' Edit Partner: ' + (p.name || id);
            document.getElementById('generic-modal-content').innerHTML = html;
            openModal('generic-modal');
        }
        
        function updatePartner(id) {
            const name = document.getElementById('edit-partner-name').value.trim();
            const limit = parseInt(document.getElementById('edit-partner-limit').value) || 0;
            const expiresInput = document.getElementById('edit-partner-expires').value;
            const message = document.getElementById('edit-partner-message').value.trim();
            
            const updates = { name: name };
            if (limit > 0) {
                updates.devices_limit = limit;
            } else {
                updates.devices_limit = null;
            }
            if (expiresInput) {
                updates.expires = new Date(expiresInput).getTime();
            } else {
                updates.expires = null;
            }
            updates.message = message || null;
            
            database.ref(`partners/${id}`).update(updates)
                .then(() => {
                    showToast('Partner updated!', false);
                    closeModal('generic-modal');
                    openPartnersPanel();
                })
                .catch(err => showToast('Error: ' + err.message, true));
        }
        
        function deletePartner(id) {
            if (!confirm(`Delete partner "${partners[id]?.name || id}"? This cannot be undone.`)) return;
            
            database.ref(`partners/${id}`).remove()
                .then(() => showToast('Partner deleted', false))
                .catch(err => showToast('Error: ' + err.message, true));
        }

        // =====================================================
        // PIN DATABASE
        // =====================================================
        
        let pinDatabaseUnlocked = false;
        
        function openPinsPanel() {
            const content = document.getElementById('pins-panel-content');
            content.innerHTML = `
                <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
                    View and manage admin PINs for all devices. Re-enter your password to unlock.
                </p>
                <div style="background: #1e3a5f; border: 1px solid #3b82f6; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <div style="color: #60a5fa; font-size: 13px;">
                         <strong>Note:</strong> PINs showing "Not synced" haven't been saved to Firebase yet. 
                        You can set them here and they'll sync to the device, or update the app to auto-sync PINs when set.
                    </div>
                </div>
                <div id="pin-database-container">
                    ${pinDatabaseUnlocked ? '' : renderPinLockScreen()}
                </div>
            `;
            if (pinDatabaseUnlocked) {
                loadPinDatabase();
            }
            openModal('pins-panel-modal');
        }
        
        function renderPinsTab() {
            return `
                <div class="card">
                    <div class="card-header" style="cursor: default;">
                        <span class="card-title"> Device PIN Database</span>
                    </div>
                    <div class="card-content">
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 16px;">
                            View and manage admin PINs for all devices. Re-enter your password to unlock.
                        </p>
                        <div id="pin-database-container">
                            ${pinDatabaseUnlocked ? '' : renderPinLockScreen()}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderPinLockScreen() {
            return `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;"></div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">PIN Database Locked</div>
                    <div style="color: #64748b; margin-bottom: 24px; font-size: 13px;">Enter your password to view device PINs</div>
                    <input type="password" id="pin-unlock-password" placeholder="Your login password" 
                           class="text-input" style="max-width: 300px; margin: 0 auto 16px; display: block;">
                    <button class="btn btn-primary" onclick="unlockPinDatabase()" style="min-width: 200px;">
                         Unlock PIN Database
                    </button>
                    <div id="pin-unlock-error" style="color: #ef4444; margin-top: 12px; font-size: 13px;"></div>
                </div>
            `;
        }
        
        async function unlockPinDatabase() {
            const password = document.getElementById('pin-unlock-password').value;
            const errorEl = document.getElementById('pin-unlock-error');
            
            if (!password) {
                errorEl.textContent = 'Please enter your password';
                return;
            }
            
            try {
                // Re-authenticate with Firebase to verify password
                const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, password);
                await currentUser.reauthenticateWithCredential(credential);
                
                // Password correct - unlock and show PINs
                pinDatabaseUnlocked = true;
                loadPinDatabase();
            } catch (error) {
                errorEl.textContent = 'Incorrect password';
            }
        }
        
        function loadPinDatabase() {
            const container = document.getElementById('pin-database-container');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Loading PINs...</div>';
            
            // Listen to all devices
            database.ref('devices').on('value', (snapshot) => {
                const devices = snapshot.val() || {};
                renderPinDatabase(devices);
            });
        }
        
        function renderPinDatabase(devices) {
            const container = document.getElementById('pin-database-container');
            const deviceList = Object.entries(devices);
            
            if (deviceList.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center;">No devices registered yet.</p>';
                return;
            }
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <span style="color: #22c55e; font-size: 13px;"> Database Unlocked</span>
                    <button class="btn" onclick="lockPinDatabase()" style="background: #64748b; padding: 6px 12px; font-size: 12px;">
                         Lock
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                            <tr style="border-bottom: 2px solid #334155;">
                                <th style="text-align: left; padding: 12px 8px; color: #94a3b8;">Device</th>
                                <th style="text-align: left; padding: 12px 8px; color: #94a3b8;">PIN</th>
                                <th style="text-align: left; padding: 12px 8px; color: #94a3b8;">Set By</th>
                                <th style="text-align: left; padding: 12px 8px; color: #94a3b8;">Set Date</th>
                                <th style="text-align: center; padding: 12px 8px; color: #94a3b8;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            deviceList.forEach(([deviceId, device]) => {
                // Check all possible PIN locations (snake_case and camelCase)
                const settings = device.settings || {};
                
                // Check if PIN is hashed (secure) or plaintext (legacy)
                const isPinHashed = settings.pin_hidden === true || settings.admin_pin_hash;
                const pin = isPinHashed ? null : (device.admin_pin || device.adminPin || 
                           settings.admin_pin || settings.adminPin || 
                           settings.pin || null);
                           
                const hasPin = device.has_pin || isPinHashed || pin != null;
                const setBy = device.pin_set_by || device.pinSetBy || device.installed_by || settings.pin_set_by || '';
                const setDate = device.pin_set_at || device.pinSetAt || settings.pin_set_at ? 
                    new Date(device.pin_set_at || device.pinSetAt || settings.pin_set_at).toLocaleDateString() : '';
                const deviceName = device.info?.name || device.device_name || 'Unnamed Device';
                
                // Show PIN or status message
                let pinDisplay;
                if (isPinHashed) {
                    // Secure - PIN is hashed, cannot be viewed
                    pinDisplay = `<code style="background: #065f46; padding: 4px 8px; border-radius: 4px; font-size: 14px; color: #10b981; font-weight: 600;"></code> <span style="color: #10b981; font-size: 10px;"> Secure</span>`;
                } else if (pin) {
                    // Legacy - plaintext PIN still visible
                    pinDisplay = `<code style="background: #7c2d12; padding: 4px 8px; border-radius: 4px; font-size: 14px; color: #fb923c; font-weight: 600;">${pin}</code> <span style="color: #fb923c; font-size: 10px;"> Plaintext</span>`;
                } else if (hasPin) {
                    pinDisplay = `<span style="color: #f59e0b; font-size: 12px;">PIN exists - change to sync</span>`;
                } else {
                    pinDisplay = `<span style="color: #64748b; font-size: 12px;">No PIN</span>`;
                }
                
                html += `
                    <tr style="border-bottom: 1px solid #1e293b;">
                        <td style="padding: 12px 8px;">
                            <div style="font-weight: 500; color: #f1f5f9;">${deviceName}</div>
                            <div style="font-size: 10px; color: #64748b;">${deviceId.substring(0, 20)}...</div>
                        </td>
                        <td style="padding: 12px 8px;">
                            ${pinDisplay}
                        </td>
                        <td style="padding: 12px 8px; color: #94a3b8;">${setBy}</td>
                        <td style="padding: 12px 8px; color: #94a3b8;">${setDate}</td>
                        <td style="padding: 12px 8px; text-align: center;">
                            <button class="btn" onclick="editDevicePin('${deviceId}', '${isPinHashed ? '' : (pin || '')}')" style="background: #3b82f6; padding: 4px 8px; font-size: 11px;">
                                 ${isPinHashed || pin ? 'Change' : 'Set'}
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function lockPinDatabase() {
            pinDatabaseUnlocked = false;
            const container = document.getElementById('pin-database-container');
            container.innerHTML = renderPinLockScreen();
            // Unsubscribe from devices
            database.ref('devices').off('value');
        }
        
        function editDevicePin(deviceId, currentPin) {
            // Check if PIN is hashed (secure)
            const isPinHashed = currentPin === '' || !currentPin || currentPin === '';
            const helpText = isPinHashed 
                ? 'Current PIN is securely hashed and cannot be viewed'
                : 'Legacy PIN (plaintext) - will be hashed after change';
            
            const html = `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">Device ID</label>
                        <input type="text" value="${deviceId}" class="text-input" disabled style="opacity: 0.6; font-family: monospace; font-size: 11px;">
                    </div>
                    <div style="padding: 8px; background: ${isPinHashed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(251, 146, 60, 0.1)'}; border-radius: 6px; border: 1px solid ${isPinHashed ? 'rgba(16, 185, 129, 0.3)' : 'rgba(251, 146, 60, 0.3)'};">
                        <div style="font-size: 11px; color: ${isPinHashed ? '#10b981' : '#fb923c'};">
                            ${isPinHashed ? '' : ''} ${helpText}
                        </div>
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #94a3b8;">New PIN (exactly 4 digits)</label>
                        <input type="text" id="edit-device-pin" value="" 
                               class="text-input" placeholder="Enter new PIN" maxlength="4" 
                               style="font-size: 20px; letter-spacing: 4px; text-align: center;"
                               pattern="[0-9]{4}">
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="btn" onclick="closeModal('generic-modal')" style="background: #475569; flex: 1;">Cancel</button>
                        <button class="btn btn-success" onclick="saveDevicePin('${deviceId}')" style="flex: 1;"> Change PIN</button>
                    </div>
                </div>
            `;
            
            document.getElementById('generic-modal-title').textContent = ' Edit Device PIN';
            document.getElementById('generic-modal-content').innerHTML = html;
            openModal('generic-modal');
        }
        
        function saveDevicePin(deviceId) {
            const newPin = document.getElementById('edit-device-pin').value.trim();
            
            if (!newPin || !/^\d{4}$/.test(newPin)) {
                showToast('PIN must be exactly 4 digits', true);
                return;
            }
            
            // Send command to device to change PIN (device will hash it)
            const timestamp = Date.now();
            const commandData = {
                action: 'set_admin_pin',
                new_pin: newPin,
                timestamp: timestamp,
                createdBy: currentUser?.email || 'dashboard',
                status: 'pending'
            };
            
            // Sign the command
            signCommand(commandData).then(signature => {
                commandData.signature = signature;
                
                // Send command to device
                return database.ref(`devices/${deviceId}/commands`).push(commandData);
            })
            .then(() => {
                showToast(' PIN change command sent to device', false);
                closeModal('generic-modal');
                
                // Refresh device data after 3 seconds
                setTimeout(() => {
                    if (selectedDeviceId === deviceId) {
                        renderDeviceDetail(deviceId);
                    }
                }, 3000);
            })
            .catch(err => {
                console.error('Failed to send PIN change command:', err);
                showToast('Error: ' + err.message, true);
            });
        }
    </script>
</body>
</html>
